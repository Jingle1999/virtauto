name: Deploy website (Pages) + Health & Auto-Rollback

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      override_url:
        description: "Override healthcheck URL (Chaos test). Leave empty to use CUSTOM_URL."
        required: false
        default: ""
      force_fail:
        description: "Force healthcheck failure (Chaos test)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

env:
  BACKUP_BRANCH: pages-backup
  CUSTOM_URL: https://www.virtauto.de

concurrency:
  group: pages-deploy
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Optional: keep your deploy-start marker (now actually deploys because it's in the build artifact)
      - name: Append news.json (Deploy start)
        run: |
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          tmp=$(mktemp)
          jq -n --arg ts "$ts" --arg ev "Deploy start" --arg ag "CI/CD" --arg su "Deployment pipeline triggered" \
            '[{"ts":$ts,"event":$ev,"agent":$ag,"summary":$su}]' > "$tmp"
          if [ -f news.json ]; then
            jq -s '.[0] + .[1]' "$tmp" news.json > news.tmp && mv news.tmp news.json
          else
            mv "$tmp" news.json
          fi

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: pages
        uses: actions/deploy-pages@v4

  healthcheck:
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      checked_url: ${{ steps.hc.outputs.checked_url }}
      codes: ${{ steps.hc.outputs.codes }}
      ok: ${{ steps.hc.outputs.ok }}
    steps:
      - name: Healthcheck homepage (deterministic)
        id: hc
        shell: bash
        env:
          OVERRIDE_URL: ${{ github.event.inputs.override_url }}
          FORCE_FAIL: ${{ github.event.inputs.force_fail }}
        run: |
          set -euo pipefail

          URL="${CUSTOM_URL}"
          if [ -n "${OVERRIDE_URL:-}" ]; then
            URL="${OVERRIDE_URL}"
          fi

          if [ "${FORCE_FAIL:-false}" = "true" ]; then
            URL="https://example.invalid/force-fail"
          fi

          echo "Healthcheck URL: $URL"

          codes=""
          ok="false"
          for i in 1 2 3; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            echo "Attempt $i: HTTP code $code"
            codes="${codes}${code}"
            if [ "$i" -lt 3 ]; then codes="${codes},"; fi
            if [ "$code" = "200" ]; then ok="true"; break; fi
            sleep 5
          done

          echo "checked_url=$URL" >> "$GITHUB_OUTPUT"
          echo "codes=$codes" >> "$GITHUB_OUTPUT"
          echo "ok=$ok" >> "$GITHUB_OUTPUT"

          if [ "$ok" != "true" ]; then
            echo "Healthcheck failed."
            exit 1
          fi

  rollback:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: failure()
    steps:
      - name: Checkout backup branch (Source of Resilience)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BACKUP_BRANCH }}
          fetch-depth: 0

      - name: Create failover trace (truth-locked artifact)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ops/reports

          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > ops/reports/failover_trace.json << EOF
          {
            "schema_version": "1.0",
            "generated_at": "$ts",
            "event": "FAILOVER",
            "capability": "deploy",
            "primary_agent": "deploy_agent_v1",
            "secondary_agent": "deploy_agent_v1_backup",
            "reason": "healthcheck_failed",
            "evidence": {
              "checked_url": "${{ needs.healthcheck.outputs.checked_url }}",
              "http_codes": "${{ needs.healthcheck.outputs.codes }}",
              "expected": "200"
            },
            "github": {
              "run_id": "${{ github.run_id }}",
              "run_number": "${{ github.run_number }}",
              "attempt": "${{ github.run_attempt }}",
              "sha": "${{ github.sha }}",
              "ref": "${{ github.ref }}"
            }
          }
          EOF

      - name: Upload backup artifact (for rollback deploy)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

      - name: Deploy backup to GitHub Pages (Rollback)
        uses: actions/deploy-pages@v4

  update-backup:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: success()
    steps:
      - name: Checkout main (post-success snapshot)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update backup branch with current site (deterministic)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Ensure we have the latest
          git fetch origin main --prune

          # Create/update backup branch from current workspace state (main)
          git checkout -B "${BACKUP_BRANCH}"

          git add -A
          git commit -m "backup snapshot from ${GITHUB_SHA}" || echo "No changes to commit"
          git push origin "${BACKUP_BRANCH}" --force
    