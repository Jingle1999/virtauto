name: Deploy website (Pages) + Health & Auto-Rollback

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  pages: write
  id-token: write

env:
  BACKUP_BRANCH: pages-backup
  CUSTOM_URL: https://www.virtauto.de   # <- hier ggf. anpassen

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: pages
        uses: actions/deploy-pages@v4

healthcheck:
  runs-on: ubuntu-latest
  needs: deploy
  steps:
    - name: Check homepage (200 expected, 3 retries)
      shell: bash
      run: |
        URL="${{ env.CUSTOM_URL }}"
        if [ -z "$URL" ]; then URL="${{ steps.pages.outputs.page_url }}"; fi
        echo "Checking URL: $URL"
        for i in {1..3}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
          echo "Attempt $i - HTTP Status: $STATUS"
          if [ "$STATUS" -eq 200 ]; then
            echo "Healthcheck passed"
            exit 0
          fi
          sleep 10
        done
        echo "Healthcheck failed after 3 attempts"
        exit 1


  rollback:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: failure()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Deploy last known good backup
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages
        continue-on-error: false

  update-backup:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: success()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
      - name: Update backup branch
        run: |
          git fetch origin ${{ env.BACKUP_BRANCH }} || true
          git checkout -B ${{ env.BACKUP_BRANCH }}
          git reset --hard origin/main
          git push origin ${{ env.BACKUP_BRANCH }} --force
