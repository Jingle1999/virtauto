name: Deploy website (Pages) + Health & Auto-Rollback

on:
  push:
    branches: [ "main" ]

env:
  BACKUP_BRANCH: pages-backup
  CUSTOM_URL: https://www.virtauto.de   # <- hier ggf. anpassen

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: pages
        uses: actions/deploy-pages@v4

  healthcheck:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Check homepage (200 expected)
        run: |
          URL="${{ env.CUSTOM_URL }}"
          if [ -z "$URL" ]; then URL="${{ steps.pages.outputs.page_url }}"; fi
          echo "Checking URL: $URL"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          echo "HTTP Status: $STATUS"
          if [ "$STATUS" -ne 200 ]; then
            echo "Healthcheck failed"
            exit 1
          fi

  rollback:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: failure()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Deploy last known good backup
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages
        continue-on-error: false

  update-backup:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: success()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
      - name: Update backup branch
        run: |
          git fetch origin ${{ env.BACKUP_BRANCH }} || true
          git checkout -B ${{ env.BACKUP_BRANCH }}
          git reset --hard origin/main
          git push origin ${{ env.BACKUP_BRANCH }} --force
