name: Deploy website (Pages) + Health & Deterministic Failover

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_failover:
        description: "Chaos test: force failover after primary deploy (true/false)"
        required: false
        default: "false"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

env:
  BACKUP_BRANCH: pages-backup
  CUSTOM_URL: https://www.virtauto.de
  TRACE_PATH: ops/reports/deploy_trace.jsonl

  # Guardian/Authority artifacts (Phase 8)
  GOV_OUT: ops/reports/governance_outputs.json
  GUARD_TRACE_PATH: ops/reports/guardian_trace.jsonl
  ACTIVITY_PATH: ops/agent_activity.jsonl

jobs:
  guardian_gate:
    name: Guardian Gate (primary â†’ backup)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure evidence paths exist
        shell: bash
        run: |
          mkdir -p ops/reports
          touch "${GUARD_TRACE_PATH}"
          touch "${ACTIVITY_PATH}"

      - name: Run Guardian Agent (primary)
        id: primary
        continue-on-error: true
        shell: bash
        run: |
          python ops/guardian_agent.py --agent primary

      - name: Run Guardian Agent (backup) deterministic failover
        id: backup
        if: ${{ steps.primary.outcome != 'success' }}
        shell: bash
        run: |
          python ops/guardian_agent.py --agent backup

      - name: Upload governance evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: guardian-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            ops/reports/governance_outputs.json
            ops/reports/guardian_trace.jsonl
            ops/agent_activity.jsonl
          if-no-files-found: error

      - name: Enforce gate result (BLOCK stops pipeline)
        shell: bash
        run: |
          if [ ! -f "${GOV_OUT}" ]; then
            echo "Missing governance output ${GOV_OUT}" >&2
            exit 3
          fi

          verdict=$(python - <<'PY'
import json
p="ops/reports/governance_outputs.json"
with open(p,"r",encoding="utf-8") as f:
    j=json.load(f)
print(j.get("verdict","UNKNOWN"))
PY
)
          echo "Guardian verdict: ${verdict}"
          if [ "${verdict}" != "PASS" ]; then
            echo "Guardian gate BLOCKED. See ${GOV_OUT}" >&2
            exit 2
          fi

  build:
    name: Build (Truth-locked artifact)
    runs-on: ubuntu-latest
    needs: guardian_gate
    outputs:
      trace_id: ${{ steps.trace_meta.outputs.trace_id }}
      ts_start: ${{ steps.trace_meta.outputs.ts_start }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Ensure trace folder exists
        run: |
          mkdir -p "$(dirname "${TRACE_PATH}")"
          touch "${TRACE_PATH}"

      - name: Create trace meta
        id: trace_meta
        shell: bash
        run: |
          ts_start="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          trace_id="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "ts_start=$ts_start" >> "$GITHUB_OUTPUT"
          echo "trace_id=$trace_id" >> "$GITHUB_OUTPUT"

      - name: Append deploy trace (start)
        shell: bash
        run: |
          echo "{\"ts\":\"${{ steps.trace_meta.outputs.ts_start }}\",\"capability\":\"deploy\",\"event\":\"deploy_start\",\"run_id\":\"${GITHUB_RUN_ID}\",\"attempt\":\"${GITHUB_RUN_ATTEMPT}\",\"sha\":\"${GITHUB_SHA}\",\"ref\":\"${GITHUB_REF_NAME}\",\"primary_agent\":\"deploy_agent_v1\",\"secondary_agent\":\"deploy_agent_v1_backup\",\"mode\":\"SUPERVISED\"}" >> "${TRACE_PATH}"

      - name: Ensure news.json exists (optional)
        shell: bash
        run: |
          if [ ! -f news.json ]; then echo "[]" > news.json; fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

      - name: Upload trace as workflow artifact (for audit)
        uses: actions/upload-artifact@v4
        with:
          name: deploy-trace-${{ steps.trace_meta.outputs.trace_id }}
          path: ${{ env.TRACE_PATH }}
          if-no-files-found: error

  deploy:
    name: Deploy (primary)
    runs-on: ubuntu-latest
    needs: build
    outputs:
      deployed_url: ${{ steps.pages.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: pages
        uses: actions/deploy-pages@v4

  healthcheck:
    name: Healthcheck (deterministic)
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      http_code: ${{ steps.check.outputs.http_code }}
      ok: ${{ steps.check.outputs.ok }}
      checked_at: ${{ steps.check.outputs.checked_at }}
    steps:
      - name: Check homepage (3 tries)
        id: check
        shell: bash
        run: |
          URL="${{ env.CUSTOM_URL }}"
          if [ -z "$URL" ]; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "http_code=0" >> "$GITHUB_OUTPUT"
            echo "checked_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "Healthcheck on $URL"
          code="0"
          for i in 1 2 3; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i: HTTP $code"
            if [ "$code" -eq 200 ]; then
              echo "ok=true" >> "$GITHUB_OUTPUT"
              echo "http_code=$code" >> "$GITHUB_OUTPUT"
              echo "checked_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 5
          done

          echo "ok=false" >> "$GITHUB_OUTPUT"
          echo "http_code=$code" >> "$GITHUB_OUTPUT"
          echo "checked_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Chaos test (optional forced failover)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.force_failover == 'true' }}
        run: |
          echo "Forcing failover for chaos test."
          exit 1

  update-backup:
    name: Update backup branch (only if healthy) + publish success trace
    runs-on: ubuntu-latest
    needs: [build, healthcheck]
    if: needs.healthcheck.outputs.ok == 'true'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Append deploy trace (success) to site artifact
        shell: bash
        run: |
          mkdir -p "$(dirname "${TRACE_PATH}")"
          touch "${TRACE_PATH}"
          echo "{\"ts\":\"${{ needs.healthcheck.outputs.checked_at }}\",\"capability\":\"deploy\",\"event\":\"deploy_success\",\"http_code\":${{ needs.healthcheck.outputs.http_code }},\"run_id\":\"${GITHUB_RUN_ID}\",\"attempt\":\"${GITHUB_RUN_ATTEMPT}\",\"sha\":\"${GITHUB_SHA}\",\"primary_agent\":\"deploy_agent_v1\",\"result\":\"PASS\"}" >> "${TRACE_PATH}"

      - name: Re-upload Pages artifact (with success trace)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

      - name: Re-deploy Pages (publish success trace)
        uses: actions/deploy-pages@v4

      - name: Force-update backup branch snapshot (last known good)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git checkout -B "${BACKUP_BRANCH}"
          git add -A
          git commit -m "backup snapshot from ${GITHUB_SHA}" || echo "No changes to commit"
          git push origin "${BACKUP_BRANCH}" --force

  rollback:
    name: Rollback (route to secondary)
    runs-on: ubuntu-latest
    needs: [healthcheck]
    if: needs.healthcheck.outputs.ok != 'true'
    steps:
      - name: Checkout backup branch (secondary agent)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BACKUP_BRANCH }}

      - name: Ensure trace exists and append failover event
        shell: bash
        run: |
          mkdir -p "$(dirname "${TRACE_PATH}")"
          touch "${TRACE_PATH}"
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "{\"ts\":\"$ts\",\"capability\":\"deploy\",\"event\":\"failover_to_secondary\",\"condition\":\"healthcheck_failed\",\"http_code\":${{ needs.healthcheck.outputs.http_code }},\"secondary_agent\":\"deploy_agent_v1_backup\",\"result\":\"ROLLBACK\"}" >> "${TRACE_PATH}"

      - name: Upload Pages artifact (backup)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

      - name: Deploy backup to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Upload rollback trace as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-trace-rollback-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ env.TRACE_PATH }}
          if-no-files-found: error