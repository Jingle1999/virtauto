name: Deploy website (Pages) + Health & Auto-Rollback

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  healthcheck:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait & Check Health (retry up to 10 min)
        run: |
          URL="https://www.virtauto.de"
          echo "Checking $URL ..."
          for i in {1..40}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            if [ "$STATUS" -eq 200 ]; then
              echo "Healthcheck OK with status $STATUS"
              exit 0
            fi
            echo "Attempt $i: Status $STATUS, retrying in 15s..."
            sleep 15
          done
          echo "Healthcheck failed after max retries."
          exit 1

  rollback:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: failure()
    steps:
      - name: Download last successful backup
        uses: actions/download-artifact@v4
        with:
          name: pages-backup-latest
          path: ./backup

      - name: Deploy backup
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./backup

      - name: Redeploy backup
        uses: actions/deploy-pages@v4

  update-backup:
    runs-on: ubuntu-latest
    needs: healthcheck
    if: success()
    steps:
      - name: Create/update latest backup
        uses: actions/upload-artifact@v4
        with:
          name: pages-backup-latest
          path: ./
          retention-days: 7
