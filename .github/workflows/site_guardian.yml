name: Site Guardian

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1-5'

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm i -g @lhci/cli@0.14.x
      - name: Run Lighthouse (public URLs)
        run: |
          lhci autorun \
            --collect.url=https://www.virtauto.de/ \
            --collect.url=https://www.virtauto.de/agents.html \
            --collect.url=https://www.virtauto.de/architecture.html \
            --collect.url=https://www.virtauto.de/solutions.html \
            --collect.url=https://www.virtauto.de/contact.html \
            --upload.target=temporary-public-storage || true
      - name: Save Lighthouse results
        if: always()
        run: |
          mkdir -p artifacts/lhci && cp -r .lighthouseci/* artifacts/lhci/ || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: artifacts/lhci

  links:
    runs-on: ubuntu-latest
    steps:
      - uses: lycheeverse/lychee-action@v1
        with:
          args: >
            --verbose --no-progress
            https://www.virtauto.de/
            https://www.virtauto.de/agents.html
            https://www.virtauto.de/architecture.html
            https://www.virtauto.de/solutions.html
            https://www.virtauto.de/contact.html
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  headers:
    runs-on: ubuntu-latest
    steps:
      - name: Check security headers
        run: |
          set -e
          URLS=(
            https://www.virtauto.de/
            https://www.virtauto.de/architecture.html
          )
          for u in "${URLS[@]}"; do
            echo "---- $u ----"
            curl -sI "$u" | grep -Ei 'content-security-policy|strict-transport-security|x-frame-options|x-content-type-options|referrer-policy|permissions-policy' || true
            echo
          done
          
      - name: Update Guardian Agent status
        if: always()
        run: |
          echo "Updating Guardian Agent status..."
          mkdir -p status
          ts=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          agent="self_guardian"
          status="ok"
          jq --arg agent "$agent" --arg status "$status" --arg ts "$ts" '
            .agents = (.agents // []) |
            map(select(.agent != $agent)) +
            [{"agent":$agent,"status":$status,"timestamp":$ts}]
      '     status/status.json 2>/dev/null > status/status.tmp || echo '{"agents":[]}' > status/status.tmp
          mv status/status.tmp status/status.json
     
