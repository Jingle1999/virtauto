name: Status Monitoring (Truth Regeneration) — Phase 1 (Status Agent)

on:
  workflow_dispatch: {}
  schedule:
    # Heartbeat every 10 minutes
    - cron: "*/10 * * * *"

# IMPORTANT: do NOT cancel in-progress runs.
concurrency:
  group: status-monitoring-phase1
  cancel-in-progress: false

permissions:
  contents: write

env:
  # Evidence / truth artifacts (repo paths)
  GOV_OUT: ops/reports/governance_outputs.json
  GUARD_TRACE: ops/reports/guardian_trace.jsonl
  ACTIVITY_PATH: ops/agent_activity.jsonl

  SYSTEM_STATUS: ops/reports/system_status.json
  DECISION_TRACE_JSON: ops/reports/decision_trace.json
  DECISION_TRACE_JSONL: ops/reports/decision_trace.jsonl

  # Publishing branch for Pages-served /status (keep if you need live status on the site)
  PAGES_BRANCH: status-pages

jobs:
  guardian_gate:
    name: Guardian Gate (PASS/BLOCK) — prerequisite for truth mutation
    runs-on: ubuntu-latest
    outputs:
      verdict: ${{ steps.read_verdict.outputs.verdict }}
      reasons: ${{ steps.read_verdict.outputs.reasons }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure evidence paths exist
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ops/reports
          touch "${GOV_OUT}"
          touch "${GUARD_TRACE}"
          touch "${ACTIVITY_PATH}"

      - name: Run Guardian Agent (primary)
        id: primary
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          python ops/guardian_agent.py --agent primary

      - name: Run Guardian Agent (backup) deterministic failover
        id: backup
        if: ${{ steps.primary.outcome != 'success' }}
        shell: bash
        run: |
          set -euo pipefail
          python ops/guardian_agent.py --agent backup

      - name: Read verdict + reasons
        id: read_verdict
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          from pathlib import Path

          p = Path("ops/reports/governance_outputs.json")
          verdict = "BLOCK"
          reasons = ["missing_governance_outputs.json"]

          if p.exists():
            try:
              j = json.loads(p.read_text(encoding="utf-8"))
              verdict = str(j.get("verdict", "BLOCK")).upper()
              r = j.get("reasons", [])
              if isinstance(r, list):
                reasons = [str(x) for x in r]
              elif r is None:
                reasons = []
              else:
                reasons = [str(r)]
            except Exception as e:
              verdict = "BLOCK"
              reasons = [f"malformed_governance_outputs.json: {e}"]

          print(f"verdict={verdict}")
          print("reasons=" + json.dumps(reasons, ensure_ascii=False))
          PY

      - name: Enforce gate (BLOCK stops pipeline)
        shell: bash
        run: |
          set -euo pipefail
          verdict="${{ steps.read_verdict.outputs.verdict }}"
          reasons='${{ steps.read_verdict.outputs.reasons }}'
          echo "Guardian verdict: ${verdict}"
          echo "Reasons: ${reasons}"
          if [ "${verdict}" != "PASS" ]; then
            echo "Guardian gate BLOCKED." >&2
            exit 2
          fi

      - name: Upload gate evidence (audit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-guardian-gate-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            ops/reports/governance_outputs.json
            ops/reports/guardian_trace.jsonl
            ops/agent_activity.jsonl
          if-no-files-found: warn

  status_agent:
    name: Status Agent (truth regeneration) — runs only on PASS
    runs-on: ubuntu-latest
    needs: guardian_gate
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if present)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt
          fi

      - name: Run Status Agent (heartbeat + evidence)
        shell: bash
        env:
          STATUS_GATE_VERDICT: ${{ needs.guardian_gate.outputs.verdict }}
          STATUS_GATE_REASONS: ${{ needs.guardian_gate.outputs.reasons }}
        run: |
          set -euo pipefail
          echo "Running Status Agent (gate=${STATUS_GATE_VERDICT}) ..."
          python ops/status_agent.py --env production

      # OPTIONAL: mirror evidence into /status/ops (GitHub Pages-served)
      - name: Mirror evidence into /status/ops (Pages-served)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p status/ops status/ops/reports

          # Copy only if present
          [ -f "${ACTIVITY_PATH}" ] && cp -f "${ACTIVITY_PATH}" status/ops/agent_activity.jsonl || true
          [ -f "${SYSTEM_STATUS}" ] && cp -f "${SYSTEM_STATUS}" status/ops/reports/system_status.json || true
          [ -f "${DECISION_TRACE_JSON}" ] && cp -f "${DECISION_TRACE_JSON}" status/ops/reports/decision_trace.json || true
          [ -f "${DECISION_TRACE_JSONL}" ] && cp -f "${DECISION_TRACE_JSONL}" status/ops/reports/decision_trace.jsonl || true

      - name: Upload status evidence as GitHub artifact (audit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            ops/reports/system_status.json
            ops/reports/decision_trace.json
            ops/reports/decision_trace.jsonl
            ops/agent_activity.jsonl
            ops/reports/governance_outputs.json
            ops/reports/guardian_trace.jsonl
            status/ops/reports/system_status.json
            status/ops/reports/decision_trace.json
            status/ops/reports/decision_trace.jsonl
            status/ops/agent_activity.jsonl
          if-no-files-found: warn

  publish_status_pages:
    name: Publish status snapshot to status-pages branch (optional)
    runs-on: ubuntu-latest
    needs: [guardian_gate, status_agent]
    steps:
      - name: Checkout main snapshot
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Switch to Pages branch
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${PAGES_BRANCH}" || true
          git checkout -B "${PAGES_BRANCH}" "origin/${PAGES_BRANCH}" || git checkout -B "${PAGES_BRANCH}"

      - name: Restore mirrored /status content from main snapshot
        shell: bash
        run: |
          set -euo pipefail
          # Bring /status folder from the main branch working tree into this branch.
          git fetch origin main
          git checkout origin/main -- status/ || true

      - name: Commit & push (only if changed)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "status-agent"
          git config user.email "status-agent@virtauto.local"
          git add status/ || true

          if git diff --cached --quiet; then
            echo "No status changes to publish."
            exit 0
          fi

          git commit -m "chore(status): publish status snapshot [skip ci]"
          git push origin "${PAGES_BRANCH}" --force
