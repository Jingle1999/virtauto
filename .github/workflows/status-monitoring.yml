name: Status Monitoring (Truth Regeneration) â€” Phase 1 (Status Agent)

on:
  workflow_dispatch:
  schedule:
    # Heartbeat every 10 minutes
    - cron: "*/10 * * * *"

# IMPORTANT: Do NOT cancel in-progress runs.
concurrency:
  group: status-monitoring-phase1
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  status-agent-heartbeat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if present)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt
          fi

      - name: Run Status Agent (heartbeat + evidence)
        shell: bash
        run: |
          set -euo pipefail
          echo "Running Status Agent heartbeat..."
          python ops/status_agent.py --env production

      - name: Read verdict (PASS/BLOCK)
        id: verdict
        shell: bash
        run: |
          set -euo pipefail
          python - << 'PY' > verdict.txt
          import json
          from pathlib import Path
          p = Path("ops/reports/system_status.json")
          if not p.exists():
              print("BLOCK")
              raise SystemExit(0)
          data = json.loads(p.read_text(encoding="utf-8"))
          v = (data.get("autonomy_score", {}) or {}).get("gate_verdict", "BLOCK")
          print(v)
          PY
          v="$(cat verdict.txt | tr -d '\n\r')"
          echo "gate_verdict=$v" >> "$GITHUB_OUTPUT"
          echo "Gate verdict: $v"

      - name: Upload status evidence (GitHub artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: error
          path: |
            ops/reports/system_status.json
            ops/reports/decision_trace.json
            ops/reports/decision_trace.jsonl
            ops/agent_activity.jsonl

      - name: Enforce gate (BLOCK stops workflow)
        shell: bash
        run: |
          set -euo pipefail
          verdict="${{ steps.verdict.outputs.gate_verdict }}"
          if [ "$verdict" != "PASS" ]; then
            echo "Status Agent gate BLOCKED." >&2
            exit 2
          fi
          echo "Status Agent gate PASSED."
