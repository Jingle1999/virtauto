name: design-gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]
  schedule:
    - cron: "23 4 * * *"   # nightly (UTC)
  workflow_dispatch:
  repository_dispatch:
    types: [self_design]

permissions:
  contents: read
  pull-requests: write

jobs:
  design_checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install validator dependencies
        run: pip install pyyaml

      - name: Install validator dependencies
        run: pip install pyyaml jsonschema

      # (4) NEW: validate registry parses cleanly (and optionally schema)
      - name: Validate registry.yaml parses
        run: |
          python - <<'PY'
          import yaml, sys
          p = "agents/registry.yaml"
          with open(p, "r", encoding="utf-8") as f:
            yaml.safe_load(f)
          print("OK: registry.yaml parses")
          PY

      - name: Validate system status vs registry
        run: python ops/validate_status.py


      - name: Validate system status vs registry
        run: python ops/validate_status.py

      - name: Run Design Gate
        id: gate
        run: |
          python scripts/design_gate.py rules/design_tokens.yaml rules/design_checks.yaml || true

      - name: Sticky PR comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: design-gate
          message: |
            ðŸŽ¨ **Design Gate executed**
            - Tokens & design checks applied (colors, contrast, type & spacing scales).
            - See workflow logs for details.
            - Fix items marked **[DESIGN]**.

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: design-gate-report
          path: |
            design_gate_report.txt
          if-no-files-found: ignore

      
