name: Self Guardian Agent

on:
  workflow_dispatch:
    schedule:
      - cron: "0 */12 * * *"  # alle 12h
  workflow_call: {}

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt

      - name: Check security headers (prod)
  run: |
    python tools/guardian/check_headers.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append

      - name: Check CSP & mixed content
  run: |
    python tools/guardian/check_csp.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append
    python tools/guardian/check_mixed_content.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append

      - name: Robots & Sitemap
  run: |
    python tools/guardian/check_robots_sitemap.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append

      - name: (Optional) Link checker (fast)
  run: |
    python tools/guardian/check_links.py https://www.virtauto.de --limit 200 \
      --out ops/reports/guardian.json --append

      - name: Build summary (Markdown)
  run: |
    python tools/guardian/summarize.py ops/reports/guardian.json \
      --md ops/reports/guardian_summary.md --fail-on any

      - name: Run guardian
        id: guardian
        run: python -m scripts.self_guardian --root .
        continue-on-error: true   # <— WICHTIG

      - name: Ensure fixes dir
        run: mkdir -p ops/fixes
        if: always()              # <— läuft auch wenn Guardian „failed“

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: guardian-report
          path: ops/reports/guardian.json

      - name: Create PR if issues
        if: steps.guardian.outcome == 'failure'   # <— nur bei Findings
        run: |
          python - << 'PY'
          import json, os
          os.makedirs("ops/fixes", exist_ok=True)
          rep=json.load(open("ops/reports/guardian.json"))
          issues=rep.get("count",0)
          open("ops/fixes/guardian_summary.md","w").write(
            f"Found {issues} compliance issues.\n")
          PY

      - name: Create PR
        if: steps.guardian.outcome == 'failure'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(guardian): compliance suggestions"
          title: "chore(guardian): compliance suggestions"
          body: "Automated compliance scan results in `ops/reports/guardian.json`."
          branch: "chore/guardian-${{ github.run_id }}"
          add-paths: |
            ops/reports/guardian.json
            ops/fixes/guardian_summary.md
            logs/telemetry/**

token: ${{ secrets.GITHUB_TOKEN }} im create-pull-request-Step.
