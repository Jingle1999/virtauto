name: Self Guardian Agent

on:
  workflow_dispatch:
    schedule:
      - cron: "0 */12 * * *"  # alle 12h
  workflow_call: {}

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt

      - name: Check security headers (prod)
  run: |
    python tools/guardian/check_headers.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append

      - name: Check CSP & mixed content
  run: |
    python tools/guardian/check_csp.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append
    python tools/guardian/check_mixed_content.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append

      - name: Load external policy definitions
  run: |
      echo "Including policies from policies/guardian_policy.yaml"
      cat policies/guardian_policy.yaml >> ops/guardian.yaml

      - name: Summarize guardian report and decide rollback
        id: decide
        run: |
          python - << 'PY'
          import json,sys,os
          p="ops/reports/guardian.json"
          data=json.load(open(p)) if os.path.exists(p) else {"issues":[]}
          total=len(data.get("issues",[]))
          # Rollback-eligible = rules mit rollback_on:true ODER severity in {high,critical}
          elig=[i for i in data.get("issues",[]) 
                if i.get("rollback_on") or str(i.get("severity","")).lower() in ("high","critical")]
          out={
            "total": total,
            "eligible": len(elig),
            "run_id": os.environ.get("GITHUB_RUN_ID"),
            "sha": os.environ.get("GITHUB_SHA"),
          }
          print("SUMMARY:", json.dumps(out))
          with open("ops/reports/guardian_summary.md","a",encoding="utf-8") as f:
              f.write(f"\n**Guardian Summary**  \nTotal: {total} | Rollback-eligible: {len(elig)} | SHA: {out['sha']}\n")
          # set outputs
          print(f"::set-output name=violations_total::{total}")
          print(f"::set-output name=violations_rb::{len(elig)}")
          PY

      - name: Trigger auto-rollback if needed
        if: steps.decide.outputs.violations_rb && steps.decide.outputs.violations_rb != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PAYLOAD=$(jq -n \
            --arg run_id "${{ github.run_id }}" \
            --arg sha "${{ github.sha }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --argjson violations_rb ${{ steps.decide.outputs.violations_rb }} \
            '{run_id:$run_id, sha:$sha, branch:$branch, url:$url, violations_rb:$violations_rb}')
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{\"event_type\":\"guardian_violation\",\"client_payload\":$PAYLOAD}"

      - name: Append Audit Entry (hash-chained)
      run: |
      python tools/audit_append.py ops/reports/guardian.json ops/audit_chain.yaml

      - name: Self-Validation (Guardian Scoring)
      env:
        GV_WEIGHT_CRITICAL: "5"
        GV_WEIGHT_HIGH:     "3"
        GV_WEIGHT_MEDIUM:   "2"
        GV_WEIGHT_LOW:      "1"
        GV_THRESH_FAIL:     "20"   # ab hier "fail" (block)
        GV_THRESH_ROLLBACK: "35"   # ab hier rollback empfohlen
      run: |
        python tools/self_validation.py ops/reports/guardian.json

    - name: Upload validation artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: guardian-self-validation
        path: |
          ops/reports/guardian_score.json
          ops/reports/self_validation.md
          ops/reports/guardian_score.sha256


      - name: Robots & Sitemap
  run: |
    python tools/guardian/check_robots_sitemap.py https://www.virtauto.de \
      --out ops/reports/guardian.json --append

      - name: (Optional) Link checker (fast)
  run: |
    python tools/guardian/check_links.py https://www.virtauto.de --limit 200 \
      --out ops/reports/guardian.json --append

      - name: Update status snapshot (guardian)
        if: always()
        run: |
          set -e
          mkdir -p status
          ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          agent="self_guardian"
          status_job="${{ job.status }}"
          base="https://www.virtauto.de"

          [ -f status/status.json ] || echo '{}' > status/status.json

          jq --arg agent "$agent" \
             --arg status "$status_job" \
             --arg ts "$ts" \
             --arg base "$base" \
       '
             .base_url    = (.base_url // $base) |
             .last_update = $ts |
             .agents = (
               ( .agents // [] )
               | map(select(.agent != $agent))
               + [{agent:$agent, status:$status, timestamp:$ts}]
             )
             ' status/status.json > status/status.tmp && mv status/status.tmp status/status.json
       '
         .agents = (.agents // []) |
         (.agents |=
           map(if .agent=="self_guardian" then
                 .status=$status | .http={} | .timestamp=$ts
              else . end)
         ) |
         if ([.agents[]?.agent] | index("self_guardian")) then .
         else .agents += [{"agent":"self_guardian","status":$status,"http":{},"timestamp":$ts}]
         end
       '   status/status.json > status/status.tmp && mv status/status.tmp status/status.json

          - name: Commit status snapshot (guardian)
            if: always()
            uses: stefanzweifel/git-auto-commit-action@v5
            with:
              commit_message: "chore(guardian): update status snapshot [skip ci]"
              file_pattern: |
                status/status.json
                status/agent_reports.md

      - name: Build summary (Markdown)
        run: |
        python tools/guardian/summarize.py ops/reports/guardian.json \
        --md ops/reports/guardian_summary.md --fail-on any
        
      - name: Publish Guardian report to /status
        if: always()
        run: |
          mkdir -p status
          # Kurze, lesbare Zusammenfassung als "Latest Agent Report"
          cp ops/reports/guardian_summary.md status/agent_reports.md

      - name: Update status snapshot (guardian)
        if: always()
        run: |
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          outcome="${{ steps.guardian.outcome }}"
          status="ok"
          [ "$outcome" != "success" ] && status="fail"

          mkdir -p status
          [ -f status/status.json ] || echo '{"agents":[]}' > status/status.json

          jq --arg ts "$ts" --arg status "$status" '
            .agents = (.agents // []) |
            (.agents |= (map(
                if .agent == "self_guardian"
                  then .status=$status | .timestamp=$ts
                  else .
                end
              ))) |
            (if ([.agents[].agent] | index("self_guardian")) then . else
              .agents += [{"agent":"self_guardian","status":$status,"timestamp":$ts}]
            end)
        '   status/status.json > status/status.tmp && mv status/status.tmp status/status.json

      - name: Commit dashboard artifacts (guardian)
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(guardian): update dashboard status & latest report [skip ci]"
          file_pattern: |
            status/status.json
            status/agent_reports.md

      - name: Run guardian
        id: guardian
        run: python -m scripts.self_guardian --root .
        continue-on-error: true   # <— WICHTIG

      - name: Ensure fixes dir
        run: mkdir -p ops/fixes
        if: always()              # <— läuft auch wenn Guardian „failed“

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: guardian-report
          path: ops/reports/guardian.json

      - name: Create PR if issues
        if: steps.guardian.outcome == 'failure'   # <— nur bei Findings
        run: |
          python - << 'PY'
          import json, os
          os.makedirs("ops/fixes", exist_ok=True)
          rep=json.load(open("ops/reports/guardian.json"))
          issues=rep.get("count",0)
          open("ops/fixes/guardian_summary.md","w").write(
            f"Found {issues} compliance issues.\n")
          PY

      - name: Create PR
        if: steps.guardian.outcome == 'failure'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(guardian): compliance suggestions"
          title: "chore(guardian): compliance suggestions"
          body: "Automated compliance scan results in `ops/reports/guardian.json`."
          branch: "chore/guardian-${{ github.run_id }}"
          add-paths: |
            ops/reports/guardian.json
            ops/fixes/guardian_summary.md
            logs/telemetry/**
          with:
            commit-message: "chore(guardian): compliance suggestions"
            title: "chore(guardian): compliance suggestions"
            body: "Automated compliance scan results."
            add-paths: |
              ops/reports/guardian.json
              ops/fixes/guardian_summary.md
              logs/telemetry/*
              status/agent_reports.md


token: ${{ secrets.GITHUB_TOKEN }} im create-pull-request-Step.

  - name: Update status.json for Guardian Agent
    if: always()
    run: |
      echo "Updating Guardian Agent status..."
      mkdir -p status
      ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      agent="self_guardian"
      status="ok"
      # Falls status.json noch nicht existiert -> leeres Grundgerüst
      [ -f status/status.json ] || echo '{"agents":[]}' > status/status.json
      # Agentenstatus aktualisieren/ersetzen
      jq --arg agent "$agent" --arg status "$status" --arg ts "$ts" '
        .agents = (.agents // []) |
        ( map(select(.agent != $agent)) + [ {agent:$agent, status:$status, timestamp:$ts} ] )
      ' status/status.json > status/status.tmp
      mv status/status.tmp status/status.json


