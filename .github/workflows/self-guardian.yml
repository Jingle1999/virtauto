name: Self Guardian

on:
  workflow_dispatch:
  schedule:
    # werktags 06:00 UTC
    - cron: '0 6 * * 1-5'

# Damit Commits/PRs vom Workflow geschrieben werden dürfen
permissions:
  contents: write
  pull-requests: write

jobs:
  self_guardian:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps (tolerant)
        run: |
          python -m pip install --upgrade pip
          if [ -f tools/requirements.txt ]; then
            pip install -r tools/requirements.txt || true
          fi

      # --- (Optional) schnelle Header-/Link-Checks als Telemetrie ----------

      - name: Check security headers (light)
        run: |
          set -e
          URLS=(
            https://www.virtauto.de/
            https://www.virtauto.de/architecture.html
          )
          for u in "${URLS[@]}"; do
            echo "----- $u -----"
            curl -sI "$u" | grep -Ei 'content-security-policy|strict-transport-security|x-frame-options|x-content-type-options' || true
          done

      - name: Check links (light)
        run: |
          mkdir -p ops/reports
          if [ -f tools/guardian/check_links.py ]; then
            python tools/guardian/check_links.py https://www.virtauto.de --limit 200 \
              --out ops/reports/guardian.json --append || true
          else
            echo '{"count":0,"issues":[]}' > ops/reports/guardian.json
          fi

      # --- Guardian-Scan -----------------------------------------------------

      - name: Run guardian
        id: guardian
        continue-on-error: true        # <— wichtig
        run: |
          set -euo pipefail
          mkdir -p ops/reports logs/telemetry
          python -u scripts/self_guardian.py --root . --out ops/reports/guardian.json

      - name: Ensure fixes dir
        if: always()
        run: mkdir -p ops/fixes

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: guardian-report
          path: ops/reports/guardian.json

      # --- Report + Dashboard-Summary ---------------------------------------

      - name: Build summary (Markdown)
        if: always()
        run: |
          mkdir -p ops/reports status
          if [ -f tools/guardian/summarize.py ]; then
            python tools/guardian/summarize.py ops/reports/guardian.json \
              --md ops/reports/guardian_summary.md --fail-on any || true
            cp ops/reports/guardian_summary.md status/agent_reports.md
          else
            echo "No summarize.py found – writing minimal summary" > status/agent_reports.md
          fi
          
    # ---- Status-Snapshot aktualisieren  ----
      - name: Update status.json for Guardian Agent
        if: always()                              # <— runs always
        run: |
          echo "Updating Guardian Agent status..."
          mkdir -p status
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          agent="self_guardian"
          status="ok"
          # Wenn Python-Check-Findings erzeugt hat, setze fail (oder 'issue')
          if [ -f ops/reports/guardian.json ] && jq -e '.issues | length > 0' ops/reports/guardian.json > /dev/null; then
            status="fail"
          fi
          [ -s status/status.json ] || echo '{"agents":[]}' > status/status.json
          jq --arg agent "$agent" --arg status "$status" --arg ts "$ts" \
             '.agents |= ( (. // []) | map(select(.agent != $agent)) + [{agent:$agent, status:$status, timestamp:$ts}] )' \
             status/status.json > status/tmp.json && mv status/tmp.json status/status.json

          # Upsert nach Agent-Key
          jq --arg agent "$agent" --arg status "$st" --arg ts "$ts" 
                .agents = (.agents // []) |
                  (map(select(.agent != $agent)) + [ {agent:$agent, status:$status, timestamp:$ts} ])
                ' status/status.json > status/status.tmp

          mv status/status.tmp status/status.json



      - name: Commit dashboard artifacts (guardian)
        if: ${{ always() }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(guardian): update dashboard status & latest report [skip ci]"
          file_pattern: |
            status/status.json
            status/agent_reports.md

      # ---- Bei Findings automatisch PR mit Vorschlägen ----------------------
      - name: Create PR if issues
        if: ${{ steps.guardian.outcome == 'failure' }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(guardian): compliance suggestions"
          title: "chore(guardian): compliance suggestions"
          body: "Automated compliance scan results."
          branch: "chore/guardian-${{ github.run_id }}"
          add-paths: |
            ops/reports/guardian.json
            ops/fixes/**
            logs/telemetry/**
            status/agent_reports.md
