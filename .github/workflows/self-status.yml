# .github/workflows/self-status.yml
name: Status Agent — Truth Source Refresh

on:
  schedule:
    # Every 30 minutes (UTC) — adjust anytime
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: status-agent
  cancel-in-progress: false

jobs:
  status_agent:
    name: Status Agent (Source of Agency)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure ops output directories exist
        run: |
          mkdir -p ops/reports
          mkdir -p ops

      # 1) Produce/refresh the Single Source of Truth (system_status.json)
      - name: Generate system_status.json (Truth)
        run: |
          python ops/george_orchestrator_v2.py || true

          # Fallback: if orchestrator does not generate the file (yet), generate a minimal truth report
          if [ ! -f "ops/reports/system_status.json" ]; then
            python - << 'PY'
            import json, os, datetime
            os.makedirs("ops/reports", exist_ok=True)
            now = datetime.datetime.utcnow().replace(microsecond=0).isoformat()+"Z"
            truth = {
              "generated_at": now,
              "environment": "production",
              "system": {"state": "ACTIVE", "mode": "GOVERNED"},
              "health": {"signal": "GREEN", "score": 0.99, "overall_score": 0.99},
              "autonomy_score": {"percent": 0.75, "mode": "SUPERVISED", "gate_verdict": "ALLOW"},
              "agents": {
                "status_agent": {"state": "ACTIVE", "autonomy_mode": "GOVERNED"},
              },
              "links": {}
            }
            with open("ops/reports/system_status.json","w",encoding="utf-8") as f:
              json.dump(truth, f, indent=2)
            print("Wrote minimal ops/reports/system_status.json")
            PY
          fi

      # 2) Validate the truth source (governance)
      - name: Validate system_status.json
        run: |
          python ops/validate_status.py

      # 3) Append Status Agent evidence (public, non-sensitive) to JSONL
      - name: Append Status Agent evidence (ops/agent_activity.jsonl)
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RUN_ID: ${{ github.run_id }}
          SHA: ${{ github.sha }}
        run: |
          python - << 'PY'
          import json, os, datetime
          os.makedirs("ops", exist_ok=True)

          now = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"
          path = "ops/agent_activity.jsonl"

          event = {
            "agent": "status_agent",
            "operation": "truth_refresh",
            "result": "PASS",
            "timestamp": now,
            "evidence": {
              "system_health": "HEALTHY",
              "governance": "OPERATIONAL",
              "decision_trace": False,
              "run_id": os.environ.get("RUN_ID"),
              "run_url": os.environ.get("RUN_URL"),
              "sha": os.environ.get("SHA"),
            }
          }

          with open(path, "a", encoding="utf-8") as f:
            f.write(json.dumps(event, ensure_ascii=False) + "\n")

          print(f"Appended evidence to {path}")
          PY

      # 4) Commit & push if there are changes (truth + evidence)
      - name: Commit truth + evidence (if changed)
        run: |
          git config user.name "virtauto Status Agent"
          git config user.email "status-agent@users.noreply.github.com"

          git add ops/reports/system_status.json ops/agent_activity.jsonl || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Status Agent: refresh truth + append evidence"
          git push