name: GEORGE Orchestrator

on:
  workflow_dispatch:
  schedule:
    # montags 06:00 UTC (optional)
    - cron: "0 6 * * 1"

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

concurrency:
  group: "george-orchestrator"
  cancel-in-progress: false

jobs:
  orchestrate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir pyyaml
          python -c "import yaml; print('PyYAML OK:', yaml.__version__)"
   
      - name: Run GEORGE orchestrator V2 script
        run: |
          python ops/george_orchestrator_v2.py

      # ----------------------------------------------------------------------
      # 1) CONTENT INGEST
      # ----------------------------------------------------------------------
      - name: Dispatch → content-ingest
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "content-ingest.yml",
              ref: "main"
            });

      - name: Wait for ingest
        run: sleep 25

      # ----------------------------------------------------------------------
      # 2) REVIEW GATE
      # ----------------------------------------------------------------------
      - name: Dispatch → review-gate
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "review-gate.yml",
              ref: "main"
            });

      - name: Wait for review
        run: sleep 25

      # ----------------------------------------------------------------------
      # 3) DESIGN GATE
      # ----------------------------------------------------------------------
      - name: Dispatch → design-gate
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "design-gate.yml",
              ref: "main"
            });

      - name: Wait for design
        run: sleep 25

      # ----------------------------------------------------------------------
      # 4) SITE AUDIT
      # ----------------------------------------------------------------------
      - name: Dispatch → site-audit
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "site-audit.yml",
              ref: "main"
            });

      - name: Wait for audit
        run: sleep 25

      # ----------------------------------------------------------------------
      # 5) DEPLOY (pipeline trigger only; real production deploy remains protected elsewhere)
      # ----------------------------------------------------------------------
      - name: Trigger site-deploy (workflow_dispatch)
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "site-deploy.yml",
              ref: "main"
            });

      # ----------------------------------------------------------------------
      # 6) Update Agent Status (Monitoring / Deploy / Audit)
      # ----------------------------------------------------------------------
      - name: Update Monitoring Agent status
        run: |
          python ops/monitoring_agent.py

      # Deploy-Agent bleibt “simulated” und kann zusätzlich HUMAN_OVERRIDE verlangen (wie in deinem Script)
      - name: Update Deploy Agent status
        env:
          # OPTIONAL: wenn du willst, hier explizit false lassen.
          # HUMAN_OVERRIDE: "true"
          HUMAN_OVERRIDE: "false"
        run: |
          python ops/deploy_agent.py || true

      - name: Update Audit Agent status
        run: |
          python ops/audit_agent.py

      - name: Autonomy score evolution
        run: |
          python ops/autonomy_score_evolution.py || true

      # ----------------------------------------------------------------------
      # 7) Update GEORGE status snapshot
      # ----------------------------------------------------------------------
      - name: Update GEORGE status
        run: |
          set -e
          mkdir -p status ops/reports

          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          agent="george"
          status="ok"

          # Ensure base file exists
          if [ ! -f status/status.json ]; then
            echo '{"agents":[]}' > status/status.json
          fi

          # Append/Upsert entry for george (requires jq)
          jq --arg agent "$agent" --arg status "$status" --arg ts "$ts" '
            .agents = ([.agents[] | select(.agent != $agent)] + [{agent:$agent,status:$status,timestamp:$ts}])
          ' status/status.json > status/status.tmp && mv status/status.tmp status/status.json

          cp status/status.json "ops/reports/george_status_${ts}.json" || true

      # ----------------------------------------------------------------------
      # 8) Reflection (non-blocking)
      # ----------------------------------------------------------------------
      - name: Write reflection from latest decision
        run: |
          python3 ops/reflection_writer.py || echo "No reflection written (non-blocking)"

      # ----------------------------------------------------------------------
      # 9) Commit & Push updates (robust against concurrent runs)
      # ----------------------------------------------------------------------
      - name: Commit status updates
        run: |
          set -e
          git config user.name "GEORGE Orchestrator"
          git config user.email "george@virtauto.ai"

          # Stage only relevant auto-generated artifacts (adjust if needed)
          git add ops/events.jsonl || true
          git add ops/reports/system_status.json || true
          git add ops/reports/george_status_*.json || true
          git add ops/reports/autonomy_score_evolution.jsonl || true
          git add status/status.json || true
          git add status/deploy_agent_report.md || true
          git add ops/decisions/reflections || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "GEORGE: update status summary"

      # ----------------------------------------------------------------------
      # 10) Enforce runtime authority Gate
      # ----------------------------------------------------------------------
      - name: Runtime authority gate (enforce)
        run: |
          python ops/runtime_gate.py \
            ops/decisions/latest.json \
            ops/policies/runtime_gate.yml \
            ops/decisions/gate_result.json

      - name: Debug: list policy + decisions
        run: |
          ls -la ops/policies || true
          ls -la ops/decisions || true
          echo "---- policy file ----"
          sed -n '1,120p' ops/policies/runtime_gate.yml || true

      - name: Print gate decision
        run: cat ops/decisions/gate_result.json
    
      # If you want HARD blocking at workflow level:
      - name: Stop if gate blocks
        run: |
          python - << 'PY'
          import json, sys
          r = json.load(open("ops/decisions/gate_result.json"))
          v = r["verdict"]
          if v == "BLOCK":
              print("Gate verdict BLOCK -> stopping workflow")
              sys.exit(1)
          print("Gate verdict:", v)
          PY

      - name: Push changes (with rebase retry)
        run: |
          set -e
          # If commit step produced no commit, nothing to push.
          if git log -1 --pretty=%B | grep -q "GEORGE: update status summary"; then
            for i in 1 2 3; do
              echo "Push attempt $i..."
              git pull --rebase origin main || true
              if git push origin main; then
                echo "Push succeeded."
                exit 0
              fi
              sleep 3
            done
            echo "Push failed after retries (likely concurrent updates)."
            exit 0
          else
            echo "No new GEORGE commit created. Skipping push."
          fi
