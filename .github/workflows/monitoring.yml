name: Self Monitoring

on:
  workflow_dispatch:
  schedule:
    # alle Werktage 06:00 UTC
    - cron: '0 6 * * 1-5'

permissions:
  contents: write
  pull-requests: write

jobs:
  monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Ping target(s) and write report
        shell: bash
        run: |
          set -e
          mkdir -p ops/reports
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          target="https://www.virtauto.de"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$target" || true)

          status="ok"
          if [ "$code" != "200" ]; then
            status="fail"
          fi

          jq -n --arg ts "$ts" --arg target "$target" --arg code "$code" \
            '{timestamp:$ts, target:$target, http:$code|tonumber}' > ops/reports/monitoring.json

          echo "HTTP $code for $target -> $status"
          echo "status=$status" >> $GITHUB_ENV

      - name: Update status.json (Monitoring Agent)
        if: always()
        shell: bash
        run: |
          set -e
          mkdir -p status
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          agent="monitoring"
          status="${{ env.status || 'fail' }}"

          # Basisdatei anlegen, falls leer/fehlend
          [ -s status/status.json ] || echo '{"agents":[]}' > status/status.json

          # Upsert: alten 'monitoring'-Eintrag raus, neuen rein
          jq --arg agent "$agent" --arg status "$status" --arg ts "$ts" \
            '.agents |= ( (. // []) | map(select(.agent != $agent)) + [{agent:$agent, status:$status, timestamp:$ts}] )' \
            status/status.json > status/status.tmp && mv status/status.tmp status/status.json

      - name: Commit dashboard artifacts (monitoring)
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(monitoring): update dashboard status [skip ci]"
          file_pattern: |
            status/status.json
            ops/reports/monitoring.json
