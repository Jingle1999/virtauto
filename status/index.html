<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>virtauto.OS — Live System Status</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="stylesheet" href="/assets/styles_unify.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex,nofollow" />
</head>

<body>
  <!-- Header injected via JS -->
  <div id="header-slot"></div>

  <!-- FATAL (truth missing/unreadable) -->
  <section id="fatal" class="fatal" style="display:none;">
    <div class="fatal-card">
      <div class="fatal-title">TRUTH-LOCKED</div>
      <div class="fatal-sub">This page refuses to render if the Single Source of Truth is missing.</div>
      <div class="fatal-row"><span class="fatal-k">Truth source:</span> <span class="fatal-v" id="fatal-src">—</span></div>
      <div class="fatal-row"><span class="fatal-k">Error:</span> <span class="fatal-v" id="fatal-err">—</span></div>
      <div class="fatal-note">Fix the truth artifact and redeploy. No client-side simulation is permitted.</div>
    </div>
  </section>

  <!-- PAGE -->
  <main id="page">
    <section class="page-hero">
      <div class="hero-title-row">
        <h1 class="hero-title">virtauto.OS — Live System Status</h1>
        <span class="truth-pill ok">TRUTH-LOCKED</span>
      </div>

      <p class="hero-sub">
        This dashboard is the single authoritative interface for the operational state of www.virtauto.de.
        Every value on this page is rendered from the Single Source of Truth and refuses to show if the truth source is missing.
      </p>

      <div class="hero-chips">
        <span class="chip">Agentic Website — Live in Production</span>
        <span class="chip">Truth Source: <strong id="truth-source">—</strong></span>
        <span class="chip">Freshness: <strong id="freshness">—</strong></span>
      </div>
    </section>

    <section class="grid-2">
      <!-- LEFT: Core agents -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">CORE AGENTS &amp; LAYERS</div>
          <span id="system-pill" class="pill ok">SYSTEM</span>
        </div>

        <div id="agents-grid" class="cards-grid">
          <!-- Rendered from truth -->
        </div>
      </section>

      <!-- RIGHT: KPIs + Governance -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">SYSTEM KPIs</div>
          <span class="pill warn">LIVE SNAPSHOT</span>
        </div>

        <div class="kpi-grid">
          <div class="kpi">
            <div class="kpi-label">AGENT HEALTH</div>
            <div class="kpi-value" id="kpi-agent-health">—</div>
            <div class="kpi-note" id="kpi-agent-health-note">Active agents / total agents</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">AUTONOMY (CONFIRMED)</div>
            <div class="kpi-value" id="kpi-autonomy">—</div>
            <div class="kpi-note" id="kpi-autonomy-note">Mode: —</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">HEALTH SCORE</div>
            <div class="kpi-value" id="kpi-health">—</div>
            <div class="kpi-note" id="kpi-health-note">Signal: —</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">GOVERNANCE</div>
            <div class="kpi-value" id="kpi-governance">—</div>
            <div class="kpi-note" id="kpi-governance-note">Audit trail &amp; gate verdict</div>
          </div>
        </div>

        <div class="truth-box">
          <div class="truth-row"><span class="truth-k">Truth lock:</span> This page reads from <strong id="truth-path">—</strong></div>
          <div class="truth-row"><span class="truth-k">Generated at:</span> <span id="generated-at">—</span></div>
          <div class="truth-row"><span class="truth-k">Environment:</span> <span id="environment">—</span></div>
        </div>

        <div class="section-divider"></div>

        <div class="panel-header">
          <div class="panel-title">GOVERNANCE EXPLANATION</div>
          <span id="gov-pill" class="pill ok">EVALUATED</span>
        </div>

        <div class="gov-box">
          <div class="gov-q">Why is the current state allowed?</div>
          <ul id="gov-reasons" class="gov-list"></ul>
        </div>

        <div class="section-divider"></div>

        <div class="panel-header">
          <div class="panel-title">SELF-HEALING CAPABILITY</div>
          <span class="pill warn">GOVERNED</span>
        </div>

        <div class="bullets">
          <div>• Health degradation can be detected deterministically</div>
          <div>• Corrective actions are proposed via pull request (never executed silently)</div>
          <div>• All actions require governance approval and a decision trace</div>
          <div>• Production changes without review are explicitly disallowed</div>
          <div class="muted">Controlled autonomy — no autopilot.</div>
        </div>

        <div class="section-divider"></div>

        <div class="panel-header">
          <div class="panel-title">PIPELINES &amp; GUARDS</div>
          <span class="pill ok">TRUTH LOCKED</span>
        </div>

        <div class="guards">
          <div class="guard-row">
            <div class="guard-label">FRESHNESS</div>
            <div class="guard-value" id="guard-freshness">—</div>
            <span class="mini-pill warn" id="guard-freshness-pill">—</span>
          </div>

          <div class="guard-row">
            <div class="guard-label">RUNTIME GATE</div>
            <div class="guard-value" id="guard-gate">—</div>
            <span class="mini-pill warn" id="guard-gate-pill">—</span>
          </div>

          <div class="guard-row">
            <div class="guard-label">AUDIT TRAIL</div>
            <div class="guard-value" id="guard-audit">—</div>
            <span class="mini-pill warn" id="guard-audit-pill">—</span>
          </div>

          <div class="guard-row">
            <div class="guard-label">DECISION TRACE</div>
            <div class="guard-value" id="guard-trace">—</div>
            <span class="mini-pill warn" id="guard-trace-pill">—</span>
          </div>

          <div class="guard-row">
            <div class="guard-label">STATUS AGENT</div>
            <div class="guard-value" id="guard-status-agent">—</div>
            <span class="mini-pill warn" id="guard-status-agent-pill">—</span>
          </div>
        </div>
      </section>
    </section>

    <!-- Status Agent evidence panel -->
    <section class="panel panel-wide">
      <div class="panel-header">
        <div class="panel-title">STATUS AGENT (EVIDENCE)</div>
        <span id="status-agent-pill" class="pill warn">UNKNOWN</span>
      </div>

      <div class="evidence-grid">
        <div class="evidence-box">
          <div class="evidence-label">Source</div>
          <div class="evidence-value" id="status-agent-source">—</div>
        </div>

        <div class="evidence-box">
          <div class="evidence-label">Last run (UTC)</div>
          <div class="evidence-value" id="status-agent-last">—</div>
        </div>

        <div class="evidence-box">
          <div class="evidence-label">Freshness</div>
          <div class="evidence-value" id="status-agent-freshness">—</div>
        </div>

        <div class="evidence-box">
          <div class="evidence-label">Last result</div>
          <div class="evidence-value" id="status-agent-result">—</div>
        </div>

        <div class="evidence-box">
          <div class="evidence-label">Total runs</div>
          <div class="evidence-value" id="status-agent-ops">—</div>
        </div>
      </div>

      <div class="evidence-note" id="status-agent-note">
        This panel displays server-side evidence produced by the Status Agent. The browser does not generate operations.
      </div>

      <div id="status-agent-feed" class="feed"></div>
    </section>
  </main>

  <script>
/* virtauto.OS Status Dashboard — TRUTH-LOCKED (Single Source of Truth)
   - Reads ONLY from /ops/reports/system_status.json
   - Optional evidence: /ops/agent_activity.jsonl (Status Agent)
   - No client-side simulation. If truth is missing/unreadable → show fatal panel.
*/
(() => {
  const TRUTH_PATH = "/ops/reports/system_status.json";
  const STATUS_AGENT_LOG_PATH = "/ops/agent_activity.jsonl";

  const $ = (id) => document.getElementById(id);

  function setText(id, val, fallback = "—") {
    const el = $(id);
    if (!el) return;
    el.textContent = (val === undefined || val === null || val === "") ? fallback : String(val);
  }

  function safeUpper(v, fallback = "—") {
    if (v === undefined || v === null || v === "") return fallback;
    return String(v).toUpperCase();
  }

  function setPillClass(el, kind) {
    if (!el) return;
    el.classList.remove("ok", "warn", "crit");
    if (kind) el.classList.add(kind);
  }

  function minutesSince(isoTs) {
    if (!isoTs) return null;
    const t = new Date(isoTs).getTime();
    if (!Number.isFinite(t)) return null;
    return Math.max(0, Math.round((Date.now() - t) / 60000));
  }

  function classifyFreshness(ageMin) {
    if (ageMin === null) return { label: "UNKNOWN", kind: "warn" };
    if (ageMin <= 15) return { label: "FRESH", kind: "ok" };
    if (ageMin <= 60) return { label: "STALE", kind: "warn" };
    return { label: "EXPIRED", kind: "crit" };
  }

  function showFatal(err) {
    const fatal = $("fatal");
    if (fatal) fatal.style.display = "block";
    const page = $("page");
    if (page) page.style.display = "none";
    setText("fatal-src", TRUTH_PATH, TRUTH_PATH);
    setText("fatal-err", err?.message || String(err), String(err));
  }

  async function fetchJsonNoCache(path) {
    const url = `${path}?v=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} while fetching ${path}`);
    return await res.json();
  }

  async function fetchTextNoCache(path) {
    const url = `${path}?v=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} while fetching ${path}`);
    return await res.text();
  }

  function parseJSONL(text) {
    const out = [];
    for (const line of String(text || "").split(/\r?\n/)) {
      const l = line.trim();
      if (!l) continue;
      try { out.push(JSON.parse(l)); } catch { /* ignore */ }
    }
    return out;
  }

  function gateVerdict(status) {
    return (
      status?.autonomy_score?.inputs?.gate_verdict ??
      status?.governance?.gate_verdict ??
      status?.governance?.gate?.verdict ??
      status?.gate?.verdict ??
      "—"
    );
  }

  function pillKindForGate(v) {
    const s = safeUpper(v);
    if (s.includes("ALLOW") || s.includes("PASS")) return "ok";
    if (s === "—" || s.includes("UNKNOWN")) return "warn";
    return "crit";
  }

  function pillKindForState(v) {
    const s = safeUpper(v, "UNKNOWN");
    if (s.includes("ACTIVE") || s.includes("OK")) return "ok";
    if (s.includes("PLANNED") || s.includes("INACTIVE") || s.includes("UNKNOWN")) return "warn";
    if (s.includes("FAIL") || s.includes("ERROR") || s.includes("BLOCK")) return "crit";
    return "warn";
  }

  function renderMeta(status) {
    setText("truth-source", TRUTH_PATH);
    const age = minutesSince(status?.generated_at);
    setText("freshness", age === null ? "—" : `${age} min`);

    const sysState =
      status?.system_state ??
      status?.system?.state ??
      status?.system?.status ??
      "UNKNOWN";

    setText("system-pill", safeUpper(sysState, "UNKNOWN"), "UNKNOWN");
    setPillClass($("system-pill"), pillKindForState(sysState));
  }

  function renderKPIs(status) {
    const agents = status?.agents || {};
    const total = Object.keys(agents).length;

    const active = Object.values(agents).filter(a => safeUpper(a?.state ?? a?.status, "UNKNOWN").includes("ACTIVE")).length;
    setText("kpi-agent-health", `${active} / ${total}`);
    setText("kpi-agent-health-note", "Active agents / total agents");

    const autonomyPct =
      status?.autonomy_score?.percent ??
      (typeof status?.autonomy_score?.value === "number" ? status.autonomy_score.value * 100 : null);
    setText("kpi-autonomy", autonomyPct == null ? "—" : `${Number(autonomyPct).toFixed(1)}%`);
    const mode = status?.autonomy_score?.mode ?? status?.autonomy ?? status?.system?.autonomy_mode ?? "—";
    setText("kpi-autonomy-note", `Mode: ${safeUpper(mode)}`);

    const overall = status?.health?.overall_score;
    setText("kpi-health", overall == null ? "—" : String(overall));
    const signal = status?.health?.signal ? safeUpper(status.health.signal) : "—";
    setText("kpi-health-note", `Signal: ${signal}`);

    const gate = gateVerdict(status);
    setText("kpi-governance", safeUpper(gate));
    setText("kpi-governance-note", "Audit trail & gate verdict");
  }

  function renderTruthBox(status) {
    setText("truth-path", TRUTH_PATH);
    setText("generated-at", status?.generated_at || "—");
    setText("environment", status?.environment || "—");
  }

  function renderAgents(status) {
    const grid = $("agents-grid");
    if (!grid) return;
    grid.innerHTML = "";

    const agents = status?.agents || {};

    const order = [
      ["status_agent", "Status Agent", "truth_regenerator"],
      ["george", "GEORGE", "orchestrator"],
      ["guardian", "Guardian", "observer"],
      ["monitoring", "Monitoring", "observer"],
      ["content", "Content", "observer"],
      ["deploy_agent", "Deployment Agent", "executor"],
      ["consistency", "Consistency", "validator"]
    ];

    const used = new Set();

    function renderOne(key, titleFallback, roleFallback) {
      const a = agents[key] || {};
      used.add(key);

      const state = a.state ?? a.status ?? "UNKNOWN";
      const mode = a.autonomy_mode ?? a.autonomy ?? status?.autonomy ?? "—";
      const role = a.role ?? roleFallback ?? "—";
      const title = a.title ?? titleFallback ?? key;

      const article = document.createElement("article");
      article.className = "status-card";

      article.innerHTML = `
        <div class="status-title-row">
          <div class="status-title">${title}</div>
          <span class="status-pill ${pillKindForState(state)}">${safeUpper(state, "UNKNOWN")}</span>
        </div>
        <div class="status-meta">
          <span class="meta-item">Role: <strong>${role}</strong></span>
          <span class="meta-item">Mode: <strong>${safeUpper(mode)}</strong></span>
          <span class="meta-item">Key: <strong>${key}</strong></span>
        </div>
      `;
      grid.appendChild(article);
    }

    for (const [key, title, role] of order) {
      if (agents[key]) renderOne(key, title, role);
    }
    for (const key of Object.keys(agents).filter(k => !used.has(k)).sort()) {
      renderOne(key, key, agents[key]?.role);
    }
  }

  function renderGuards(status) {
    const age = minutesSince(status?.generated_at);
    const fres = classifyFreshness(age);
    setText("guard-freshness", age === null ? "—" : `${age} min ago`);
    setText("guard-freshness-pill", fres.label);
    setPillClass($("guard-freshness-pill"), fres.kind);

    const gate = gateVerdict(status);
    setText("guard-gate", safeUpper(gate));
    setText("guard-gate-pill", safeUpper(gate, "UNKNOWN"));
    setPillClass($("guard-gate-pill"), pillKindForGate(gate));

    const links = status?.links || {};
    const traceLinked = Boolean(links.decision_trace || links.decision_trace_jsonl || links.decision_trace_json);
    const auditAvail = Boolean(links.latest_decision || links.decision_trace || links.decision_trace_jsonl || links.decision_trace_json);

    setText("guard-audit", auditAvail ? "Available" : "Missing");
    setText("guard-audit-pill", auditAvail ? "OK" : "MISSING");
    setPillClass($("guard-audit-pill"), auditAvail ? "ok" : "warn");

    setText("guard-trace", traceLinked ? "LINKED" : "UNLINKED");
    setText("guard-trace-pill", traceLinked ? "OK" : "MISSING");
    setPillClass($("guard-trace-pill"), traceLinked ? "ok" : "warn");

    setText("guard-status-agent", "—");
    setText("guard-status-agent-pill", "—");
    setPillClass($("guard-status-agent-pill"), "warn");
  }

  function renderGovernanceExplanation(status) {
    const ul = $("gov-reasons");
    if (!ul) return;
    ul.innerHTML = "";

    const reasons = [];
    const health = status?.health || {};
    if (health.signal) reasons.push(`Health signal is ${safeUpper(health.signal)}`);
    if (health.overall_score != null) reasons.push(`Health score is ${health.overall_score}`);

    const gate = gateVerdict(status);
    if (gate !== "—") reasons.push(`Governance gate verdict is ${safeUpper(gate)}`);
    else reasons.push("Governance gate verdict is not present in the truth source");

    const links = status?.links || {};
    if (links.decision_trace || links.decision_trace_jsonl || links.decision_trace_json) {
      reasons.push("Decision trace is linked (audit trail available)");
    } else {
      reasons.push("Decision trace link is missing (audit trail limited)");
    }
    if (links.gate_result) reasons.push("Gate result artifact is linked");
    else reasons.push("Gate result link is missing");

    for (const r of reasons) {
      const li = document.createElement("li");
      li.textContent = r;
      ul.appendChild(li);
    }

    const gateKind = pillKindForGate(gate);
    setText("gov-pill", "EVALUATED");
    setPillClass($("gov-pill"), gateKind);
  }

  function briefResultTag(result, statusText) {
    const r = safeUpper(result || statusText || "UNKNOWN");
    if (r.includes("OK") || r.includes("PASS") || r.includes("ALLOW")) return { text: "OK", kind: "ok" };
    if (r.includes("WARN") || r.includes("NO DATA") || r.includes("UNKNOWN")) return { text: r, kind: "warn" };
    if (r.includes("FAIL") || r.includes("BLOCK") || r.includes("ERROR")) return { text: r, kind: "crit" };
    return { text: r, kind: "warn" };
  }

  function renderStatusAgentEvidence(events, loaderError) {
    setText("status-agent-source", STATUS_AGENT_LOG_PATH);

    const pill = $("status-agent-pill");
    const guardPill = $("guard-status-agent-pill");

    if (loaderError) {
      setText("status-agent-note", `Evidence source missing or unreadable: ${STATUS_AGENT_LOG_PATH}. This is not simulated in the browser.`);
      setText("status-agent-last", "—");
      setText("status-agent-freshness", "—");
      setText("status-agent-result", "MISSING");
      setText("status-agent-ops", "—");
      setPillClass(pill, "warn");

      setText("guard-status-agent", "MISSING");
      setText("guard-status-agent-pill", "MISSING");
      setPillClass(guardPill, "warn");
      return;
    }

    const list = (events || []).filter(e => String(e.agent || "").toLowerCase() === "status_agent");
    if (!list.length) {
      setText("status-agent-note", "Evidence loaded, but no status_agent events found.");
      setText("status-agent-last", "—");
      setText("status-agent-freshness", "—");
      setText("status-agent-result", "NO DATA");
      setText("status-agent-ops", "0");
      setPillClass(pill, "warn");

      setText("guard-status-agent", "NO DATA");
      setText("guard-status-agent-pill", "NO DATA");
      setPillClass(guardPill, "warn");
      return;
    }

    list.sort((a, b) => (new Date(b.timestamp || 0).getTime()) - (new Date(a.timestamp || 0).getTime()));
    const latest = list[0];

    const age = minutesSince(latest.timestamp);
    const fres = classifyFreshness(age);
    const rr = briefResultTag(latest.result, latest.status);

    setText("status-agent-note", `Rendered from ${STATUS_AGENT_LOG_PATH}. No client-side timers, no simulated operations.`);
    setText("status-agent-last", latest.timestamp || "—");
    setText("status-agent-freshness", fres.label);
    setText("status-agent-result", rr.text);
    setText("status-agent-ops", String(list.length));
    setPillClass(pill, rr.kind);

    setText("guard-status-agent", fres.label);
    setText("guard-status-agent-pill", fres.label);
    setPillClass(guardPill, fres.kind);

    const feed = $("status-agent-feed");
    if (feed) {
      feed.innerHTML = "";
      for (const e of list.slice(0, 6)) {
        const item = document.createElement("div");
        item.className = "feed-item";
        const ts = e.timestamp || "—";
        const tag = briefResultTag(e.result, e.status);
        item.innerHTML = `
          <div class="feed-row">
            <span class="mini-pill ${tag.kind}">${tag.text}</span>
            <span class="feed-ts">${ts}</span>
            <span class="feed-action">${(e.action || e.operation || "operation").toString().replace(/_/g, " ")}</span>
          </div>
        `;
        feed.appendChild(item);
      }
    }
  }

  async function boot() {
    try {
      const status = await fetchJsonNoCache(TRUTH_PATH);

      const fatal = $("fatal");
      if (fatal) fatal.style.display = "none";
      const page = $("page");
      if (page) page.style.display = "block";

      renderMeta(status);
      renderKPIs(status);
      renderTruthBox(status);
      renderAgents(status);
      renderGuards(status);
      renderGovernanceExplanation(status);

      try {
        const txt = await fetchTextNoCache(STATUS_AGENT_LOG_PATH);
        const events = parseJSONL(txt);
        renderStatusAgentEvidence(events, null);
      } catch (e) {
        console.warn(e);
        renderStatusAgentEvidence([], e);
      }
    } catch (err) {
      console.error(err);
      showFatal(err);
    }
  }

  boot();
})();
  </script>

  <!-- Header + navigation injection -->
  <script src="/assets/header_include.js" defer></script>
  <script src="/assets/site.js" defer></script>
</body>
</html>