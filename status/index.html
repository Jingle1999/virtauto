<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>virtauto.OS — Live System Status · virtauto®</title>
  <link rel="canonical" href="https://www.virtauto.de/status/"/>

  <!-- SEO -->
  <meta name="description" content="virtauto.OS Live System Status — truth-locked dashboard rendered exclusively from /ops/reports/system_status.json."/>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="virtauto.OS — Live System Status">
  <meta property="og:description" content="Truth-locked. Every value rendered from the Single Source of Truth.">
  <meta property="og:url" content="https://www.virtauto.de/status/">

  <!-- Theme (global site styles) -->
  <link rel="stylesheet" href="/assets/styles_unify.css"/>
  <link rel="stylesheet" href="/assets/styles.css"/>

  <!-- Header/Nav auto-injection + nav behavior -->
  <script defer src="/assets/header_include.js"></script>
  <script defer src="/assets/site.js"></script>

  <!-- Page-scoped styling ONLY (no global side effects) -->
  <style>
    /* ===========================
       STATUS PAGE — SCOPED STYLES
       Everything is scoped under .va-status
       =========================== */

    .va-status {
      --va-surface: rgba(12, 16, 28, 0.72);
      --va-surface-2: rgba(12, 16, 28, 0.55);
      --va-border: rgba(255,255,255,0.08);
      --va-border-2: rgba(255,255,255,0.12);
      --va-text: rgba(255,255,255,0.92);
      --va-text-2: rgba(255,255,255,0.70);
      --va-shadow: 0 18px 50px rgba(0,0,0,0.45);
      --va-radius: 18px;
      --va-gap: 16px;
    }

    .va-status .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .va-status .hero {
      padding: 18px 0 18px;
    }

    .va-status h1.title {
      margin: 0 0 8px;
      font-size: 34px;
      line-height: 1.15;
      letter-spacing: -0.02em;
      color: var(--va-text);
    }

    .va-status .subtitle {
      margin: 0 0 18px;
      color: var(--va-text-2);
      max-width: 80ch;
    }

    .va-status .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
    }

    .va-status .chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--va-border);
      color: var(--va-text);
      font-size: 13px;
      line-height: 1;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .va-status .chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
    }

    .va-status .chip .muted { color: var(--va-text-2); }

    /* Status colors */
    .va-status .dot.ok    { background: rgba(72, 255, 171, 0.95); box-shadow: 0 0 0 3px rgba(72,255,171,0.14); }
    .va-status .dot.warn  { background: rgba(255, 211, 87, 0.95); box-shadow: 0 0 0 3px rgba(255,211,87,0.14); }
    .va-status .dot.crit  { background: rgba(255, 98, 98, 0.95); box-shadow: 0 0 0 3px rgba(255,98,98,0.14); }
    .va-status .dot.info  { background: rgba(110, 170, 255, 0.95); box-shadow: 0 0 0 3px rgba(110,170,255,0.14); }

    .va-status .grid {
      display: grid;
      grid-template-columns: 1.45fr 1fr;
      gap: var(--va-gap);
      align-items: start;
      margin-top: 18px;
    }

    @media (max-width: 980px) {
      .va-status .grid { grid-template-columns: 1fr; }
    }

    .va-status .card {
      background: var(--va-surface);
      border: 1px solid var(--va-border);
      border-radius: var(--va-radius);
      box-shadow: var(--va-shadow);
      overflow: hidden;
    }

    .va-status .cardHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--va-border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }

    .va-status .cardHeader h2 {
      margin: 0;
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.78);
      font-weight: 700;
    }

    .va-status .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid var(--va-border-2);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.86);
      white-space: nowrap;
    }

    .va-status .badge .dot { width: 7px; height: 7px; border-radius: 999px; }

    .va-status .cardBody {
      padding: 14px 16px 16px;
    }

    .va-status .kpiGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 520px) {
      .va-status .kpiGrid { grid-template-columns: 1fr; }
    }

    .va-status .kpi {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--va-border);
      border-radius: 14px;
      padding: 12px;
    }

    .va-status .kpi .label {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.60);
      margin-bottom: 6px;
      font-weight: 700;
    }

    .va-status .kpi .value {
      font-size: 22px;
      font-weight: 800;
      color: rgba(255,255,255,0.92);
      margin-bottom: 4px;
    }

    .va-status .kpi .sub {
      font-size: 12px;
      color: rgba(255,255,255,0.65);
    }

    .va-status .list {
      display: grid;
      gap: 10px;
    }

    .va-status .agentCard {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--va-border);
      border-radius: 14px;
    }

    .va-status .agentTitle {
      font-weight: 800;
      color: rgba(255,255,255,0.92);
      margin: 0 0 4px;
      font-size: 14px;
    }

    .va-status .agentMeta {
      color: rgba(255,255,255,0.66);
      font-size: 12px;
      line-height: 1.35;
    }

    .va-status .pillRow {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .va-status .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid var(--va-border-2);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.88);
      white-space: nowrap;
    }

    .va-status .pill .dot { width: 7px; height: 7px; border-radius: 999px; }

    .va-status .sectionGrid {
      display: grid;
      grid-template-columns: 1.45fr 1fr;
      gap: var(--va-gap);
      align-items: start;
      margin-top: var(--va-gap);
    }

    @media (max-width: 980px) {
      .va-status .sectionGrid { grid-template-columns: 1fr; }
    }

    .va-status .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .va-status .small {
      font-size: 12px;
      color: rgba(255,255,255,0.66);
    }

    .va-status .bullets {
      margin: 0;
      padding-left: 16px;
      color: rgba(255,255,255,0.76);
      line-height: 1.45;
      font-size: 13px;
    }

    .va-status .bullets li { margin: 6px 0; }

    .va-status .rows {
      display: grid;
      gap: 10px;
    }

    .va-status .rowCard {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--va-border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .va-status .rowLeft .rowTitle {
      font-weight: 800;
      font-size: 13px;
      margin: 0 0 4px;
      color: rgba(255,255,255,0.92);
    }

    .va-status .rowLeft .rowSub {
      font-size: 12px;
      color: rgba(255,255,255,0.66);
      margin: 0;
    }

    .va-status .chev {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--va-border);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.75);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
    }

    .va-status .chev:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.14);
    }

    .va-status .details {
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,0.10);
      padding-top: 10px;
      display: none;
    }

    .va-status .details.open { display: block; }

    .va-status pre.log {
      margin: 0;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.30);
      overflow: auto;
      color: rgba(255,255,255,0.80);
      font-size: 12px;
      line-height: 1.45;
    }

    .va-status .fatal {
      margin-top: 18px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,98,98,0.28);
      background: rgba(255,98,98,0.10);
      color: rgba(255,255,255,0.92);
      display: none;
    }

    .va-status .fatal h3 {
      margin: 0 0 6px;
      font-size: 14px;
      font-weight: 900;
    }

    .va-status .fatal p {
      margin: 0;
      color: rgba(255,255,255,0.78);
      font-size: 13px;
      line-height: 1.45;
    }

    .va-status .footnote {
      margin-top: 14px;
      color: rgba(255,255,255,0.55);
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>

<body class="bg">
  <!-- Header/Nav gets injected here -->
  <div id="site-header"></div>

  <main class="va-status">
    <div class="wrap">
      <header class="hero">
        <h1 class="title">virtauto.OS — Live System Status <span class="badge"><span class="dot info"></span>TRUTH-LOCKED</span></h1>
        <p class="subtitle">
          This dashboard is the single authoritative interface for the operational state of <span class="mono">www.virtauto.de</span>.
          Every value on this page is rendered from the Single Source of Truth and refuses to show if the truth source is missing.
          <br/><br/>
          Agents operate as governed system actors with auditable behavior and bounded authority.
        </p>

        <div class="chips">
          <span class="chip">
            <span id="statusDot" class="dot info"></span>
            <span><span class="muted">Agentic Website</span> — <strong id="statusMode">—</strong></span>
          </span>
          <span class="chip">
            <span class="dot info"></span>
            <span><span class="muted">Truth Source</span> — <strong id="truthSourcePath">—</strong></span>
          </span>
          <span class="chip">
            <span id="freshDot" class="dot info"></span>
            <span><span class="muted">Freshness</span> — <strong id="freshnessLabel">—</strong></span>
          </span>
        </div>

        <div id="fatalBox" class="fatal" role="alert" aria-live="polite">
          <h3>Truth lock violated — nothing rendered</h3>
          <p id="fatalMsg">—</p>
        </div>
      </header>

      <section class="grid" aria-label="Status Dashboard">
        <!-- LEFT COLUMN -->
        <div class="card" id="coreCard">
          <div class="cardHeader">
            <h2>Core Agents &amp; Layers</h2>
            <span class="badge"><span id="systemDot" class="dot info"></span><span id="systemLabel">SYSTEM —</span></span>
          </div>
          <div class="cardBody">
            <div class="list" id="coreAgents">
              <!-- injected -->
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <aside class="card" id="kpiCard">
          <div class="cardHeader">
            <h2>System KPIs</h2>
            <span class="badge"><span id="snapshotDot" class="dot info"></span>LIVE SNAPSHOT</span>
          </div>
          <div class="cardBody">
            <div class="kpiGrid">
              <div class="kpi">
                <div class="label">Agent Health</div>
                <div class="value" id="kpiAgentHealth">—</div>
                <div class="sub" id="kpiAgentHealthSub">Active agents / total agents</div>
              </div>

              <div class="kpi">
                <div class="label">Autonomy (confirmed)</div>
                <div class="value" id="kpiAutonomy">—</div>
                <div class="sub" id="kpiAutonomySub">Mode: —</div>
              </div>

              <div class="kpi">
                <div class="label">Health Score</div>
                <div class="value" id="kpiHealthScore">—</div>
                <div class="sub" id="kpiHealthScoreSub">Signal: —</div>
              </div>

              <div class="kpi">
                <div class="label">Governance</div>
                <div class="value" id="kpiGovernance">—</div>
                <div class="sub" id="kpiGovernanceSub">Audit trail &amp; gate verdict</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="kpi">
              <div class="label">Truth Lock</div>
              <div class="sub small">
                This page reads from <span class="mono" id="truthPathEcho">—</span><br/>
                Generated at: <span class="mono" id="generatedAt">—</span><br/>
                Environment: <span class="mono" id="environment">—</span>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="card" style="background: transparent; border: 1px solid rgba(255,255,255,0.08); box-shadow: none;">
              <div class="cardHeader" style="background: rgba(255,255,255,0.03);">
                <h2>Governance Explanation</h2>
                <span class="badge"><span id="govDot" class="dot info"></span><span id="govLabel">EVALUATED</span></span>
              </div>
              <div class="cardBody">
                <div class="small" style="margin-bottom:8px;">Why is the current state allowed?</div>
                <ul class="bullets" id="govBullets">
                  <li>—</li>
                </ul>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card" style="background: transparent; border: 1px solid rgba(255,255,255,0.08); box-shadow: none;">
              <div class="cardHeader" style="background: rgba(255,255,255,0.03);">
                <h2>Self-Healing Capability</h2>
                <span class="badge"><span id="healDot" class="dot info"></span><span id="healLabel">GOVERNED</span></span>
              </div>
              <div class="cardBody">
                <div class="small" style="margin-bottom:8px;">Governed by PRs — no silent execution.</div>
                <ul class="bullets">
                  <li>Health degradation can be detected deterministically</li>
                  <li>Corrective actions are proposed via pull request (never executed silently)</li>
                  <li>All actions require governance approval and a decision trace</li>
                  <li>Production changes without review are explicitly disallowed</li>
                  <li>Controlled autonomy — no autopilot.</li>
                </ul>
              </div>
            </div>

          </div>
        </aside>
      </section>

      <section class="sectionGrid" aria-label="Evidence and Guards">
        <!-- LEFT -->
        <div class="card" id="evidenceCard">
          <div class="cardHeader">
            <h2>Status Agent (Evidence)</h2>
            <span class="badge"><span id="evidenceDot" class="dot info"></span><span id="evidenceLabel">—</span></span>
          </div>
          <div class="cardBody">
            <p class="small" style="margin:0 0 12px;">
              This panel displays server-side evidence produced by the Status Agent. The browser does not generate operations.
            </p>

            <div class="kpiGrid">
              <div class="kpi">
                <div class="label">Source</div>
                <div class="value mono" style="font-size:16px" id="evidenceSource">—</div>
                <div class="sub">Rendered from server artifact. No client-side timers, no simulated operations.</div>
              </div>
              <div class="kpi">
                <div class="label">Last Run (UTC)</div>
                <div class="value mono" style="font-size:16px" id="evidenceLastRun">—</div>
                <div class="sub">Freshness: <span class="mono" id="evidenceFreshness">—</span></div>
              </div>
              <div class="kpi">
                <div class="label">Last Result</div>
                <div class="value" style="font-size:16px" id="evidenceLastResult">—</div>
                <div class="sub">Total runs <span class="mono" id="evidenceTotalRuns">—</span></div>
              </div>
              <div class="kpi">
                <div class="label">Feed</div>
                <div class="value" style="font-size:16px" id="evidenceFeedState">—</div>
                <div class="sub">Latest <span class="mono" id="evidenceFeedCount">—</span> events (non-sensitive)</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="rows" id="evidenceRows">
              <!-- injected -->
            </div>

          </div>
        </div>

        <!-- RIGHT -->
        <aside class="card" id="guardsCard">
          <div class="cardHeader">
            <h2>Pipelines &amp; Guards</h2>
            <span class="badge"><span id="guardsDot" class="dot info"></span>TRUTH LOCKED</span>
          </div>
          <div class="cardBody">
            <p class="small" style="margin:0 0 10px;">
              Truth-locked checks derived from artifacts.
            </p>

            <div class="rows" id="guardsRows">
              <!-- injected -->
            </div>

            <div class="footnote">
              Status page generated by <span class="mono">virtauto.OS</span> — single source of truth.
            </div>
          </div>
        </aside>
      </section>
    </div>
  </main>

  <script>
    /**
     * ============================================================
     * HARD RULE:
     *   - Single Source of Truth: /ops/reports/system_status.json
     *   - If missing or unreadable -> showFatal() and render NOTHING.
     * ============================================================
     */

    const TRUTH_PATH = "/ops/reports/system_status.json";
    const STATUS_AGENT_LOG_PATH = "/ops/agent_activity.jsonl";

    const $ = (id) => document.getElementById(id);

    function setDot(dotEl, kind){
      dotEl.classList.remove("ok","warn","crit","info");
      dotEl.classList.add(kind);
    }
    function setPill(pillEl, kind){
      pillEl.classList.remove("ok","warn","crit","info");
      pillEl.classList.add(kind);
    }

    function showFatal(message){
      const box = $("fatalBox");
      const msg = $("fatalMsg");
      msg.textContent = message;
      box.style.display = "block";

      // hide all cards (render NOTHING)
      const ids = ["coreCard","kpiCard","evidenceCard","guardsCard"];
      for (const id of ids) {
        const el = $(id);
        if (el) el.style.display = "none";
      }

      // top chips still show but should indicate failure
      const sDot = $("statusDot");
      const fDot = $("freshDot");
      if (sDot) setDot(sDot, "crit");
      if (fDot) setDot(fDot, "crit");
      $("statusMode").textContent = "TRUTH SOURCE MISSING";
      $("truthSourcePath").textContent = TRUTH_PATH;
      $("truthPathEcho").textContent = TRUTH_PATH;
      $("freshnessLabel").textContent = "—";
    }

    function safeText(v, fallback="—"){
      if (v === null || v === undefined) return fallback;
      const s = String(v);
      return s.length ? s : fallback;
    }

    function fmtPercent(p){
      if (p === null || p === undefined || Number.isNaN(Number(p))) return "—";
      const n = Number(p);
      return (n % 1 === 0) ? `${n}%` : `${n.toFixed(1)}%`;
    }

    function fmtScore(x){
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "—";
      const n = Number(x);
      return (n % 1 === 0) ? String(n) : n.toFixed(2);
    }

    function freshnessFromISO(iso){
      if (!iso) return { label:"—", kind:"info" };
      const t = Date.parse(iso);
      if (Number.isNaN(t)) return { label:"—", kind:"info" };
      const now = Date.now();
      const diffMs = Math.max(0, now - t);
      const mins = Math.round(diffMs / 60000);

      if (mins <= 2) return { label:`${mins} min`, kind:"ok" };
      if (mins <= 10) return { label:`${mins} min`, kind:"warn" };
      return { label:`${mins} min`, kind:"crit" };
    }

    function computeAgentCounts(data){
      const agents = data?.agents || data?.agent_registry || data?.system?.agents || {};
      const keys = Object.keys(agents || {});
      const total = keys.length;

      let active = 0;
      for (const k of keys){
        const a = agents[k] || {};
        const state = (a.state || a.status || "").toUpperCase();
        if (state === "ACTIVE") active += 1;
      }
      return { active, total, agents };
    }

    function buildAgentCard(key, agent){
      const el = document.createElement("div");
      el.className = "agentCard";

      const left = document.createElement("div");
      const title = document.createElement("p");
      title.className = "agentTitle";
      title.textContent = safeText(agent.title || agent.name || key);

      const meta = document.createElement("div");
      meta.className = "agentMeta";
      const role = safeText(agent.role || "—");
      const mode = safeText(agent.mode || agent.autonomy_mode || "—");
      meta.textContent = `Role: ${role}  Mode: ${mode}  Key: ${key}`;

      left.appendChild(title);
      left.appendChild(meta);

      const pills = document.createElement("div");
      pills.className = "pillRow";

      const st = (agent.state || agent.status || "UNKNOWN").toUpperCase();
      const stPill = document.createElement("span");
      stPill.className = "pill";
      const stDot = document.createElement("span");
      stDot.className = "dot";
      stPill.appendChild(stDot);
      stPill.appendChild(document.createTextNode(st));
      setDot(stDot, st === "ACTIVE" ? "ok" : (st === "PLANNED" ? "warn" : (st === "INACTIVE" ? "crit" : "info")));

      const mPill = document.createElement("span");
      mPill.className = "pill";
      const mDot = document.createElement("span");
      mDot.className = "dot";
      mPill.appendChild(mDot);
      mPill.appendChild(document.createTextNode(mode.toUpperCase()));
      setDot(mDot, mode.toUpperCase().includes("SUPERVISED") ? "ok" : (mode.toUpperCase().includes("MANUAL") ? "warn" : "info"));

      pills.appendChild(stPill);
      pills.appendChild(mPill);

      el.appendChild(left);
      el.appendChild(pills);
      return el;
    }

    function buildGuardRow(label, value, kind, detailsText){
      const wrap = document.createElement("div");
      wrap.className = "rowCard";

      const left = document.createElement("div");
      left.className = "rowLeft";

      const t = document.createElement("p");
      t.className = "rowTitle";
      t.textContent = label;

      const s = document.createElement("p");
      s.className = "rowSub";
      s.textContent = value;

      left.appendChild(t);
      left.appendChild(s);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.alignItems = "center";
      right.style.gap = "10px";

      const pill = document.createElement("span");
      pill.className = "pill";
      const dot = document.createElement("span");
      dot.className = "dot";
      pill.appendChild(dot);
      pill.appendChild(document.createTextNode(kind.toUpperCase()));
      setDot(dot, kind);

      const btn = document.createElement("div");
      btn.className = "chev";
      btn.textContent = "›";

      const details = document.createElement("div");
      details.className = "details";

      const pre = document.createElement("pre");
      pre.className = "log mono";
      pre.textContent = detailsText || "";
      details.appendChild(pre);

      btn.addEventListener("click", () => {
        const open = details.classList.toggle("open");
        btn.textContent = open ? "⌄" : "›";
      });

      right.appendChild(pill);
      right.appendChild(btn);

      wrap.appendChild(left);
      wrap.appendChild(right);
      wrap.appendChild(details);

      return wrap;
    }

    function buildEvidenceRow(item){
      const label = safeText(item.label || item.operation || "operation");
      const ts = safeText(item.ts || item.time || item.timestamp || "—");
      const status = safeText(item.status || item.result || "UNKNOWN").toUpperCase();
      const note = safeText(item.note || item.message || "");

      const kind =
        status === "OK" || status === "PASS" ? "ok" :
        status === "WARN" ? "warn" :
        status === "FAIL" || status === "ERROR" ? "crit" : "info";

      const details = note ? `${note}` : `—`;
      return buildGuardRow(`${status} — ${label}`, ts, kind, details);
    }

    async function fetchJSON(path){
      const bust = `${path}${path.includes("?") ? "&" : "?"}t=${Date.now()}`;
      const res = await fetch(bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${path}`);
      return await res.json();
    }

    async function fetchText(path){
      const bust = `${path}${path.includes("?") ? "&" : "?"}t=${Date.now()}`;
      const res = await fetch(bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${path}`);
      return await res.text();
    }

    function parseJSONL(text, limit=6){
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const out = [];
      for (let i = Math.max(0, lines.length - limit); i < lines.length; i++){
        try {
          out.push(JSON.parse(lines[i]));
        } catch {
          out.push({ status:"UNKNOWN", operation:"operation", ts:"—", note:"(unparseable line)" });
        }
      }
      return out;
    }

    function render(data){
      // Header chips
      $("truthSourcePath").textContent = TRUTH_PATH;
      $("truthPathEcho").textContent = TRUTH_PATH;

      const gen = data.generated_at || data.generatedAt || data?.meta?.generated_at || null;
      const env = data.environment || data?.meta?.environment || "production";
      $("generatedAt").textContent = safeText(gen);
      $("environment").textContent = safeText(env);

      // System status
      const sysState = (data.system_state || data?.system?.state || data?.system?.status || "UNKNOWN").toUpperCase();
      const sysMode = safeText(data.autonomy || data?.system?.autonomy_mode || data?.autonomy_model?.system_level || "—");
      $("statusMode").textContent = sysState === "ACTIVE" ? "Live in Production" : sysState;

      // overall dots
      setDot($("statusDot"), sysState === "ACTIVE" ? "ok" : "warn");

      // Freshness (from generated_at)
      const fresh = freshnessFromISO(gen);
      $("freshnessLabel").textContent = fresh.label;
      setDot($("freshDot"), fresh.kind);

      // SYSTEM badge
      $("systemLabel").textContent = `SYSTEM ${sysState}`;
      setDot($("systemDot"), sysState === "ACTIVE" ? "ok" : "warn");
      setDot($("snapshotDot"), "ok");

      // KPIs
      const { active, total, agents } = computeAgentCounts(data);
      $("kpiAgentHealth").textContent = (total ? `${active}/${total}` : "—");
      $("kpiAgentHealthSub").textContent = "Active agents / total agents";

      const autonomyPct = data?.autonomy_score?.percent ?? data?.autonomy_score?.value;
      const autonomyMode = data?.autonomy_score?.mode || data?.autonomy_model?.system_level || sysMode;
      $("kpiAutonomy").textContent = (typeof autonomyPct === "number" ? fmtPercent(autonomyPct) : (autonomyPct ? String(autonomyPct) : "—"));
      $("kpiAutonomySub").textContent = `Mode: ${safeText(autonomyMode)}`;

      const healthScore = data?.health?.overall_score ?? data?.health?.score ?? null;
      const healthSignal = (data?.health?.signal || "—").toUpperCase();
      $("kpiHealthScore").textContent = fmtScore(healthScore);
      $("kpiHealthScoreSub").textContent = `Signal: ${healthSignal}`;
      setDot($("govDot"), "ok");

      const gateVerdict = (data?.runtime_gate?.verdict || data?.governance?.gate_verdict || "—").toUpperCase();
      $("kpiGovernance").textContent = gateVerdict === "ALLOW" ? "ALLOW" : safeText(gateVerdict);
      $("kpiGovernanceSub").textContent = "Audit trail & gate verdict";

      // Governance bullets (derive from available truth)
      const bullets = [];
      bullets.push(`Health signal is ${healthSignal}`);
      if (healthScore !== null && healthScore !== undefined) bullets.push(`Health score is ${fmtScore(healthScore)}`);
      if (gateVerdict && gateVerdict !== "—") bullets.push(`Governance gate verdict is ${gateVerdict}`);

      const decisionTraceLinked = !!(data?.governance_evidence?.decision_trace?.present ?? data?.governance_evidence?.decision_trace);
      const gateResultLinked = !!(data?.governance_evidence?.gate_result?.present ?? data?.governance_evidence?.gate_result);
      bullets.push(`Decision trace is ${decisionTraceLinked ? "linked (audit trail available)" : "missing"}`);
      bullets.push(`Gate result artifact is ${gateResultLinked ? "linked" : "missing"}`);

      const ul = $("govBullets");
      ul.innerHTML = "";
      for (const b of bullets){
        const li = document.createElement("li");
        li.textContent = b;
        ul.appendChild(li);
      }

      // Core agents list (order preference)
      const order = [
        ["status_agent", "Status Agent"],
        ["george", "GEORGE"],
        ["guardian", "Guardian"],
        ["monitoring", "Monitoring"],
        ["content", "Content"],
        ["deploy_agent", "Deployment Agent"],
        ["consistency", "Consistency"],
        ["deploy", "deploy"],
        ["site_audit", "site_audit"],
        ["status", "status"],
      ];

      const container = $("coreAgents");
      container.innerHTML = "";

      const used = new Set();
      for (const [key, title] of order){
        if (!agents[key]) continue;
        used.add(key);
        const a = { ...agents[key], title };
        container.appendChild(buildAgentCard(key, a));
      }

      // append any remaining agents deterministically
      const restKeys = Object.keys(agents).filter(k => !used.has(k)).sort();
      for (const k of restKeys){
        container.appendChild(buildAgentCard(k, agents[k] || {}));
      }

      // Evidence panel & guard rows
      $("evidenceSource").textContent = STATUS_AGENT_LOG_PATH;

      // Guards (derived from truth source where possible)
      const guards = $("guardsRows");
      guards.innerHTML = "";

      const freshnessKind = fresh.kind;
      guards.appendChild(buildGuardRow("Freshness", `${fresh.label} ago`, freshnessKind, `generated_at: ${safeText(gen)}\ntruth: ${TRUTH_PATH}`));

      const gateKind = gateVerdict === "ALLOW" ? "ok" : (gateVerdict === "DENY" ? "crit" : "warn");
      guards.appendChild(buildGuardRow("Runtime Gate", safeText(gateVerdict), gateKind, `runtime_gate.verdict: ${safeText(gateVerdict)}`));

      const auditKind = (data?.governance_evidence?.audit_trail?.present ?? true) ? "ok" : "warn";
      guards.appendChild(buildGuardRow("Audit Trail", (auditKind === "ok" ? "Available" : "Missing"), auditKind, JSON.stringify(data?.governance_evidence?.audit_trail || {}, null, 2)));

      const dtKind = decisionTraceLinked ? "ok" : "warn";
      guards.appendChild(buildGuardRow("Decision Trace", decisionTraceLinked ? "LINKED" : "MISSING", dtKind, JSON.stringify(data?.governance_evidence?.decision_trace || {}, null, 2)));

      // Status Agent guard - from evidence freshness if present later
      // placeholder until evidence load:
      guards.appendChild(buildGuardRow("Status Agent", "—", "info", "Derived from /ops/agent_activity.jsonl"));

      // Keep some dots aligned
      setDot($("guardsDot"), "ok");
      setDot($("healDot"), "ok");
      $("healLabel").textContent = "GOVERNED";
    }

    async function renderEvidenceAndUpdateGuard(){
      let text;
      try {
        text = await fetchText(STATUS_AGENT_LOG_PATH);
      } catch (e){
        $("evidenceDot").classList.add("crit");
        $("evidenceLabel").textContent = "UNAVAILABLE";
        $("evidenceSource").textContent = STATUS_AGENT_LOG_PATH;
        $("evidenceLastRun").textContent = "—";
        $("evidenceFreshness").textContent = "—";
        $("evidenceLastResult").textContent = "—";
        $("evidenceTotalRuns").textContent = "—";
        $("evidenceFeedState").textContent = "—";
        $("evidenceFeedCount").textContent = "—";
        $("evidenceRows").innerHTML = "";
        return;
      }

      const items = parseJSONL(text, 6);

      // derive last run / total runs heuristically
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const totalRuns = lines.length;

      // last item fields
      const last = items[items.length - 1] || {};
      const lastTs = last.ts || last.time || last.timestamp || "—";
      const lastStatus = (last.status || last.result || "UNKNOWN").toUpperCase();

      $("evidenceLastRun").textContent = safeText(lastTs);
      $("evidenceTotalRuns").textContent = safeText(totalRuns, "0");
      $("evidenceFeedCount").textContent = safeText(items.length, "0");

      // freshness from lastTs (if ISO)
      const fr = freshnessFromISO(lastTs);
      $("evidenceFreshness").textContent = `EXPIRED`.includes(fr.kind.toUpperCase()) ? fr.label : fr.label;
      $("evidenceFreshness").textContent = fr.kind === "crit" ? "EXPIRED" : "OK";

      const lastResultKind =
        lastStatus === "OK" || lastStatus === "PASS" ? "ok" :
        lastStatus === "WARN" ? "warn" :
        lastStatus === "FAIL" || lastStatus === "ERROR" ? "crit" : "info";

      $("evidenceLastResult").textContent = (lastStatus === "OK" || lastStatus === "PASS") ? "PASS" : lastStatus;

      // feed state
      $("evidenceFeedState").textContent = (lastResultKind === "ok") ? "OK" : "UNKNOWN";

      // label badge
      setDot($("evidenceDot"), fr.kind === "crit" ? "crit" : "ok");
      $("evidenceLabel").textContent = fr.kind === "crit" ? "EXPIRED" : "FRESH";

      // rows
      const rows = $("evidenceRows");
      rows.innerHTML = "";
      for (const it of items){
        rows.appendChild(buildEvidenceRow(it));
      }

      // update guards "Status Agent" row (the last guard row we appended)
      const guards = $("guardsRows");
      const lastGuard = guards.lastElementChild; // Status Agent row
      if (lastGuard){
        const labelEl = lastGuard.querySelector(".rowLeft .rowSub");
        const titleEl = lastGuard.querySelector(".rowLeft .rowTitle");
        const pillDot = lastGuard.querySelector(".pill .dot");
        const pillText = lastGuard.querySelector(".pill");

        const statusLabel = (fr.kind === "crit") ? "EXPIRED" : "OK";
        if (titleEl) titleEl.textContent = "Status Agent";
        if (labelEl) labelEl.textContent = statusLabel;

        const kind = (fr.kind === "crit") ? "crit" : "ok";
        if (pillDot) setDot(pillDot, kind);
        if (pillText) pillText.lastChild.nodeValue = statusLabel; // keep dot + text
      }
    }

    async function main(){
      try {
        const data = await fetchJSON(TRUTH_PATH);
        render(data);
      } catch (e){
        showFatal(`Cannot read truth source (${TRUTH_PATH}). ${e.message || e}`);
        return;
      }

      // Evidence is not required to render the page, but improves completeness.
      // Still no simulated operations.
      await renderEvidenceAndUpdateGuard();
    }

    main();
  </script>
</body>
</html>