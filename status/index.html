<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>virtauto.OS — Live System Status</title>

  <link rel="stylesheet" href="/assets/styles.css"/>
  <link rel="stylesheet" href="/assets/styles_unify.css"/>
  <link rel="stylesheet" href="/assets/status.css"/>
</head>

<body class="va-status-page">

<div id="site-header"></div>

<div class="wrap" id="page">

<header class="top">
  <div class="titleRow">
    <h1>
      virtauto.OS — Live System Status
      <span class="badge">TRUTH-LOCKED</span>
    </h1>
  </div>

  <p class="subtitle">
    This dashboard renders exclusively from the Single Source of Truth.
    If the truth source is missing, the UI refuses to display derived values.
  </p>

  <div class="meta">
    <div class="pill"><span class="dot"></span> Agentic Website — Live in Production</div>
    <div class="pill">Truth Source: <strong>system_status.json</strong></div>
    <div class="pill">Freshness: <strong id="freshness">—</strong></div>
  </div>
</header>

<main class="grid">

<section class="card">
  <div class="cardHeader">
    <h2>Core Agents & Layers</h2>
    <span class="statusPill"><span class="dot"></span> ACTIVE · STABILIZATION</span>
  </div>

  <div class="agentsGrid" id="agents-grid"></div>

  <div class="subhead">
    <h3>Status Agent (Evidence)</h3>
    <span class="miniPill ok">OPERATIONAL</span>
  </div>

  <div class="evidence">
    <div class="agentMeta">
      <span>Source:</span>
      <span><code>./ops/agent_activity.jsonl</code></span>
    </div>

    <div class="kvGrid">
      <div class="kv">
        <div class="k">Last Run (UTC)</div>
        <div class="v" id="last-run">—</div>
      </div>
      <div class="kv">
        <div class="k">Freshness</div>
        <div class="v" id="freshness-evidence">—</div>
      </div>
      <div class="kv">
        <div class="k">Last Result</div>
        <div class="v" id="last-result">—</div>
      </div>
      <div class="kv">
        <div class="k">Total Runs</div>
        <div class="v" id="total-runs">—</div>
      </div>
    </div>
  </div>
</section>

<aside class="card">

  <div class="cardHeader">
    <h2>System KPIs</h2>
    <span class="statusPill"><span class="dot"></span> GREEN</span>
  </div>

  <div class="kpiGrid">
    <div class="kpi">
      <div class="kpiLabel">Agent Health</div>
      <div class="kpiValue" id="kpi-agent-health">—</div>
      <div class="kpiNote">Active agents / total agents</div>
    </div>

    <div class="kpi">
      <div class="kpiLabel">Autonomy (confirmed)</div>
      <div class="kpiValue" id="kpi-autonomy">—</div>
      <div class="kpiNote" id="kpi-autonomy-note">Mode: —</div>
    </div>

    <div class="kpi">
      <div class="kpiLabel">Health Score</div>
      <div class="kpiValue" id="kpi-health">—</div>
      <div class="kpiNote" id="kpi-health-note">Signal: —</div>
    </div>

    <div class="kpi">
      <div class="kpiLabel">Governance</div>
      <div class="kpiValue">ENFORCED</div>
      <div class="kpiNote">Gate + Audit trail</div>
    </div>
  </div>

</aside>

</main>

<footer>
  Status page generated by <span>virtauto.OS</span>
</footer>

</div>

<script>

const TRUTH_PATH = "./ops/reports/system_status.json";

function $(id){ return document.getElementById(id); }

function normalize(v){ return (v ?? "").toString().toUpperCase(); }

/* ------------------------------
   CLEAN AGENT COUNTING FIX
--------------------------------*/

const NON_NORMATIVE_AGENT_KEYS = new Set([
  "status",
  "deploy"
]);

function countAgents(agentsObj){
  const keys = Object.keys(agentsObj || {})
    .filter(k => !NON_NORMATIVE_AGENT_KEYS.has(k));

  const active = keys.filter(k => {
    const a = agentsObj[k] || {};
    return normalize(a.state) === "ACTIVE";
  });

  return { total: keys.length, active: active.length };
}

/* ------------------------------ */

async function boot(){
  const res = await fetch(TRUTH_PATH + "?t=" + Date.now(), {cache:"no-store"});
  const status = await res.json();

  const generated = status.generated_at;
  if(generated){
    const ageMin = Math.round((Date.now() - new Date(generated).getTime()) / 60000);
    $("freshness").textContent = ageMin + " min ago";
  }

  const agents = status.agents || {};
  const {total, active} = countAgents(agents);
  $("kpi-agent-health").textContent = active + " / " + total;

  const autonomy = status.autonomy_score || {};
  $("kpi-autonomy").textContent =
    autonomy.percent ? autonomy.percent.toFixed(1) + "%" : "—";

  $("kpi-autonomy-note").textContent =
    "Mode: " + (status.system?.autonomy_mode || "—");

  $("kpi-health").textContent =
    status.health?.overall_score
      ? (status.health.overall_score * 100).toFixed(1) + "%"
      : "—";

  $("kpi-health-note").textContent =
    "Signal: " + (status.health?.signal || "—");

}

boot();

</script>

<script src="/assets/header_include.js" defer></script>
<script src="/assets/site.js" defer></script>

</body>
</html>