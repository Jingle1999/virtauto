<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>virtauto.OS — Live System Status</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="stylesheet" href="/assets/styles_unify.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --card-bg: #0b1020;
      --accent: #8b5cf6;
      --accent-soft: rgba(139, 92, 246, 0.1);
      --ok: #22c55e;
      --warn: #f59e0b;
      --crit: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      padding: 2.5rem 1.5rem 3rem;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
    }

    .status-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 2.5rem;
      min-width: 0;
    }

    .status-header h1 {
      font-size: 2rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      min-width: 0;
    }

    .status-header h1 span.badge {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      background: var(--accent-soft);
      border: 1px solid rgba(139, 92, 246, 0.4);
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      color: var(--accent);
      white-space: nowrap;
    }

    .status-header p {
      max-width: 740px;
      font-size: 0.95rem;
      color: var(--muted);
      line-height: 1.45;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 2rem;
      min-width: 0;
    }

    .meta-pill {
      font-size: 0.8rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--muted);
      min-width: 0;
      max-width: 100%;
    }

    .meta-pill strong {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 48vw;
      display: inline-block;
      vertical-align: bottom;
    }

    .meta-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      flex: 0 0 auto;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.4fr);
      gap: 1.5rem;
      align-items: start;
      min-width: 0;
    }

    @media (max-width: 1040px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: 1.1rem;
      border: 1px solid var(--border);
      padding: 1.3rem 1.4rem 1.3rem;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      min-width: 0;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      gap: 0.75rem;
      min-width: 0;
    }

    .card-header h2 {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .status-pill {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: var(--text);
      white-space: nowrap;
      flex: 0 0 auto;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-pill span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--ok);
      flex: 0 0 auto;
    }
    .status-pill.warn span.dot { background: var(--warn); }
    .status-pill.crit span.dot { background: var(--crit); }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.85rem;
      min-width: 0;
    }

    .status-card {
      border-radius: 0.9rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 0.8rem 0.9rem;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.85)
      );
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-height: 132px;
      min-width: 0;
      overflow: hidden;
    }

    .status-title-row {
      display: flex;
      justify-content: space-between;
      gap: 0.55rem;
      align-items: flex-start;
      min-width: 0;
    }

    .status-title {
      font-size: 0.9rem;
      font-weight: 600;
      min-width: 0;
      overflow-wrap: anywhere;
      line-height: 1.15;
    }

    .status-chip {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--muted);
      white-space: nowrap;
      flex: 0 0 auto;
      max-width: 58%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-chip.ok { border-color: rgba(34, 197, 94, 0.65); color: #bbf7d0; }
    .status-chip.warn { border-color: rgba(245, 158, 11, 0.75); color: #fed7aa; }
    .status-chip.crit { border-color: rgba(239, 68, 68, 0.75); color: #fecaca; }
    .status-chip.soon { border-style: dashed; border-color: rgba(148, 163, 184, 0.7); color: var(--muted); }

    .status-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.6rem;
      font-size: 0.7rem;
      color: var(--muted);
      min-width: 0;
    }

    .status-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.2rem;
      line-height: 1.3;
      overflow-wrap: anywhere;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.7rem;
      min-width: 0;
    }

    .kpi {
      border-radius: 0.85rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, #111827 0, #020617 70%);
      padding: 0.7rem 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      min-width: 0;
      overflow: hidden;
    }

    .kpi-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .kpi-value {
      font-size: 1.1rem;
      font-weight: 600;
      min-width: 0;
      overflow-wrap: anywhere;
    }

    .kpi-footnote {
      font-size: 0.7rem;
      color: var(--muted);
      line-height: 1.35;
      overflow-wrap: anywhere;
    }

    .truth-box {
      margin-top: 1.1rem;
      padding: 0.75rem 0.85rem;
      border-radius: 0.85rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.75);
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.45;
      min-width: 0;
      overflow: hidden;
    }

    .truth-box code {
      color: #c4b5fd;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.75rem;
      overflow-wrap: anywhere;
    }

    .guards {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--text);
      min-width: 0;
    }

    .guard-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.55rem 0.7rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.7);
      min-width: 0;
    }

    .guard-left {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 0;
    }

    .guard-name {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .guard-value {
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--text);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 46vw;
    }

    .guard-pill {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      white-space: nowrap;
      flex: 0 0 auto;
      max-width: 44%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .guard-pill.ok { border-color: rgba(34, 197, 94, 0.65); color: #bbf7d0; }
    .guard-pill.warn { border-color: rgba(245, 158, 11, 0.75); color: #fed7aa; }
    .guard-pill.crit { border-color: rgba(239, 68, 68, 0.75); color: #fecaca; }

    footer {
      margin-top: 2rem;
      font-size: 0.7rem;
      color: var(--muted);
      text-align: right;
    }

    footer span { color: var(--accent); }

    /* hard-fail overlay (truth lock) */
    .fatal {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.92);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .fatal-inner {
      max-width: 760px;
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(239, 68, 68, 0.45);
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 22px 60px rgba(0,0,0,0.6);
      padding: 18px 18px 16px;
    }
    .fatal-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      min-width: 0;
    }
    .fatal-title h3 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #fecaca;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .fatal-pill {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(239, 68, 68, 0.55);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.08);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .fatal p {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      margin-top: 8px;
    }
    .fatal code {
      display: block;
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(2, 6, 23, 0.7);
      color: #c4b5fd;
      font-size: 12px;
      overflow-x: auto;
    }

    /* =========================
       Status Agent Evidence UI
       ========================= */
    .subhead {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      margin-top: 1.1rem;
      margin-bottom: .6rem;
      min-width:0;
    }
    .subhead h3 {
      font-size: .85rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--muted);
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .mini-pill {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      white-space: nowrap;
      flex: 0 0 auto;
      max-width: 48%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mini-pill.ok { border-color: rgba(34, 197, 94, 0.65); color: #bbf7d0; }
    .mini-pill.warn { border-color: rgba(245, 158, 11, 0.75); color: #fed7aa; }
    .mini-pill.crit { border-color: rgba(239, 68, 68, 0.75); color: #fecaca; }

    .agent-evidence {
      border-radius: 0.9rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 0.85rem 0.9rem;
      background: rgba(15, 23, 42, 0.72);
      min-width:0;
      overflow:hidden;
    }

    .agent-evidence-grid {
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .55rem .7rem;
      margin-top: .55rem;
      min-width:0;
    }

    .kv {
      border-radius: .75rem;
      border: 1px solid rgba(55, 65, 81, 0.85);
      background: rgba(15, 23, 42, 0.55);
      padding: .55rem .6rem;
      min-width:0;
      overflow:hidden;
    }
    .kv .k {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kv .v {
      font-size: .95rem;
      font-weight: 600;
      margin-top: .15rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kv .v code {
      color:#c4b5fd;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: .82rem;
    }

    .feed {
      margin-top: .75rem;
      border-top: 1px solid rgba(55,65,81,0.7);
      padding-top: .65rem;
      display:flex;
      flex-direction:column;
      gap:.4rem;
      min-width:0;
    }

    .feed-item {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.75rem;
      padding:.5rem .55rem;
      border-radius:.75rem;
      border: 1px solid rgba(55, 65, 81, 0.75);
      background: rgba(2, 6, 23, 0.35);
      min-width:0;
      overflow:hidden;
    }
    .feed-left { min-width:0; }
    .feed-left .t {
      font-size:.78rem;
      color: var(--text);
      font-weight: 600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 58vw;
    }
    .feed-left .m {
      font-size:.72rem;
      color: var(--muted);
      margin-top:.12rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 58vw;
    }
    .feed-right {
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:.18rem .45rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      color: var(--muted);
      white-space:nowrap;
      flex:0 0 auto;
      max-width: 40%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .feed-right.ok { border-color: rgba(34,197,94,0.65); color:#bbf7d0; }
    .feed-right.warn { border-color: rgba(245,158,11,0.75); color:#fed7aa; }
    .feed-right.crit { border-color: rgba(239,68,68,0.75); color:#fecaca; }

    .evidence-note {
      margin-top: .55rem;
      font-size: .75rem;
      color: var(--muted);
      line-height: 1.4;
      overflow-wrap:anywhere;
    }
    .evidence-note code {
      color:#c4b5fd;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: .75rem;
    }
  </style>
</head>
<body>
  <div id="site-header"></div>
  <div class="fatal" id="fatal">
    <div class="fatal-inner">
      <div class="fatal-title">
        <h3>Truth Lock Failure</h3>
        <span class="fatal-pill">STATUS UNAVAILABLE</span>
      </div>
      <p>
        The status page is required to read exclusively from the Single Source of Truth.
        The truth source could not be loaded, therefore this page refuses to display any derived values.
      </p>
      <p><strong>Expected truth source:</strong> <code id="fatal-src"></code></p>
      <p><strong>Error:</strong> <code id="fatal-err"></code></p>
    </div>
  </div>

  <div class="page" id="page">
    <div class="status-header">
      <h1>
        virtauto.OS — Live System Status
        <span class="badge">TRUTH-LOCKED</span>
      </h1>
      <p>
        This dashboard is the single authoritative interface for the operational state of
        <strong>www.virtauto.de</strong>.
        Every value on this page is rendered from the Single Source of Truth and refuses to show if the truth source is missing.
      </p>
      <div class="meta-row">
        <div class="meta-pill">
          <span class="meta-dot"></span>
          Agentic Website — Live in Production
        </div>
        <div class="meta-pill">Truth Source: <strong id="truth-source">—</strong></div>
        <div class="meta-pill">Freshness: <strong id="freshness">—</strong></div>
      </div>
    </div>

    <main>
      <!-- LEFT: AGENTS & LAYERS -->
      <section class="card">
        <div class="card-header">
          <h2>Core Agents & Layers</h2>
          <span class="status-pill" id="system-pill">
            <span class="dot"></span>
            System —
          </span>
        </div>

        <div class="status-grid" id="agents-grid">
          <!-- populated by JS (truth-locked) -->
        </div>

        <!-- =========================
             STATUS AGENT (EVIDENCE)
             ========================= -->
        <div class="subhead">
          <h3>Status Agent (Evidence)</h3>
          <span class="mini-pill" id="status-agent-pill">UNKNOWN</span>
        </div>

        <div class="agent-evidence" aria-label="Status Agent evidence panel">
          <div class="status-meta">
            <span>Source:</span>
            <span><code id="status-agent-source">—</code></span>
          </div>

          <div class="agent-evidence-grid">
            <div class="kv">
              <div class="k">Last Run (UTC)</div>
              <div class="v" id="status-agent-last">—</div>
            </div>
            <div class="kv">
              <div class="k">Freshness</div>
              <div class="v" id="status-agent-freshness">—</div>
            </div>
            <div class="kv">
              <div class="k">Last Result</div>
              <div class="v" id="status-agent-result">—</div>
            </div>
            <div class="kv">
              <div class="k">Total Runs</div>
              <div class="v" id="status-agent-ops">—</div>
            </div>
          </div>

          <div class="feed" id="status-agent-feed" aria-label="Status Agent recent activity">
            <!-- populated by JS from JSONL -->
          </div>

          <div class="evidence-note" id="status-agent-note">
            This panel displays <strong>server-side evidence</strong> produced by the Status Agent.
            The browser does not generate operations.
          </div>
        </div>
      </section>

      <!-- RIGHT: KPIs + PIPELINES & GUARDS -->
      <aside class="card">
        <div class="card-header">
          <h2>System KPIs</h2>
          <span class="status-pill warn" id="launch-pill">
            <span class="dot"></span>
            Live Snapshot
          </span>
        </div>

        <div class="kpi-grid">
          <div class="kpi">
            <div class="kpi-label">Agent Health</div>
            <div class="kpi-value" id="kpi-agent-health">—</div>
            <div class="kpi-footnote" id="kpi-agent-health-note">Active agents / total agents</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">Autonomy (confirmed)</div>
            <div class="kpi-value" id="kpi-autonomy">—</div>
            <div class="kpi-footnote" id="kpi-autonomy-note">Mode: —</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">Health Score</div>
            <div class="kpi-value" id="kpi-health">—</div>
            <div class="kpi-footnote" id="kpi-health-note">Signal: —</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">Governance</div>
            <div class="kpi-value" id="kpi-governance">—</div>
            <div class="kpi-footnote" id="kpi-governance-note">Audit trail & gate verdict</div>
          </div>
        </div>

        <div class="truth-box" id="truth-box">
          <div><strong>Truth lock:</strong> This page reads from <code id="truth-path">—</code></div>
          <div><strong>Generated at:</strong> <span id="generated-at">—</span></div>
          <div><strong>Environment:</strong> <span id="environment">—</span></div>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 1.2rem 0;" />

        <div class="card-header" style="margin-bottom: 0.7rem;">
          <h2>Pipelines & Guards</h2>
          <span class="status-pill" id="guards-pill">
            <span class="dot"></span>
            Truth Locked
          </span>
        </div>

        <div class="guards">
          <div class="guard-row">
            <div class="guard-left">
              <div class="guard-name">Freshness</div>
              <div class="guard-value" id="guard-freshness">—</div>
            </div>
            <span class="guard-pill" id="guard-freshness-pill">—</span>
          </div>

          <div class="guard-row">
            <div class="guard-left">
              <div class="guard-name">Runtime Gate</div>
              <div class="guard-value" id="guard-gate">—</div>
            </div>
            <span class="guard-pill" id="guard-gate-pill">—</span>
          </div>

          <div class="guard-row">
            <div class="guard-left">
              <div class="guard-name">Audit Trail</div>
              <div class="guard-value" id="guard-audit">—</div>
            </div>
            <span class="guard-pill" id="guard-audit-pill">—</span>
          </div>

          <div class="guard-row">
            <div class="guard-left">
              <div class="guard-name">Decision Trace</div>
              <div class="guard-value" id="guard-trace">—</div>
            </div>
            <span class="guard-pill" id="guard-trace-pill">—</span>
          </div>

          <!-- NEW: Status Agent guard -->
          <div class="guard-row">
            <div class="guard-left">
              <div class="guard-name">Status Agent</div>
              <div class="guard-value" id="guard-status-agent">—</div>
            </div>
            <span class="guard-pill" id="guard-status-agent-pill">—</span>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      Status page generated by <span>virtauto.OS</span> — single source of truth.
    </footer>
  </div>

<script>
  
  // =========================
  // TRUTH SOURCE (Single Source of Truth)
  // =========================
  // IMPORTANT: GitHub Pages serves files from /status/... (not from /ops/...).
  // Use relative paths so it works on any domain/base path.
  const TRUTH_PATH = "./ops/reports/system_status.json";

  // Status Agent evidence source (server-produced JSONL)
  // NOTE: This panel renders evidence; it does not generate operations.
  const STATUS_AGENT_LOG_PATH = "/status/ops/agent_activity.jsonl";
  // =========================
  // Helpers
  // =========================
  function $(id) { return document.getElementById(id); }

  function safeUpper(v) {
    return (v === undefined || v === null) ? "—" : String(v).toUpperCase();
  }

  function fmtPctFrom(valueOrPct) {
    if (valueOrPct === undefined || valueOrPct === null) return "—";
    const n = Number(valueOrPct);
    if (!Number.isFinite(n)) return "—";
    const pct = (n <= 1) ? (n * 100) : n;
    return pct.toFixed(1) + "%";
  }

  function fmtDate(iso) {
    if (!iso) return "—";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return String(iso);
    return d.toISOString().slice(0, 19).replace("T", " ");
  }

  function classifyPillBySignal(signal) {
    const s = String(signal || "").toUpperCase();
    if (s.includes("RED") || s.includes("CRIT") || s.includes("FAIL")) return "crit";
    if (s.includes("YELLOW") || s.includes("WARN") || s.includes("DEGRADED") || s.includes("REVIEW")) return "warn";
    return "";
  }

  function chipClassForState(state) {
    const s = String(state || "").toUpperCase();
    if (s === "ACTIVE" || s === "OK" || s === "GREEN" || s === "ONLINE" || s === "INITIALIZED") return "ok";
    if (s === "PLANNED" || s === "MVP" || s === "IN_PROGRESS" || s === "UNKNOWN" || s === "SUPERVISED" || s === "MANUAL") return "warn";
    if (s === "FAIL" || s === "FAILED" || s === "DOWN" || s === "CRITICAL" || s === "ISSUE") return "crit";
    return "soon";
  }

  function setGuardPill(el, kind) {
    el.classList.remove("ok", "warn", "crit");
    if (kind) el.classList.add(kind);
  }

  function setMiniPill(el, kind) {
    el.classList.remove("ok", "warn", "crit");
    if (kind) el.classList.add(kind);
  }

  function showFatal(err) {
    $("fatal-src").textContent = TRUTH_PATH;
    $("fatal-err").textContent = String(err && err.message ? err.message : err);
    $("fatal").style.display = "flex";
    $("page").style.display = "none";
  }

  async function fetchTruth() {
    const res = await fetch(TRUTH_PATH, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to load truth source (${res.status}) at ${TRUTH_PATH}`);
    const json = await res.json();
    if (!json || typeof json !== "object") throw new Error("Truth source returned invalid JSON.");
    return json;
  }

  async function fetchText(path) {
    const res = await fetch(path, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to load evidence source (${res.status}) at ${path}`);
    return await res.text();
  }

  function parseJSONL(text) {
    const lines = String(text || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const out = [];
    for (const line of lines) {
      try {
        const obj = JSON.parse(line);
        if (obj && typeof obj === "object") out.push(obj);
      } catch (_) {
        // ignore malformed lines (truth: they simply don't parse)
      }
    }
    return out;
  }

  function minutesAgo(iso) {
    if (!iso) return null;
    const t = new Date(iso).getTime();
    if (!Number.isFinite(t)) return null;
    const diff = Date.now() - t;
    return Math.max(0, Math.round(diff / 60000));
  }

  function classifyFreshness(mins) {
    // thresholds per plan: <45 OK, 45-90 WARN, >90 CRIT
    if (mins === null) return { label: "UNKNOWN", kind: "warn" };
    if (mins < 45) return { label: "OPERATIONAL", kind: "ok" };
    if (mins <= 90) return { label: "STALE", kind: "warn" };
    return { label: "OFFLINE", kind: "crit" };
  }

  function briefResultTag(r) {
    const s = String(r || "").toUpperCase();
    if (s.includes("PASS") || s.includes("OK")) return { text: "PASS", kind: "ok" };
    if (s.includes("WARN") || s.includes("REVIEW") || s.includes("STALE")) return { text: "WARN", kind: "warn" };
    if (s.includes("FAIL") || s.includes("CRIT") || s.includes("ERROR")) return { text: "FAIL", kind: "crit" };
    return { text: s || "UNKNOWN", kind: "warn" };
  }

  // =========================
  // Rendering
  // =========================
  function renderHeader(status) {
    $("truth-source").textContent = "system_status.json";
    $("truth-path").textContent = TRUTH_PATH;

    const generatedAt = status.generated_at || status.generatedAt || status.timestamp || null;
    $("freshness").textContent = generatedAt ? fmtDate(generatedAt) : "—";

    $("generated-at").textContent = generatedAt ? fmtDate(generatedAt) : "—";
    $("environment").textContent = status.environment || "—";

    const sysState =
      (status.system && status.system.state) ||
      (status.system_state && status.system_state.state) ||
      status.system_state ||
      "—";

    const sysMode =
      (status.system && status.system.mode) ||
      status.mode ||
      "—";

    const signal = (status.health && status.health.signal) || "—";
    const pill = $("system-pill");
    pill.classList.remove("warn", "crit");
    const cls = classifyPillBySignal(signal);
    if (cls) pill.classList.add(cls);

    pill.textContent = "";
    const dot = document.createElement("span");
    dot.className = "dot";
    pill.appendChild(dot);
    pill.appendChild(document.createTextNode(` ${safeUpper(sysState)} · ${safeUpper(sysMode)}`));
  }

  function renderKPIs(status) {
    const agentsObj = status.agents || {};
    const agentKeys = Object.keys(agentsObj);
    const total = agentKeys.length || 0;
    let active = 0;

    for (const k of agentKeys) {
      const st = (agentsObj[k] && (agentsObj[k].state || agentsObj[k].status)) || "";
      if (String(st).toUpperCase() === "ACTIVE") active++;
    }

    $("kpi-agent-health").textContent = total ? `${active} / ${total}` : "—";

    const autonomyObj = status.autonomy_score || status.autonomy || {};
    const autonomyMode =
      (status.system && status.system.autonomy_mode) ||
      (autonomyObj && autonomyObj.mode) ||
      (status.system && status.system.autonomy) ||
      "—";

    const autonomyPct =
      (autonomyObj && (autonomyObj.percent ?? autonomyObj.value ?? autonomyObj.current_level)) ??
      (status.autonomy && status.autonomy.current_level) ??
      null;

    $("kpi-autonomy").textContent = fmtPctFrom(autonomyPct);
    $("kpi-autonomy-note").textContent = `Mode: ${safeUpper(autonomyMode)}`;

    const healthOverall = (status.health && (status.health.overall_score || status.health.score)) || null;
    const healthSignal = (status.health && status.health.signal) || "—";
    $("kpi-health").textContent = fmtPctFrom(healthOverall);
    $("kpi-health-note").textContent = `Signal: ${safeUpper(healthSignal)}`;

    const gateVerdict =
      (autonomyObj && autonomyObj.gate_verdict) ||
      (status.autonomy && status.autonomy.gate_verdict) ||
      (status.gate && status.gate.verdict) ||
      "—";

    const links = status.links || {};
    const auditTrailAvailable = Boolean(links.decision_trace || links.decision_trace_jsonl || links.latest_decision);
    const governanceValue = auditTrailAvailable ? "ENFORCED" : "LIMITED";
    $("kpi-governance").textContent = governanceValue;
    $("kpi-governance-note").textContent = `Gate: ${safeUpper(gateVerdict)} · Audit: ${auditTrailAvailable ? "AVAILABLE" : "MISSING"}`;

    const lp = $("launch-pill");
    lp.classList.remove("warn", "crit");
    const cls = classifyPillBySignal(healthSignal);
    if (cls) lp.classList.add(cls);

    lp.textContent = "";
    const dot = document.createElement("span");
    dot.className = "dot";
    lp.appendChild(dot);
    lp.appendChild(document.createTextNode(` ${safeUpper(healthSignal)}`));
  }

  function renderAgents(status) {
    const agents = status.agents || {};
    const grid = $("agents-grid");
    grid.innerHTML = "";

    const order = [
      ["guardian", "Self-Guardian", ["Security", "Policy checks", "Guardrails"],
        "Monitors every change, applies Guardian rules and blocks unsafe updates before they reach production."],
      ["monitoring", "Self-Monitoring", ["Workflow logs", "Status signals"],
        "Tracks CI/CD runs, agent activity and basic system health across orchestration runs."],
      ["content", "Self-Content Agent", ["Draft generation", "Pull request content"],
        "Generates content drafts and change proposals as pull requests for human-in-the-loop review."],
      ["george", "GEORGE Orchestrator", ["Event routing", "Agent registry"],
        "Coordinates when which agent should run. Orchestration is enforced through deterministic rules and traceability."],
      ["site_audit", "Site Audit", ["Evidence", "Controls", "Links"],
        "Verifies site integrity and governance signals. Surfaces audit-relevant evidence for review."],
      ["deploy_agent", "Deploy Agent", ["Safe rollout", "Rollback"],
        "Handles guarded deployments and rollback paths when enabled by authority and gate conditions."]
    ];

    const used = new Set();

    for (const [key, title, meta, note] of order) {
      if (!agents[key]) continue;
      used.add(key);

      const state = agents[key].state || agents[key].status || "UNKNOWN";
      const mode = agents[key].autonomy_mode || agents[key].autonomy || "";
      const chipText = mode ? `${state} · ${mode}` : `${state}`;
      const cls = chipClassForState(state);

      const article = document.createElement("article");
      article.className = "status-card";
      article.innerHTML = `
        <div class="status-title-row">
          <div class="status-title">${title}</div>
          <div class="status-chip ${cls}" title="${safeUpper(chipText)}">${safeUpper(chipText)}</div>
        </div>
        <div class="status-meta">${meta.map(m => `<span>${m}</span>`).join("")}</div>
        <p class="status-note">${note}</p>
      `;
      grid.appendChild(article);
    }

    for (const key of Object.keys(agents)) {
      if (used.has(key)) continue;
      const a = agents[key] || {};
      const state = a.state || a.status || "UNKNOWN";
      const mode = a.autonomy_mode || a.autonomy || "";
      const chipText = mode ? `${state} · ${mode}` : `${state}`;
      const cls = chipClassForState(state);

      const article = document.createElement("article");
      article.className = "status-card";
      article.innerHTML = `
        <div class="status-title-row">
          <div class="status-title">${key}</div>
          <div class="status-chip ${cls}" title="${safeUpper(chipText)}">${safeUpper(chipText)}</div>
        </div>
        <div class="status-meta"><span>Agent</span><span>Truth locked</span></div>
        <p class="status-note">Status rendered from system_status.json.</p>
      `;
      grid.appendChild(article);
    }

    if (!Object.keys(agents).length) {
      const article = document.createElement("article");
      article.className = "status-card";
      article.innerHTML = `
        <div class="status-title-row">
          <div class="status-title">Agents</div>
          <div class="status-chip warn">UNKNOWN</div>
        </div>
        <div class="status-meta"><span>No agent map found</span></div>
        <p class="status-note">system_status.json contains no "agents" object.</p>
      `;
      grid.appendChild(article);
    }
  }

  function renderGuards(status) {
    const generatedAt = status.generated_at || status.generatedAt || status.timestamp || null;
    const now = Date.now();
    const ts = generatedAt ? new Date(generatedAt).getTime() : NaN;
    const ageMin = Number.isFinite(ts) ? Math.max(0, Math.round((now - ts) / 60000)) : null;

    if (ageMin === null) {
      $("guard-freshness").textContent = "—";
      $("guard-freshness-pill").textContent = "UNKNOWN";
      setGuardPill($("guard-freshness-pill"), "warn");
    } else {
      $("guard-freshness").textContent = `${ageMin} min ago`;
      if (ageMin <= 15) { $("guard-freshness-pill").textContent = "FRESH"; setGuardPill($("guard-freshness-pill"), "ok"); }
      else if (ageMin <= 60) { $("guard-freshness-pill").textContent = "STALE"; setGuardPill($("guard-freshness-pill"), "warn"); }
      else { $("guard-freshness-pill").textContent = "EXPIRED"; setGuardPill($("guard-freshness-pill"), "crit"); }
    }

    const autonomyObj = status.autonomy_score || status.autonomy || {};
    const gate = (autonomyObj && autonomyObj.gate_verdict) || (status.gate && status.gate.verdict) || "—";
    $("guard-gate").textContent = safeUpper(gate);
    if (String(gate).toUpperCase().includes("ALLOW") || String(gate).toUpperCase().includes("PASS")) {
      $("guard-gate-pill").textContent = "PASS";
      setGuardPill($("guard-gate-pill"), "ok");
    } else if (gate === "—") {
      $("guard-gate-pill").textContent = "UNKNOWN";
      setGuardPill($("guard-gate-pill"), "warn");
    } else {
      $("guard-gate-pill").textContent = "BLOCK";
      setGuardPill($("guard-gate-pill"), "crit");
    }

    const links = status.links || {};
    const auditAvail = Boolean(links.latest_decision || links.decision_trace || links.decision_trace_jsonl);
    $("guard-audit").textContent = auditAvail ? "Available" : "Missing";
    $("guard-audit-pill").textContent = auditAvail ? "OK" : "MISSING";
    setGuardPill($("guard-audit-pill"), auditAvail ? "ok" : "warn");

    const trace = links.decision_trace || links.decision_trace_jsonl || null;
    $("guard-trace").textContent = trace ? String(trace) : "—";
    if (trace) { $("guard-trace-pill").textContent = "LINKED"; setGuardPill($("guard-trace-pill"), "ok"); }
    else { $("guard-trace-pill").textContent = "UNLINKED"; setGuardPill($("guard-trace-pill"), "warn"); }
  }

  function renderStatusAgentEvidence(events, loadError) {
    $("status-agent-source").textContent = STATUS_AGENT_LOG_PATH;

    const pill = $("status-agent-pill");
    const feed = $("status-agent-feed");

    // default state
    $("status-agent-last").textContent = "—";
    $("status-agent-freshness").textContent = "—";
    $("status-agent-result").textContent = "—";
    $("status-agent-ops").textContent = "—";
    feed.innerHTML = "";

    if (loadError) {
      pill.textContent = "MISSING";
      setMiniPill(pill, "warn");

      $("status-agent-note").innerHTML =
        `Evidence source missing or unreadable: <code>${STATUS_AGENT_LOG_PATH}</code>. ` +
        `This is not simulated in the browser.`;
      // Guard mirror
      $("guard-status-agent").textContent = "Evidence source missing";
      $("guard-status-agent-pill").textContent = "MISSING";
      setGuardPill($("guard-status-agent-pill"), "warn");
      return;
    }

    // Filter only status_agent lines
    const statusEvents = (events || []).filter(e => String(e.agent || "").toLowerCase() === "status_agent");
    const total = statusEvents.length;

    if (!total) {
      pill.textContent = "NO DATA";
      setMiniPill(pill, "warn");

      $("status-agent-ops").textContent = "0";
      $("status-agent-note").innerHTML =
        `Evidence loaded, but no <code>{"agent":"status_agent"}</code> events found.`;
      // Guard mirror
      $("guard-status-agent").textContent = "No status_agent events";
      $("guard-status-agent-pill").textContent = "NO DATA";
      setGuardPill($("guard-status-agent-pill"), "warn");
      return;
    }

    // Latest by timestamp (descending)
    statusEvents.sort((a,b) => {
      const ta = new Date(a.timestamp || 0).getTime();
      const tb = new Date(b.timestamp || 0).getTime();
      return (Number.isFinite(tb) ? tb : 0) - (Number.isFinite(ta) ? ta : 0);
    });

    const latest = statusEvents[0];
    const lastIso = latest.timestamp || null;
    const age = minutesAgo(lastIso);
    const freshness = classifyFreshness(age);

    pill.textContent = freshness.label;
    setMiniPill(pill, freshness.kind);

    $("status-agent-last").textContent = lastIso ? fmtDate(lastIso) : "—";
    $("status-agent-freshness").textContent = (age === null) ? "—" : `${age} min ago`;
    $("status-agent-ops").textContent = String(total);

    const rr = briefResultTag(latest.result || latest.status || "");
    $("status-agent-result").textContent = rr.text;

    // Guard mirror (right side)
    $("guard-status-agent").textContent =
      (age === null) ? "—" : `${freshness.label} · ${age} min`;
    $("guard-status-agent-pill").textContent = freshness.label;
    setGuardPill($("guard-status-agent-pill"), freshness.kind);

    // Render last 6 events
    const slice = statusEvents.slice(0, 6);
    for (const e of slice) {
      const ts = e.timestamp ? fmtDate(e.timestamp) : "—";
      const op = String(e.operation || "operation").replace(/_/g, " ");
      const tag = briefResultTag(e.result || e.status || "UNKNOWN");

      // short evidence summary (non-sensitive)
      let evidenceSummary = "";
      if (e.evidence && typeof e.evidence === "object") {
        const pairs = [];
        if ("system_health" in e.evidence) pairs.push(`health=${String(e.evidence.system_health)}`);
        if ("governance" in e.evidence) pairs.push(`governance=${String(e.evidence.governance)}`);
        if ("decision_trace" in e.evidence) pairs.push(`trace=${e.evidence.decision_trace ? "yes" : "no"}`);
        evidenceSummary = pairs.length ? pairs.join(" · ") : "";
      }

      const item = document.createElement("div");
      item.className = "feed-item";
      item.innerHTML = `
        <div class="feed-left">
          <div class="t">[${ts} UTC] Status Agent — ${op}</div>
          <div class="m">${evidenceSummary || "Evidence recorded."}</div>
        </div>
        <div class="feed-right ${tag.kind}">${tag.text}</div>
      `;
      feed.appendChild(item);
    }

    $("status-agent-note").innerHTML =
      `Rendered from <code>${STATUS_AGENT_LOG_PATH}</code>. No client-side timers, no simulated operations.`;
  }

  // =========================
  // Boot
  // =========================
  (async function boot() {
    try {
      const status = await fetchTruth();
      renderHeader(status);
      renderKPIs(status);
      renderAgents(status);
      renderGuards(status);

      // Status Agent evidence is optional to the page’s existence,
      // but it never simulates: missing evidence is shown as missing.
      try {
        const txt = await fetchText(STATUS_AGENT_LOG_PATH);
        const events = parseJSONL(txt);
        renderStatusAgentEvidence(events, null);
      } catch (e) {
        console.warn(e);
        renderStatusAgentEvidence([], e);
      }
    } catch (err) {
      console.error(err);
      showFatal(err);
    }
  })();
</script>
  <script src="/assets/header_include.js" defer></script>
  <script src="/assets/site.js" defer></script>
</body>
</html>
