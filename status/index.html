<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>virtauto.OS — Live System Status</title>

  <!-- virtauto theme (global) -->
  <link rel="stylesheet" href="/assets/styles.css"/>
  <link rel="stylesheet" href="/assets/styles_unify.css"/>

  <!-- status page (scoped, no side effects) -->
  <link rel="stylesheet" href="/assets/status.css"/>
</head>

<body class="va-status-page">
  <!-- header/nav injection -->
  <div id="site-header"></div>

  <!-- TRUTH LOCK FAILURE OVERLAY -->
  <div class="fatal" id="fatal" aria-live="polite" aria-label="Truth lock failure overlay">
    <div class="fatalInner">
      <div class="fatalTitle">
        <h3>Truth Lock Failure</h3>
        <span class="fatalPill">STATUS UNAVAILABLE</span>
      </div>
      <p>
        The status page is required to read exclusively from the Single Source of Truth.
        The truth source could not be loaded, therefore this page refuses to display any derived values.
      </p>
      <p><strong>Expected truth source:</strong> <code id="fatal-src">—</code></p>
      <p><strong>Error:</strong> <code id="fatal-err">—</code></p>
    </div>
  </div>

  <div class="wrap" id="page">
    <header class="top">
      <div class="titleRow">
        <h1>
          virtauto.OS — Live System Status
          <span class="badge">TRUTH-LOCKED</span>
        </h1>
      </div>

      <p class="subtitle">
        This dashboard is the single authoritative interface for the operational state of
        <strong>www.virtauto.de</strong>.
        Every value on this page is rendered from the Single Source of Truth and refuses to show if the truth source is missing.
      </p>

      <div class="meta" aria-label="Status meta">
        <div class="pill"><span class="dot"></span> Agentic Website — Live in Production</div>
        <div class="pill">Truth Source: <strong id="truth-source">—</strong></div>
        <div class="pill">Freshness: <strong id="freshness">—</strong></div>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT: AGENTS + EVIDENCE -->
      <section class="card" aria-label="Core Agents & Layers">
        <div class="cardHeader">
          <h2>Core Agents & Layers</h2>
          <span class="statusPill" id="system-pill"><span class="dot"></span> System —</span>
        </div>

        <div class="agentsGrid" id="agents-grid" aria-label="Agents grid">
          <!-- populated by JS -->
        </div>

        <!-- STATUS AGENT EVIDENCE -->
        <div class="subhead">
          <h3>Status Agent (Evidence)</h3>
          <span class="miniPill" id="status-agent-pill">UNKNOWN</span>
        </div>

        <div class="evidence" aria-label="Status Agent evidence panel">
          <div class="agentMeta" style="margin-bottom: 8px;">
            <span>Source:</span>
            <span><code id="status-agent-source">—</code></span>
          </div>

          <div class="kvGrid">
            <div class="kv">
              <div class="k">Last Run (UTC)</div>
              <div class="v" id="status-agent-last">—</div>
            </div>
            <div class="kv">
              <div class="k">Freshness</div>
              <div class="v" id="status-agent-freshness">—</div>
            </div>
            <div class="kv">
              <div class="k">Last Result</div>
              <div class="v" id="status-agent-result">—</div>
            </div>
            <div class="kv">
              <div class="k">Total Runs</div>
              <div class="v" id="status-agent-ops">—</div>
            </div>
          </div>

          <div class="feed" id="status-agent-feed" aria-label="Status Agent recent activity">
            <!-- populated by JS -->
          </div>

          <p class="agentNote" id="status-agent-note" style="margin-top: 10px;">
            This panel displays <strong>server-side evidence</strong> produced by the Status Agent.
            The browser does not generate operations.
          </p>
        </div>
      </section>

      <!-- RIGHT: KPIs + GOVERNANCE + GUARDS -->
      <aside class="card" aria-label="System KPIs and Guards">
        <div class="cardHeader">
          <h2>System KPIs</h2>
          <span class="statusPill warn" id="launch-pill"><span class="dot"></span> Live Snapshot</span>
        </div>

        <div class="kpiGrid" aria-label="KPI grid">
          <div class="kpi">
            <div class="kpiLabel">Agent Health</div>
            <div class="kpiValue" id="kpi-agent-health">—</div>
            <div class="kpiNote" id="kpi-agent-health-note">Active agents / total agents</div>
          </div>

          <div class="kpi">
            <div class="kpiLabel">Autonomy (confirmed)</div>
            <div class="kpiValue" id="kpi-autonomy">—</div>
            <div class="kpiNote" id="kpi-autonomy-note">Mode: —</div>
          </div>

          <div class="kpi">
            <div class="kpiLabel">Health Score</div>
            <div class="kpiValue" id="kpi-health">—</div>
            <div class="kpiNote" id="kpi-health-note">Signal: —</div>
          </div>

          <div class="kpi">
            <div class="kpiLabel">Governance</div>
            <div class="kpiValue" id="kpi-governance">—</div>
            <div class="kpiNote" id="kpi-governance-note">Audit trail & gate verdict</div>
          </div>
        </div>

        <div class="truthBox" id="truth-box" aria-label="Truth lock box">
          <div><strong>Truth lock:</strong> This page reads from <code id="truth-path">—</code></div>
          <div><strong>Generated at:</strong> <span id="generated-at">—</span></div>
          <div><strong>Environment:</strong> <span id="environment">—</span></div>
        </div>

        <div style="margin-top: 12px;">
          <div class="cardHeader" style="margin-bottom: 10px;">
            <h2>Governance Explanation</h2>
            <span class="statusPill" id="gov-pill"><span class="dot"></span> Evaluated</span>
          </div>
          <div class="truthBox" aria-label="Governance explanation">
            <div><strong>Why is the current state allowed?</strong></div>
            <ul id="gov-reasons" style="margin: 8px 0 0 0; padding-left: 18px;">
              <li>—</li>
            </ul>
            <div class="kpiNote" style="margin-top: 8px;">
              Governance is active even when nothing breaks.
            </div>
          </div>
        </div>

        <div style="margin-top: 12px;">
          <div class="cardHeader" style="margin-bottom: 10px;">
            <h2>Pipelines & Guards</h2>
            <span class="statusPill" id="guards-pill"><span class="dot"></span> Truth Locked</span>
          </div>

          <div class="guards" aria-label="Guards">
            <div class="guardRow">
              <div class="guardLeft">
                <div class="guardName">Freshness</div>
                <div class="guardValue" id="guard-freshness">—</div>
              </div>
              <span class="guardPill" id="guard-freshness-pill">—</span>
            </div>

            <div class="guardRow">
              <div class="guardLeft">
                <div class="guardName">Runtime Gate</div>
                <div class="guardValue" id="guard-gate">—</div>
              </div>
              <span class="guardPill" id="guard-gate-pill">—</span>
            </div>

            <div class="guardRow">
              <div class="guardLeft">
                <div class="guardName">Audit Trail</div>
                <div class="guardValue" id="guard-audit">—</div>
              </div>
              <span class="guardPill" id="guard-audit-pill">—</span>
            </div>

            <div class="guardRow">
              <div class="guardLeft">
                <div class="guardName">Decision Trace</div>
                <div class="guardValue" id="guard-trace">—</div>
              </div>
              <span class="guardPill" id="guard-trace-pill">—</span>
            </div>

            <div class="guardRow">
              <div class="guardLeft">
                <div class="guardName">Status Agent</div>
                <div class="guardValue" id="guard-status-agent">—</div>
              </div>
              <span class="guardPill" id="guard-status-agent-pill">—</span>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      Status page generated by <span>virtauto.OS</span> — single source of truth.
    </footer>
  </div>

  <script>
    // =========================
    // TRUTH SOURCE (Single Source of Truth)
    // =========================
    // GitHub Pages serves this status page from /status/.
    // Keep this relative to /status/ so it works on any domain.
    const TRUTH_PATH = "./ops/reports/system_status.json";

    // Status Agent evidence source (server-produced JSONL)
    const STATUS_AGENT_LOG_PATH = "./ops/agent_activity.jsonl";

    // =========================
    // Helpers
    // =========================
    function $(id) { return document.getElementById(id); }

    function safeUpper(v) {
      return (v === undefined || v === null) ? "—" : String(v).toUpperCase();
    }

    function fmtPctFrom(valueOrPct) {
      if (valueOrPct === undefined || valueOrPct === null) return "—";
      const n = Number(valueOrPct);
      if (!Number.isFinite(n)) return "—";
      const pct = (n <= 1) ? (n * 100) : n;
      return pct.toFixed(1) + "%";
    }

    function fmtDate(iso) {
      if (!iso) return "—";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      return d.toISOString().slice(0, 19).replace("T", " ");
    }

    function classifyPillBySignal(signal) {
      const s = String(signal || "").toUpperCase();
      if (s.includes("RED") || s.includes("CRIT") || s.includes("FAIL")) return "crit";
      if (s.includes("YELLOW") || s.includes("WARN") || s.includes("DEGRADED") || s.includes("REVIEW")) return "warn";
      return "";
    }

    function chipClassForState(state) {
      const s = String(state || "").toUpperCase();
      if (s === "ACTIVE" || s === "OK" || s === "GREEN" || s === "ONLINE" || s === "INITIALIZED" || s === "OPERATIONAL") return "ok";
      if (s === "PLANNED" || s === "MVP" || s === "IN_PROGRESS" || s === "UNKNOWN" || s === "SUPERVISED" || s === "MANUAL") return "warn";
      if (s === "FAIL" || s === "FAILED" || s === "DOWN" || s === "CRITICAL" || s === "ISSUE" || s === "BLOCKED") return "crit";
      return "soon";
    }

    function setGuardPill(el, kind) {
      el.classList.remove("ok", "warn", "crit");
      if (kind) el.classList.add(kind);
    }

    function setMiniPill(el, kind) {
      el.classList.remove("ok", "warn", "crit");
      if (kind) el.classList.add(kind);
    }

    function showFatal(err) {
      $("fatal-src").textContent = TRUTH_PATH;
      $("fatal-err").textContent = String(err && err.message ? err.message : err);
      $("fatal").style.display = "flex";
      $("page").style.display = "none";
    }

    async function fetchTruth() {
      const res = await fetch(`${TRUTH_PATH}?t=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load truth source (${res.status}) at ${TRUTH_PATH}`);
      const json = await res.json();
      if (!json || typeof json !== "object") throw new Error("Truth source returned invalid JSON.");
      return json;
    }

    async function fetchText(path) {
      const res = await fetch(`${path}?t=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load evidence source (${res.status}) at ${path}`);
      return await res.text();
    }

    function parseJSONL(text) {
      const lines = String(text || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const out = [];
      for (const line of lines) {
        try {
          const obj = JSON.parse(line);
          if (obj && typeof obj === "object") out.push(obj);
        } catch (_) {
          // ignore malformed lines
        }
      }
      return out;
    }

    function minutesAgo(iso) {
      if (!iso) return null;
      const t = new Date(iso).getTime();
      if (!Number.isFinite(t)) return null;
      const diff = Date.now() - t;
      return Math.max(0, Math.round(diff / 60000));
    }

    function classifyFreshness(mins) {
      if (mins === null) return { label: "UNKNOWN", kind: "warn" };
      if (mins < 45) return { label: "OPERATIONAL", kind: "ok" };
      if (mins <= 90) return { label: "STALE", kind: "warn" };
      return { label: "OFFLINE", kind: "crit" };
    }

    function briefResultTag(r) {
      const s = String(r || "").toUpperCase();
      if (s.includes("PASS") || s.includes("OK")) return { text: "PASS", kind: "ok" };
      if (s.includes("WARN") || s.includes("REVIEW") || s.includes("STALE")) return { text: "WARN", kind: "warn" };
      if (s.includes("FAIL") || s.includes("CRIT") || s.includes("ERROR") || s.includes("BLOCK")) return { text: "FAIL", kind: "crit" };
      return { text: s || "UNKNOWN", kind: "warn" };
    }

    function getGateVerdict(status) {
      const a = status.autonomy_score || status.autonomy || {};
      return (
        a.gate_verdict ||
        (a.inputs && a.inputs.gate_verdict) ||
        (status.gate && status.gate.verdict) ||
        "—"
      );
    }

    // =========================
    // Rendering
    // =========================
    function renderHeader(status) {
      $("truth-source").textContent = "system_status.json";
      $("truth-path").textContent = TRUTH_PATH;

      const generatedAt = status.generated_at || status.generatedAt || status.timestamp || null;
      $("generated-at").textContent = generatedAt ? fmtDate(generatedAt) : "—";
      $("environment").textContent = status.environment || "—";

      const ageMin = minutesAgo(generatedAt);
      $("freshness").textContent = (ageMin === null) ? "—" : `${ageMin} min ago`;

      const sysState =
        (status.system && status.system.state) ||
        (status.system_state && status.system_state.state) ||
        status.system_state ||
        "—";

      const sysMode =
        (status.system && status.system.mode) ||
        status.mode ||
        "—";

      const signal = (status.health && status.health.signal) || "—";
      const pill = $("system-pill");
      pill.classList.remove("warn", "crit");
      const cls = classifyPillBySignal(signal);
      if (cls) pill.classList.add(cls);

      pill.textContent = "";
      const dot = document.createElement("span");
      dot.className = "dot";
      pill.appendChild(dot);
      pill.appendChild(document.createTextNode(` ${safeUpper(sysState)} · ${safeUpper(sysMode)}`));
    }

    function renderKPIs(status) {
      const agentsObj = status.agents || {};
      const agentKeys = Object.keys(agentsObj);
      const total = agentKeys.length || 0;
      let active = 0;

      for (const k of agentKeys) {
        const st = (agentsObj[k] && (agentsObj[k].state || agentsObj[k].status)) || "";
        if (String(st).toUpperCase() === "ACTIVE") active++;
      }

      $("kpi-agent-health").textContent = total ? `${active} / ${total}` : "—";

      const autonomyObj = status.autonomy_score || status.autonomy || {};
      const autonomyMode =
        (status.system && status.system.autonomy_mode) ||
        (autonomyObj && autonomyObj.mode) ||
        (status.system && status.system.autonomy) ||
        "—";

      const autonomyPct =
        (autonomyObj && (autonomyObj.percent ?? autonomyObj.value ?? autonomyObj.current_level)) ??
        (status.autonomy && status.autonomy.current_level) ??
        null;

      $("kpi-autonomy").textContent = fmtPctFrom(autonomyPct);
      $("kpi-autonomy-note").textContent = `Mode: ${safeUpper(autonomyMode)}`;

      const healthOverall = (status.health && (status.health.overall_score || status.health.score)) || null;
      const healthSignal = (status.health && status.health.signal) || "—";
      $("kpi-health").textContent = fmtPctFrom(healthOverall);
      $("kpi-health-note").textContent = `Signal: ${safeUpper(healthSignal)}`;

      const gateVerdict = getGateVerdict(status);

      const links = status.links || {};
      const auditTrailAvailable = Boolean(links.decision_trace || links.decision_trace_jsonl || links.latest_decision);
      const governanceValue = auditTrailAvailable ? "ENFORCED" : "LIMITED";
      $("kpi-governance").textContent = governanceValue;
      $("kpi-governance-note").textContent = `Gate: ${safeUpper(gateVerdict)} · Audit: ${auditTrailAvailable ? "AVAILABLE" : "MISSING"}`;

      const lp = $("launch-pill");
      lp.classList.remove("warn", "crit");
      const cls = classifyPillBySignal(healthSignal);
      if (cls) lp.classList.add(cls);

      lp.textContent = "";
      const dot = document.createElement("span");
      dot.className = "dot";
      lp.appendChild(dot);
      lp.appendChild(document.createTextNode(` ${safeUpper(healthSignal)}`));
    }

    function renderAgents(status) {
      const agents = status.agents || {};
      const grid = $("agents-grid");
      grid.innerHTML = "";

      // preferred order (stable UI)
      const order = [
        ["guardian", "Self-Guardian", ["Security", "Policy checks", "Guardrails"],
          "Monitors every change, applies Guardian rules and blocks unsafe updates before they reach production."],
        ["monitoring", "Self-Monitoring", ["Workflow logs", "Status signals"],
          "Tracks CI/CD runs, agent activity and basic system health across orchestration runs."],
        ["content", "Self-Content Agent", ["Draft generation", "Pull request content"],
          "Generates content drafts and change proposals as pull requests for human-in-the-loop review."],
        ["consistency", "Consistency Agent", ["Schema checks", "Registry consistency"],
          "Ensures registry + traces stay consistent before the UI (and later: before the factory) acts."],
        ["george", "GEORGE Orchestrator", ["Event routing", "Agent registry"],
          "Coordinates when which agent should run. Orchestration is enforced through deterministic rules and traceability."],
        ["site_audit", "Site Audit", ["Evidence", "Controls", "Links"],
          "Verifies site integrity and governance signals. Surfaces audit-relevant evidence for review."],
        ["deploy_agent", "Deploy Agent", ["Safe rollout", "Rollback"],
          "Handles guarded deployments and rollback paths when enabled by authority and gate conditions."]
      ];

      const used = new Set();

      function addAgentCard(key, title, meta, note) {
        const a = agents[key] || {};
        const state = a.state || a.status || "UNKNOWN";
        const mode = a.autonomy_mode || a.autonomy || "";
        const chipText = mode ? `${state} · ${mode}` : `${state}`;
        const cls = chipClassForState(state);

        const el = document.createElement("article");
        el.className = "agentCard";
        el.innerHTML = `
          <div class="agentTop">
            <p class="agentName">${title}</p>
            <span class="chip ${cls}" title="${safeUpper(chipText)}">${safeUpper(chipText)}</span>
          </div>
          <div class="agentMeta">${(meta || []).map(m => `<span>${m}</span>`).join("")}</div>
          <p class="agentNote">${note || "Status rendered from system_status.json."}</p>
        `;
        grid.appendChild(el);
      }

      for (const [key, title, meta, note] of order) {
        if (!agents[key]) continue;
        used.add(key);
        addAgentCard(key, title, meta, note);
      }

      // any remaining agents
      const HIDDEN_AGENT_KEYS = new Set([
        "status",        // duplicate of status_agent
        "deploy",        // duplicate/legacy of deploy_agent
        "executor",      // optional if present
        "executor_agent" // optional if present
      ]);
      
      for (const key of Object.keys(agents)) {
        if (used.has(key)) continue;
        if (HIDDEN_AGENT_KEYS.has(key)) continue;
        
        addAgentCard(
          key,
          key,
          ["Agent", "Truth locked"],
          "Status rendered from system_status.json."
        );
      }

      if (!Object.keys(agents).length) {
        addAgentCard("agents", "Agents", ["No agent map found"], "system_status.json contains no 'agents' object.");
      }
    }

    function renderGuards(status) {
      const generatedAt = status.generated_at || status.generatedAt || status.timestamp || null;
      const now = Date.now();
      const ts = generatedAt ? new Date(generatedAt).getTime() : NaN;
      const ageMin = Number.isFinite(ts) ? Math.max(0, Math.round((now - ts) / 60000)) : null;

      if (ageMin === null) {
        $("guard-freshness").textContent = "—";
        $("guard-freshness-pill").textContent = "UNKNOWN";
        setGuardPill($("guard-freshness-pill"), "warn");
      } else {
        $("guard-freshness").textContent = `${ageMin} min ago`;
        if (ageMin <= 15) { $("guard-freshness-pill").textContent = "FRESH"; setGuardPill($("guard-freshness-pill"), "ok"); }
        else if (ageMin <= 60) { $("guard-freshness-pill").textContent = "STALE"; setGuardPill($("guard-freshness-pill"), "warn"); }
        else { $("guard-freshness-pill").textContent = "EXPIRED"; setGuardPill($("guard-freshness-pill"), "crit"); }
      }

      const gate = getGateVerdict(status);
      $("guard-gate").textContent = safeUpper(gate);
      if (String(gate).toUpperCase().includes("ALLOW") || String(gate).toUpperCase().includes("PASS")) {
        $("guard-gate-pill").textContent = "PASS";
        setGuardPill($("guard-gate-pill"), "ok");
      } else if (gate === "—") {
        $("guard-gate-pill").textContent = "UNKNOWN";
        setGuardPill($("guard-gate-pill"), "warn");
      } else {
        $("guard-gate-pill").textContent = "BLOCK";
        setGuardPill($("guard-gate-pill"), "crit");
      }

      const links = status.links || {};
      const auditAvail = Boolean(links.latest_decision || links.decision_trace || links.decision_trace_jsonl);
      $("guard-audit").textContent = auditAvail ? "Available" : "Missing";
      $("guard-audit-pill").textContent = auditAvail ? "OK" : "MISSING";
      setGuardPill($("guard-audit-pill"), auditAvail ? "ok" : "warn");

      const trace = links.decision_trace || links.decision_trace_jsonl || null;
      $("guard-trace").textContent = trace ? String(trace) : "—";
      if (trace) { $("guard-trace-pill").textContent = "LINKED"; setGuardPill($("guard-trace-pill"), "ok"); }
      else { $("guard-trace-pill").textContent = "UNLINKED"; setGuardPill($("guard-trace-pill"), "warn"); }
    }

    function renderGovernanceExplanation(status) {
      const reasons = [];
      const health = status.health || {};
      const links = status.links || {};
      const gate = getGateVerdict(status);

      if (health.signal) reasons.push(`Health signal is ${String(health.signal).toUpperCase()}`);
      if (health.overall_score !== undefined && health.overall_score !== null) reasons.push(`Health score is ${health.overall_score}`);

      if (gate && gate !== "—") reasons.push(`Governance gate verdict is ${String(gate).toUpperCase()}`);
      else reasons.push("Governance gate verdict is not present in the truth source");

      if (links.decision_trace || links.decision_trace_jsonl) reasons.push("Decision trace is linked (audit trail available)");
      else reasons.push("Decision trace link is missing (audit trail limited)");

      if (links.gate_result) reasons.push("Gate result artifact is linked");
      else reasons.push("Gate result artifact link is missing");

      const ul = $("gov-reasons");
      ul.innerHTML = "";
      for (const r of reasons) {
        const li = document.createElement("li");
        li.textContent = r;
        ul.appendChild(li);
      }

      const pill = $("gov-pill");
      pill.classList.remove("warn", "crit", "ok");
      if (String(gate).toUpperCase().includes("ALLOW") || String(gate).toUpperCase().includes("PASS")) pill.classList.add("ok");
      else if (gate === "—") pill.classList.add("warn");
      else pill.classList.add("crit");
    }

    function renderStatusAgentEvidence(events, loadError) {
      $("status-agent-source").textContent = STATUS_AGENT_LOG_PATH;

      const pill = $("status-agent-pill");
      const feed = $("status-agent-feed");

      $("status-agent-last").textContent = "—";
      $("status-agent-freshness").textContent = "—";
      $("status-agent-result").textContent = "—";
      $("status-agent-ops").textContent = "—";
      feed.innerHTML = "";

      if (loadError) {
        pill.textContent = "MISSING";
        setMiniPill(pill, "warn");
        $("status-agent-note").innerHTML =
          `Evidence source missing or unreadable: <code>${STATUS_AGENT_LOG_PATH}</code>. This is not simulated in the browser.`;
        $("guard-status-agent").textContent = "Evidence source missing";
        $("guard-status-agent-pill").textContent = "MISSING";
        setGuardPill($("guard-status-agent-pill"), "warn");
        return;
      }

      const statusEvents = (events || []).filter(e => String(e.agent || "").toLowerCase() === "status_agent");
      const total = statusEvents.length;

      if (!total) {
        pill.textContent = "NO DATA";
        setMiniPill(pill, "warn");
        $("status-agent-ops").textContent = "0";
        $("status-agent-note").innerHTML =
          `Evidence loaded, but no <code>{"agent":"status_agent"}</code> events found.`;
        $("guard-status-agent").textContent = "No status_agent events";
        $("guard-status-agent-pill").textContent = "NO DATA";
        setGuardPill($("guard-status-agent-pill"), "warn");
        return;
      }

      statusEvents.sort((a,b) => {
        const ta = new Date(a.timestamp || a.ts || a.time || 0).getTime();
        const tb = new Date(b.timestamp || b.ts || b.time || 0).getTime();
        return (Number.isFinite(tb) ? tb : 0) - (Number.isFinite(ta) ? ta : 0);
      });

      const latest = statusEvents[0];
      const lastIso = latest.timestamp || latest.ts || latest.time || null;
      const age = minutesAgo(lastIso);
      const freshness = classifyFreshness(age);

      pill.textContent = freshness.label;
      setMiniPill(pill, freshness.kind);

      $("status-agent-last").textContent = lastIso ? fmtDate(lastIso) : "—";
      $("status-agent-freshness").textContent = (age === null) ? "—" : `${age} min ago`;
      $("status-agent-ops").textContent = String(total);

      const rr = briefResultTag(latest.result || latest.status || latest.event || "");
      $("status-agent-result").textContent = rr.text;

      $("guard-status-agent").textContent = (age === null) ? "—" : `${freshness.label} · ${age} min`;
      $("guard-status-agent-pill").textContent = freshness.label;
      setGuardPill($("guard-status-agent-pill"), freshness.kind);

      // Render last 6 events
      const slice = statusEvents.slice(0, 6);
      for (const e of slice) {
        const ts = e.timestamp || e.ts || e.time;
        const tsFmt = ts ? fmtDate(ts) : "—";
        const op = String(e.operation || e.event || "operation").replace(/_/g, " ");
        const tag = briefResultTag(e.result || e.status || e.event || "UNKNOWN");

        let evidenceSummary = "";
        if (e.evidence && typeof e.evidence === "object") {
          const pairs = [];
          if ("system_health" in e.evidence) pairs.push(`health=${String(e.evidence.system_health)}`);
          if ("governance" in e.evidence) pairs.push(`governance=${String(e.evidence.governance)}`);
          if ("decision_trace" in e.evidence) pairs.push(`trace=${e.evidence.decision_trace ? "yes" : "no"}`);
          evidenceSummary = pairs.length ? pairs.join(" · ") : "";
        }

        const item = document.createElement("div");
        item.className = "feedItem";
        item.innerHTML = `
          <div class="feedLeft">
            <div class="feedTitle">[${tsFmt} UTC] Status Agent — ${op}</div>
            <div class="feedMeta">${evidenceSummary || "Evidence recorded."}</div>
          </div>
          <div class="feedTag ${tag.kind}">${tag.text}</div>
        `;
        feed.appendChild(item);
      }

      $("status-agent-note").innerHTML =
        `Rendered from <code>${STATUS_AGENT_LOG_PATH}</code>. No client-side timers, no simulated operations.`;
    }

    // =========================
    // Boot
    // =========================
    (async function boot() {
      try {
        const status = await fetchTruth();
        renderHeader(status);
        renderKPIs(status);
        renderGuards(status);
        renderGovernanceExplanation(status);
        renderAgents(status);

        try {
          const txt = await fetchText(STATUS_AGENT_LOG_PATH);
          const events = parseJSONL(txt);
          renderStatusAgentEvidence(events, null);
        } catch (e) {
          console.warn(e);
          renderStatusAgentEvidence([], e);
        }
      } catch (err) {
        console.error(err);
        showFatal(err);
      }
    })();
  </script>

  <!-- header injection + site scripts -->
  <script src="/assets/header_include.js" defer></script>
  <script src="/assets/site.js" defer></script>
</body>
</html>