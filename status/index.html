<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>virtauto.OS — Live System Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --card-bg: #0b1020;
      --accent: #8b5cf6;
      --accent-soft: rgba(139, 92, 246, 0.1);
      --ok: #22c55e;
      --warn: #f59e0b;
      --crit: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      padding: 2.5rem 1.5rem 3rem;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 2.5rem;
    }

    header h1 {
      font-size: 2rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    header h1 span.badge {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      background: var(--accent-soft);
      border: 1px solid rgba(139, 92, 246, 0.4);
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      color: var(--accent);
    }

    header p {
      max-width: 740px;
      font-size: 0.95rem;
      color: var(--muted);
      line-height: 1.35;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    .meta-pill {
      font-size: 0.8rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .meta-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }

    .meta-pill.ok .meta-dot { background: var(--ok); }
    .meta-pill.warn .meta-dot { background: var(--warn); }
    .meta-pill.crit .meta-dot { background: var(--crit); }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.4fr);
      gap: 1.5rem;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: 1.1rem;
      border: 1px solid var(--border);
      padding: 1.3rem 1.4rem 1.3rem;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .card-header h2 {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .status-pill {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .status-pill span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--ok);
    }
    .status-pill.warn span.dot { background: var(--warn); }
    .status-pill.crit span.dot { background: var(--crit); }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 0.85rem;
    }

    .status-card {
      border-radius: 0.9rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 0.8rem 0.9rem;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.85)
      );
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-height: 126px;
    }

    .status-title-row {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .status-chip {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--muted);
    }

    .status-chip.ok {
      border-color: rgba(34, 197, 94, 0.65);
      color: #bbf7d0;
    }
    .status-chip.warn {
      border-color: rgba(245, 158, 11, 0.75);
      color: #fed7aa;
    }
    .status-chip.crit {
      border-color: rgba(239, 68, 68, 0.75);
      color: #fecaca;
    }
    .status-chip.soon {
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--muted);
    }

    .status-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.6rem;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .status-meta span { opacity: 0.9; }

    .status-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.2rem;
      line-height: 1.3;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.7rem;
    }

    .kpi {
      border-radius: 0.85rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, #111827 0, #020617 70%);
      padding: 0.7rem 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      min-height: 76px;
    }

    .kpi-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .kpi-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .kpi-footnote {
      font-size: 0.7rem;
      color: var(--muted);
      line-height: 1.25;
    }

    .divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 1.2rem 0;
    }

    .small-muted {
      font-size: 0.75rem;
      color: var(--muted);
      line-height: 1.35;
    }

    code.inline {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 0.75rem;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(55,65,81,0.9);
      border-radius: 8px;
      padding: 0.12rem 0.35rem;
      color: #c7d2fe;
      white-space: nowrap;
    }

    footer {
      margin-top: 2rem;
      font-size: 0.7rem;
      color: var(--muted);
      text-align: right;
    }

    footer span { color: var(--accent); }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>
        virtauto.OS — Live System Status
        <span class="badge">TRUTH-LOCKED</span>
      </h1>
      <p>
        Single authoritative view of <strong>www.virtauto.de</strong> as an Agentic Website.
        This page renders <em>only</em> what is present in
        <span class="inline-wrap"><code class="inline">system_status.json</code></span> (no manual KPI overrides, no marketing interpretation).
      </p>

      <div class="meta-row">
        <div class="meta-pill" id="pill-system">
          <span class="meta-dot"></span>
          <span id="meta-system">System: —</span>
        </div>
        <div class="meta-pill" id="pill-autonomy">
          <span class="meta-dot"></span>
          <span id="meta-autonomy">Autonomy Mode: —</span>
        </div>
        <div class="meta-pill" id="pill-freshness">
          <span class="meta-dot"></span>
          <span id="meta-freshness">Freshness: —</span>
        </div>
        <div class="meta-pill">
          <span class="meta-dot" style="background: var(--accent);"></span>
          <span>Truth Source: <code class="inline">system_status.json</code></span>
        </div>
      </div>
    </header>

    <main>
      <!-- LEFT: AGENTS & LAYERS -->
      <section class="card">
        <div class="card-header">
          <h2>Core Agents & Layers</h2>
          <span class="status-pill" id="system-pill">
            <span class="dot"></span>
            <span id="system-pill-text">—</span>
          </span>
        </div>

        <div class="status-grid">
          <!-- Self-Guardian -->
          <article class="status-card" data-agent="guardian">
            <div class="status-title-row">
              <div class="status-title">Self-Guardian</div>
              <div class="status-chip soon" id="chip-guardian">—</div>
            </div>
            <div class="status-meta">
              <span>Security</span>
              <span>Policy checks</span>
              <span>Fail-safe guardrails</span>
            </div>
            <p class="status-note">
              Monitors every change, applies Guardian rules and blocks unsafe updates before they reach production.
            </p>
          </article>

          <!-- Monitoring -->
          <article class="status-card" data-agent="monitoring">
            <div class="status-title-row">
              <div class="status-title">Self-Monitoring</div>
              <div class="status-chip soon" id="chip-monitoring">—</div>
            </div>
            <div class="status-meta">
              <span>Workflow logs</span>
              <span>Status signals</span>
            </div>
            <p class="status-note">
              Tracks CI/CD runs, agent activity and basic system health across GitHub Actions.
            </p>
          </article>

          <!-- Self-Content -->
          <article class="status-card" data-agent="content">
            <div class="status-title-row">
              <div class="status-title">Self-Content Agent</div>
              <div class="status-chip soon" id="chip-content">—</div>
            </div>
            <div class="status-meta">
              <span>Draft generation</span>
              <span>Pull request content</span>
            </div>
            <p class="status-note">
              Generates content drafts and change proposals as pull requests for human-in-the-loop review.
            </p>
          </article>

          <!-- GEORGE -->
          <article class="status-card" data-agent="george">
            <div class="status-title-row">
              <div class="status-title">GEORGE Orchestrator</div>
              <div class="status-chip soon" id="chip-george">—</div>
            </div>
            <div class="status-meta">
              <span>Decision routing</span>
              <span>Authority enforcement</span>
            </div>
            <p class="status-note">
              Orchestrates agent execution with deterministic routing, mandatory traceability, and runtime authority checks.
            </p>
          </article>

          <!-- RAG Layer (informational; not always reported in system_status.json) -->
          <article class="status-card" data-agent="rag">
            <div class="status-title-row">
              <div class="status-title">RAG Knowledge Layer</div>
              <div class="status-chip soon" id="chip-rag">UNREPORTED</div>
            </div>
            <div class="status-meta">
              <span>docs-001 …</span>
              <span>Vector embeddings</span>
            </div>
            <p class="status-note">
              Stores long-term memory and governance context used for consistent decisions and reviews.
            </p>
          </article>

          <!-- CDT (informational) -->
          <article class="status-card" data-agent="cdt">
            <div class="status-title-row">
              <div class="status-title">Cognitive Digital Twin (CDT)</div>
              <div class="status-chip soon" id="chip-cdt">CONCEPT</div>
            </div>
            <div class="status-meta">
              <span>Long-term intent</span>
              <span>Roadmap</span>
            </div>
            <p class="status-note">
              Long-term “brain” concept: how agents, memory and strategy evolve over time.
            </p>
          </article>

          <!-- Audit Agent -->
          <article class="status-card" data-agent="site_audit">
            <div class="status-title-row">
              <div class="status-title">Audit Agent</div>
              <div class="status-chip soon" id="chip-site_audit">—</div>
            </div>
            <div class="status-meta">
              <span>Compliance</span>
              <span>Change logs</span>
            </div>
            <p class="status-note">
              Verifies that changes are documented, reversible, and aligned with governance controls.
            </p>
          </article>

          <!-- Deploy Agent -->
          <article class="status-card" data-agent="deploy_agent">
            <div class="status-title-row">
              <div class="status-title">Deploy Agent</div>
              <div class="status-chip soon" id="chip-deploy_agent">—</div>
            </div>
            <div class="status-meta">
              <span>Safe rollout</span>
              <span>Auto rollback</span>
            </div>
            <p class="status-note">
              Handles guarded deployments from merge to live, with rollback paths and traceability.
            </p>
          </article>

          <!-- Marketing Content Agent (informational / future) -->
          <article class="status-card" data-agent="marketing">
            <div class="status-title-row">
              <div class="status-title">Marketing Content Agent</div>
              <div class="status-chip soon" id="chip-marketing">UNREPORTED</div>
            </div>
            <div class="status-meta">
              <span>Articles</span>
              <span>Release notes</span>
            </div>
            <p class="status-note">
              Proposes posts and updates based on real system changes (future capability).
            </p>
          </article>
        </div>
      </section>

      <!-- RIGHT: KPIs (truth-locked) -->
      <aside class="card">
        <div class="card-header">
          <h2>System KPIs</h2>
          <span class="status-pill" id="launch-pill">
            <span class="dot"></span>
            <span id="launch-pill-text">—</span>
          </span>
        </div>

        <div class="kpi-grid">
          <div class="kpi">
            <div class="kpi-label">Agent Health</div>
            <div class="kpi-value" id="kpi-agent-health">—</div>
            <div class="kpi-footnote" id="kpi-agent-health-note">Active agents / total</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">Autonomy Level</div>
            <div class="kpi-value" id="kpi-autonomy">—</div>
            <div class="kpi-footnote" id="kpi-autonomy-note">From autonomy_score.percent</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">Health Score</div>
            <div class="kpi-value" id="kpi-health">—</div>
            <div class="kpi-footnote" id="kpi-health-note">From health.overall_score</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">System Mode</div>
            <div class="kpi-value" id="kpi-mode">—</div>
            <div class="kpi-footnote" id="kpi-mode-note">From system.mode / autonomy_mode</div>
          </div>
        </div>

        <hr class="divider" />

        <div class="card-header" style="margin-bottom: 0.25rem;">
          <h2>Governance Signals</h2>
        </div>

        <div class="small-muted" style="margin-top: 0.5rem;">
          <div>• Freshest timestamp: <strong id="gov-ts">—</strong></div>
          <div>• Escalation active: <strong id="gov-escalation">—</strong></div>
          <div>• Compliance status: <strong id="gov-compliance">—</strong></div>
          <div style="margin-top: 0.5rem; opacity: 0.9;">
            Links (if available): <span id="gov-links">—</span>
          </div>
        </div>

        <div id="load-error" class="small-muted" style="margin-top: 1rem; display:none; color: #fecaca;">
          Failed to load <code class="inline">system_status.json</code>. This page is truth-locked and will not display inferred status.
        </div>
      </aside>
    </main>

    <footer>
      Truth-locked view generated by <span>virtauto.OS</span> — single authoritative interface.
    </footer>
  </div>

<script>
/**
 * TRUTH-LOCKED LOADER
 * - Reads only system_status.json
 * - No hardcoded KPI fallback values
 * - If the source cannot be loaded, we show an explicit error
 */

// 1) Prefer same-origin path(s) (best for "single source of truth" on the website)
// 2) Fallback to raw GitHub (works even if the JSON is not published to the site root yet)
const STATUS_SOURCES = [
  "/status/system_status.json",
  "/ops/reports/system_status.json",
  "https://raw.githubusercontent.com/Jingle1999/virtauto/main/ops/reports/system_status.json"
];

function $(id) { return document.getElementById(id); }

function asUpper(x) {
  if (x === null || x === undefined) return null;
  return String(x).trim().toUpperCase();
}

function safeNumber(x) {
  if (x === null || x === undefined) return null;
  if (typeof x === "number" && Number.isFinite(x)) return x;
  if (typeof x === "string") {
    const n = parseFloat(x.replace("%","").trim());
    return Number.isFinite(n) ? n : null;
  }
  return null;
}

function fmtPct(x, decimals=1) {
  const n = safeNumber(x);
  if (n === null) return "—";
  return n.toFixed(decimals) + " %";
}

function fmtIso(ts) {
  if (!ts) return "—";
  try {
    const d = new Date(ts);
    if (isNaN(d.getTime())) return String(ts);
    // yyyy-mm-dd hh:mm
    return d.toISOString().slice(0,16).replace("T"," ");
  } catch {
    return String(ts);
  }
}

function minutesSince(ts) {
  try {
    const d = new Date(ts);
    if (isNaN(d.getTime())) return null;
    const ms = Date.now() - d.getTime();
    return Math.floor(ms / 60000);
  } catch {
    return null;
  }
}

function setPillClass(el, level /* ok|warn|crit */) {
  if (!el) return;
  el.classList.remove("ok","warn","crit");
  if (level) el.classList.add(level);
}

function setStatusPill(el, text, level) {
  if (!el) return;
  el.classList.remove("warn","crit");
  if (level === "warn") el.classList.add("warn");
  if (level === "crit") el.classList.add("crit");
  const dot = el.querySelector(".dot");
  const span = el.querySelector("span:last-child");
  if (span) span.textContent = text;
  if (dot) {
    dot.style.background =
      level === "crit" ? "var(--crit)" :
      level === "warn" ? "var(--warn)" :
      "var(--ok)";
  }
}

function chipFromState(stateLike) {
  const s = asUpper(stateLike);
  if (!s) return { text: "UNREPORTED", cls: "soon" };
  if (["ACTIVE","OK","ONLINE","PASS","ALLOW","RUNNING"].includes(s)) return { text: s, cls: "ok" };
  if (["SUPERVISED","PLANNED","MVP","IN_PROGRESS","INITIALIZED","WARNING","WARN","REVIEW"].includes(s)) return { text: s.replaceAll("_"," "), cls: "warn" };
  if (["BLOCK","FAIL","FAILED","CRIT","CRITICAL","DOWN","ERROR"].includes(s)) return { text: s.replaceAll("_"," "), cls: "crit" };
  return { text: s.replaceAll("_"," "), cls: "soon" };
}

function setChip(chipEl, stateLike) {
  if (!chipEl) return;
  const { text, cls } = chipFromState(stateLike);
  chipEl.textContent = text;
  chipEl.classList.remove("ok","warn","crit","soon");
  chipEl.classList.add(cls);
}

async function fetchFirstOk(urls) {
  let lastErr = null;
  for (const url of urls) {
    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} -> ${res.status}`);
      const json = await res.json();
      return { json, url };
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error("No status source available");
}

function agentKeyMap() {
  // Map your expected UI keys to possible keys in system_status.json
  // based on your screenshot: agents include george, guardian, monitoring, content, deploy_agent, site_audit
  return [
    "george",
    "guardian",
    "monitoring",
    "content",
    "deploy_agent",
    "site_audit"
  ];
}

function computeAgentHealth(agentsObj) {
  const keys = Object.keys(agentsObj || {});
  if (!keys.length) return { active: null, total: null };

  const total = keys.length;
  let active = 0;

  for (const k of keys) {
    const a = agentsObj[k] || {};
    const st = asUpper(a.state || a.status);
    if (st && ["ACTIVE","ONLINE","OK","RUNNING"].includes(st)) active += 1;
  }
  return { active, total };
}

function renderLinks(linksObj) {
  if (!linksObj || typeof linksObj !== "object") return "—";
  const items = [];
  for (const [k,v] of Object.entries(linksObj)) {
    if (!v) continue;
    items.push(`${k}: ${v}`);
  }
  return items.length ? items.join(" · ") : "—";
}

async function main() {
  const loadError = $("load-error");

  try {
    const { json: status, url } = await fetchFirstOk(STATUS_SOURCES);

    // ---- Canonical fields (based on your ops/reports/system_status.json screenshots)
    const generatedAt = status.generated_at || status.generatedAt || status.timestamp || null;

    const systemState = status.system?.state || status.system_state || status.system?.system_state || null; // e.g. ACTIVE
    const autonomyMode = status.system?.autonomy_mode || status.autonomy || status.autonomy_mode || null;   // e.g. SUPERVISED
    const systemMode = status.system?.mode || null;                                                        // e.g. STABILIZATION

    const autonomyPercent =
      (status.autonomy_score && status.autonomy_score.percent != null) ? status.autonomy_score.percent :
      (status.autonomy_score && status.autonomy_score.value != null) ? (safeNumber(status.autonomy_score.value) * 100) :
      null;

    const healthOverall =
      (status.health && status.health.overall_score != null) ? (safeNumber(status.health.overall_score) * 100) :
      null;

    // Agents object (your screenshot shows status.agents = { george: {...}, guardian: {...}, ... }
    const agentsObj = status.agents || {};

    // ---- Meta pills
    // System
    $("meta-system").textContent = `System: ${systemState ? asUpper(systemState) : "—"}`;
    setPillClass($("pill-system"),
      !systemState ? "warn" :
      ["ACTIVE","ONLINE","OK"].includes(asUpper(systemState)) ? "ok" :
      ["FAIL","FAILED","DOWN","ERROR","BLOCK"].includes(asUpper(systemState)) ? "crit" :
      "warn"
    );

    // Autonomy mode
    $("meta-autonomy").textContent = `Autonomy Mode: ${autonomyMode ? asUpper(autonomyMode) : "—"}`;
    setPillClass($("pill-autonomy"),
      !autonomyMode ? "warn" :
      ["AUTONOMOUS"].includes(asUpper(autonomyMode)) ? "ok" :
      ["SUPERVISED"].includes(asUpper(autonomyMode)) ? "warn" :
      ["MANUAL"].includes(asUpper(autonomyMode)) ? "warn" :
      "warn"
    );

    // Freshness
    const mins = minutesSince(generatedAt);
    const freshnessText =
      generatedAt ? `${fmtIso(generatedAt)}${mins !== null ? ` · ${mins} min ago` : ""}` : "—";
    $("meta-freshness").textContent = `Freshness: ${freshnessText}`;

    // Freshness thresholding
    let freshnessLevel = "warn";
    if (mins === null) freshnessLevel = "warn";
    else if (mins <= 10) freshnessLevel = "ok";
    else if (mins <= 60) freshnessLevel = "warn";
    else freshnessLevel = "crit";
    setPillClass($("pill-freshness"), freshnessLevel);

    // ---- Header/system status pill (top of left card)
    const sysText = systemState ? `${asUpper(systemState)}` : "UNKNOWN";
    const sysLevel =
      !systemState ? "warn" :
      ["ACTIVE","ONLINE","OK"].includes(asUpper(systemState)) ? "ok" :
      ["FAIL","FAILED","DOWN","ERROR","BLOCK"].includes(asUpper(systemState)) ? "crit" :
      "warn";
    setStatusPill($("system-pill"), `System ${sysText}`, sysLevel === "crit" ? "crit" : (sysLevel === "warn" ? "warn" : null));

    // Right pill (launch/mode)
    const launchText = systemMode ? `${String(systemMode).replaceAll("_"," ")}` : (autonomyMode ? `${asUpper(autonomyMode)}` : "—");
    const launchLevel =
      (autonomyMode && asUpper(autonomyMode) === "AUTONOMOUS") ? null :
      (autonomyMode && asUpper(autonomyMode) === "SUPERVISED") ? "warn" :
      null;
    setStatusPill($("launch-pill"), launchText, launchLevel);

    // ---- KPIs
    // Agent Health (active / total)
    const ah = computeAgentHealth(agentsObj);
    $("kpi-agent-health").textContent =
      (ah.active !== null && ah.total !== null) ? `${ah.active} / ${ah.total}` : "—";
    $("kpi-agent-health-note").textContent = "Active agents / reported agents";

    // Autonomy
    $("kpi-autonomy").textContent = autonomyPercent != null ? fmtPct(autonomyPercent, 1) : "—";
    $("kpi-autonomy-note").textContent = (status.autonomy_score && status.autonomy_score.mode)
      ? `Mode: ${String(status.autonomy_score.mode).replaceAll("_"," ")}`
      : "From autonomy_score.percent";

    // Health
    $("kpi-health").textContent = healthOverall != null ? fmtPct(healthOverall, 1) : "—";
    $("kpi-health-note").textContent = (status.health && status.health.signal)
      ? `Signal: ${String(status.health.signal).toUpperCase()}`
      : "From health.overall_score";

    // System Mode
    const modeLine = [
      systemMode ? String(systemMode).replaceAll("_"," ") : null,
      autonomyMode ? asUpper(autonomyMode) : null
    ].filter(Boolean).join(" · ");
    $("kpi-mode").textContent = modeLine || "—";
    $("kpi-mode-note").textContent = generatedAt ? `Generated: ${fmtIso(generatedAt)}` : "—";

    // ---- Governance Signals (best-effort from status.links + status fields)
    $("gov-ts").textContent = generatedAt ? fmtIso(generatedAt) : "—";

    // Escalation active: infer from last_incident / gate / etc if present, else "UNREPORTED"
    const escalationActive =
      status.system?.last_incident != null ? "YES" :
      (status.autonomy_score && status.autonomy_score.inputs && status.autonomy_score.inputs.gate_verdict === "ESCALATE") ? "YES" :
      "UNREPORTED";
    $("gov-escalation").textContent = escalationActive;

    // Compliance status: infer if guardian.json exists? If a field exists use it, else UNREPORTED
    const compliance =
      status.compliance_status ||
      status.governance?.compliance_status ||
      "UNREPORTED";
    $("gov-compliance").textContent = String(compliance).toUpperCase();

    $("gov-links").textContent = renderLinks(status.links);

    // ---- Agent chips (truth-locked)
    // For each known agent key, derive a display state
    const knownKeys = agentKeyMap();
    for (const key of knownKeys) {
      const chip = document.getElementById(`chip-${key}`);
      const a = agentsObj[key];
      if (!a) {
        // If not reported, keep "—" but mark as UNREPORTED (truthful)
        if (chip) setChip(chip, "UNREPORTED");
        continue;
      }

      // prefer a.state, else a.status
      const primary = a.state || a.status || "UNREPORTED";
      setChip(chip, primary);
    }

    // Optional: mark source URL in console (no UI impact)
    console.info("Loaded system_status.json from:", url);

    if (loadError) loadError.style.display = "none";
  } catch (err) {
    console.warn("Truth source load failed:", err);
    if ($("load-error")) $("load-error").style.display = "block";

    // Also explicitly set key UI elements to "—" / UNKNOWN (no inference)
    setStatusPill($("system-pill"), "System UNKNOWN", "warn");
    setStatusPill($("launch-pill"), "UNAVAILABLE", "warn");
    $("meta-system").textContent = "System: —";
    $("meta-autonomy").textContent = "Autonomy Mode: —";
    $("meta-freshness").textContent = "Freshness: —";
    $("kpi-agent-health").textContent = "—";
    $("kpi-autonomy").textContent = "—";
    $("kpi-health").textContent = "—";
    $("kpi-mode").textContent = "—";
    $("gov-ts").textContent = "—";
    $("gov-escalation").textContent = "—";
    $("gov-compliance").textContent = "—";
    $("gov-links").textContent = "—";
  }
}

document.addEventListener("DOMContentLoaded", main);
</script>
</body>
</html>
