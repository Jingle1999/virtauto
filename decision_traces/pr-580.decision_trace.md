# Decision Trace · Explainability v1

This document explains **what the Decision Trace is**, **why it exists**, and **how virtauto.OS uses it** to enforce governed, auditable operations.

---

## 1) Purpose

The **Decision Trace** is the audit-grade record of *why* a governed system state is allowed and *how* it was produced.

It enforces the rule:

> **No decision without trace.**

In virtauto.OS, “decision” includes:
- publishing or updating truth artifacts (e.g., `system_status.json`)
- granting/denying gates (PASS/BLOCK)
- proposing corrective actions (self-healing proposals via PR)
- any state transition that could influence runtime behavior or claims on the website

---

## 2) Artifacts

The Decision Trace exists in two formats:

### A) `ops/reports/decision_trace.json`
- **single object**
- machine-readable snapshot of the latest trace
- convenient for debugging and linking from status pages

### B) `ops/reports/decision_trace.jsonl`
- **append-only log** (one JSON object per line)
- canonical audit trail
- supports “event history” and deterministic replay

---

## 3) Where it is used

### Status Page (Truth-Locked UI)
The status UI reads truth from `ops/reports/system_status.json` and links to:
- `ops/reports/decision_trace.jsonl` (audit trail)
- optional: `ops/reports/decision_trace.json` (latest snapshot)

If the trace is missing or malformed, the UI must show this explicitly (no simulated “OK”).

### Governance Gates
Governance workflows validate:
- **presence** of a trace (required check)
- **schema sanity** (minimum required keys)
- **consistency** (links and referenced artifacts exist when claimed)

---

## 4) Minimal schema (Explainability v1)

A trace event SHOULD contain:

- `schema_version` (string)
- `generated_at` (UTC ISO timestamp)
- `trace_id` (unique id)
- `because` (list of rule/evidence pairs)
- `inputs` (files / invariants)
- `outputs` (files / mirrors)
- `evidence` (refs or deterministic file evidence)
- `result` (gate verdict + exit code)

Typical gate semantics:
- `exit_code = 0` → PASS
- `exit_code = 2` → BLOCK (e.g., emergency lock)
- `exit_code = 1` → FAIL (unexpected error)

---

## 5) Determinism rules

To remain **audit-safe**, the Status Agent’s decision trace MUST be derived only from:
- repo files (existence, size, mtime)
- deterministic transforms
- local computations

It MUST NOT:
- call external networks
- rely on volatile runtime-only values
- fabricate or “fill in” unknown evidence

When evidence is missing, the trace must say so explicitly.

---

## 6) Example trace (JSONL entry)

Below is a representative single JSONL line (one event):

```json
{
  "schema_version": "1.0",
  "generated_at": "2026-02-18T18:05:04Z",
  "trace_id": "trc_20260218_180504_status_truth",
  "because": [
    { "rule": "SCHEDULED_HEARTBEAT", "evidence": "ev_status_agent_run" },
    { "rule": "NO_EMERGENCY_LOCK", "evidence": "ev_emergency_lock" },
    { "rule": "AUTHORITY_EVIDENCE_PRESENT", "evidence": "ev_authority" },
    { "rule": "POLICY_EVIDENCE_MISSING", "evidence": "ev_policies" }
  ],
  "inputs": { "files": ["ops/emergency_lock.json", "ops/authority_matrix.yaml|json", "ops/george_rules.yaml"] },
  "outputs": { "files": ["ops/reports/system_status.json", "ops/reports/decision_trace.jsonl", "ops/agent_activity.jsonl"] },
  "evidence": {
    "ev_emergency_lock": { "ref": "ops/emergency_lock.json", "locked": false },
    "ev_authority": { "details": { "present": true, "path": "ops/authority_matrix.yaml" } },
    "ev_policies": { "details": { "present": false, "path": "ops/george_rules.yaml" } }
  },
  "result": { "gate_verdict": "PASS", "exit_code": 0 }
}
