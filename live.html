<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>virtauto — Live System Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f9fafb;
    }

    .live-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 16px 80px;
    }

    .live-hero {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 24px;
      align-items: flex-start;
      margin-bottom: 32px;
    }

    @media (max-width: 900px) {
      .live-hero {
        grid-template-columns: 1fr;
      }
    }

    .live-title {
      font-size: 2.4rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .live-subtitle {
      font-size: 0.95rem;
      opacity: 0.8;
      line-height: 1.5;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .badge {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .badge-pill {
      border-color: rgba(129, 140, 248, 0.7);
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.16), rgba(15, 23, 42, 0.96));
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .kpi {
      padding: 12px 14px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .kpi-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .kpi-note {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .live-feed-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin: 32px 0 16px;
    }

    .live-feed-title {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .live-feed-meta {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .feed-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .feed-item {
      border-radius: 14px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(8, 47, 73, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.8);
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
    }

    .feed-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
    }

    /* GEORGE-Events hervorheben */
    .feed-item-george {
      border-color: rgba(56, 189, 248, 0.85);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4), 0 18px 45px rgba(8, 47, 73, 0.9);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.15), rgba(8, 47, 73, 0.98));
    }

    .feed-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .feed-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .feed-tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.7);
    }

    /* Agent-Farben */
    .tag-guardian,
    .tag-self-guardian {
      border-color: rgba(34, 197, 94, 0.8);
      background: rgba(22, 101, 52, 0.6);
    }

    .tag-monitoring {
      border-color: rgba(52, 211, 153, 0.85);
      background: rgba(6, 95, 70, 0.7);
    }

    .tag-self-content {
      border-color: rgba(249, 115, 22, 0.9);
      background: rgba(124, 45, 18, 0.75);
    }

    .tag-george,
    .tag-george-orchestrator {
      border-color: rgba(56, 189, 248, 0.95);
      background: rgba(12, 74, 110, 0.85);
    }

    .tag-audit,
    .tag-audit-agent {
      border-color: rgba(244, 114, 182, 0.9);
      background: rgba(131, 24, 67, 0.8);
    }

    .tag-deploy {
      border-color: rgba(250, 204, 21, 0.95);
      background: rgba(113, 63, 18, 0.85);
    }

    .tag-content {
      border-color: rgba(129, 140, 248, 0.95);
      background: rgba(55, 65, 148, 0.85);
    }

    .feed-time {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .feed-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .feed-message {
      font-size: 0.85rem;
      opacity: 0.85;
    }

    .feed-empty {
      font-size: 0.9rem;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <!-- Deinen globalen Header kannst du hier drüber einfügen, falls vorhanden -->

  <main class="live-page">
    <section class="live-hero">
      <div>
        <div class="live-title">virtauto — Live System Dashboard</div>
        <div class="live-subtitle">
          Real-time view on agent activity, deployments, and autonomous operations.
          Powered by <code>ops/events.jsonl</code> and the virtauto Agent ecosystem.
        </div>
        <div class="badge-row">
          <span class="badge badge-pill">Agentic Website</span>
          <span class="badge" id="badge-autonomy">Autonomy ≈ 50.1%</span>
          <span class="badge" id="badge-agents">4 / 7 core agents live</span>
          <span class="badge" id="badge-george">GEORGE orchestrator · MVP</span>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi">
          <div class="kpi-label">Autonomy Level</div>
          <div class="kpi-value" id="kpi-autonomy">≈ 50.1%</div>
          <div class="kpi-note" id="kpi-autonomy-note">Target: 60% in 7 days</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Agents Online</div>
          <div class="kpi-value" id="kpi-agents">4 / 7</div>
          <div class="kpi-note" id="kpi-agents-note">Guardian · Self-Guardian · Monitoring · Self-Content</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">CI/CD Workflows</div>
          <div class="kpi-value" id="kpi-workflows">17</div>
          <div class="kpi-note" id="kpi-workflows-note">Self-operating backbone for virtauto.de</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Last Update</div>
          <div class="kpi-value" id="kpi-last-update">–</div>
          <div class="kpi-note">Auto-refresh every 30 seconds</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Health Score</div>
          <div class="kpi-value" id="kpi-health">–</div>
          <div class="kpi-note" id="kpi-health-note">System mode: –</div>
        </div>
      </div>
    </section>

    <section>
      <header class="live-feed-header">
        <h2 class="live-feed-title">Live Event Stream</h2>
        <div class="live-feed-meta">
          Source: <code>ops/events.jsonl</code> &nbsp;•&nbsp; showing latest 10 events
        </div>
      </header>

      <div id="feed" class="feed-list">
        <div class="feed-empty">Loading latest events …</div>
      </div>
    </section>
  </main>

  <script>
    // URLs zu den Live-Daten im Repo (Branch: main)
    const RAW_BASE =
      "https://raw.githubusercontent.com/Jingle1999/virtauto/main/ops";

    const EVENTS_URL = RAW_BASE + "/events.jsonl";
    const STATUS_URL = RAW_BASE + "/status.json";

    async function fetchStatus() {
      try {
        const res = await fetch(STATUS_URL + "?t=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        renderStatus(data);
      } catch (err) {
        console.error("Error loading status:", err);
        // falls status.json fehlt, bleiben die Defaultwerte sichtbar
      }
    }

    async function fetchEvents() {
      try {
        const res = await fetch(EVENTS_URL + "?t=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();

        const lines = text
          .split("\n")
          .map(l => l.trim())
          .filter(Boolean);

        const lastLines = lines.slice(-10).reverse();
        const events = [];

        for (const line of lastLines) {
          try {
            events.push(JSON.parse(line));
          } catch (e) {
            console.warn("Bad JSON line in events.jsonl:", line);
          }
        }

        renderEvents(events);
      } catch (err) {
        console.error("Error loading events:", err);
        const feed = document.getElementById("feed");
        feed.innerHTML =
          '<div class="feed-empty">Could not load events (check CORS / network).</div>';
      }
    }

    function formatTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      return d.toLocaleString(undefined, {
        hour: "2-digit",
        minute: "2-digit",
        day: "2-digit",
        month: "2-digit"
      });
    }

    function renderStatus(status) {
      // Basiswerte aus status.json
      const autonomy       = status.autonomy_level  ?? 50.1;
      const autonomyTarget = status.autonomy_target ?? 60;
      const agentsOnline   = status.agents_online   ?? 4;
      const agentsTotal    = status.agents_total    ?? 7;
      const workflows      = status.workflows       ?? 17;
      const lastUpdate     = status.last_update     || null;

      // NEU: Health Score + System Mode
      const healthScore = (status.health_score !== undefined && status.health_score !== null)
        ? Number(status.health_score)
        : null;

      const systemMode =
        status.system_mode   ||
        status.system_status ||
        status.system_health ||
        "DEVELOPING";

      // Liste der aktiven Agenten
      const onlineAgentsList = Array.isArray(status.agents_online_list)
        ? status.agents_online_list
        : ["guardian", "self_guardian", "monitoring", "self_content"];
  
      // --- KPIs ---

      // Autonomy
      const autoEl      = document.getElementById("kpi-autonomy");
      const autoNoteEl  = document.getElementById("kpi-autonomy-note");
      if (autoEl && autoNoteEl) {
        autoEl.textContent     = `≈ ${autonomy.toFixed(1)}%`;
        autoNoteEl.textContent = `Target: ${autonomyTarget}% autonomy in 7–14 days`;
      }

      // Agents
      const agentsEl     = document.getElementById("kpi-agents");
      const agentsNoteEl = document.getElementById("kpi-agents-note");
      if (agentsEl && agentsNoteEl) {
        agentsEl.textContent = `${agentsOnline} / ${agentsTotal}`;
        agentsNoteEl.textContent = onlineAgentsList
          .map(a => niceAgentName(a))
          .join(" · ");
      }

      // Workflows
      const wfEl     = document.getElementById("kpi-workflows");
      const wfNoteEl = document.getElementById("kpi-workflows-note");
      if (wfEl && wfNoteEl) {
        wfEl.textContent     = String(workflows);
        wfNoteEl.textContent = "Industrial-grade CI/CD workflows online";
      }

      // Last Update (wird ggf. von den Events später überschrieben)
      const lastUpdEl = document.getElementById("kpi-last-update");
      if (lastUpdEl && lastUpdate) {
        lastUpdEl.textContent = formatTime(lastUpdate);
      }

      // Health Score
      const healthValEl  = document.getElementById("kpi-health-value");
      const healthNoteEl = document.getElementById("kpi-health-note");

      if (healthValEl && healthNoteEl) {
        if (healthScore !== null && !Number.isNaN(healthScore)) {
          healthValEl.textContent = `${healthScore.toFixed(1)}%`;
        } else {
          healthValEl.textContent = "–";
        }

        const modeText = systemMode.toString().replace(/_/g, " ").toLowerCase();
        healthNoteEl.textContent = `System mode: ${modeText}`;
      }

      // --- Badges oben ---
      const badgeAutoEl   = document.getElementById("badge-autonomy");
      const badgeAgentsEl = document.getElementById("badge-agents");

      if (badgeAutoEl) {
        badgeAutoEl.textContent = `Autonomy ≈ ${autonomy.toFixed(1)}%`;
      }
      if (badgeAgentsEl) {
        badgeAgentsEl.textContent = `${agentsOnline} / ${agentsTotal} core agents live`;
      }
    }

    function niceAgentName(id) {
      const map = {
        guardian: "Guardian",
        self_guardian: "Self-Guardian",
        monitoring: "Monitoring",
        self_monitoring: "Monitoring",
        self_content: "Self-Content",
        audit: "Audit Agent",
        deploy: "Deploy Agent",
        content: "Content Agent",
        george: "GEORGE Orchestrator",
        george_orchestrator: "GEORGE Orchestrator"
      };
      return map[id] || id.replace(/[_-]+/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    }

    function renderEvents(events) {
      const feed = document.getElementById("feed");

      if (!events.length) {
        feed.innerHTML =
          '<div class="feed-empty">No recent events recorded yet.</div>';
        // letzte Event-Zeit auch als Last Update nutzen
        return;
      }

      // Last Update aus dem neuesten Event
      const latestTs = events[0].timestamp;
      if (latestTs) {
        document.getElementById("kpi-last-update").textContent = formatTime(latestTs);
      }

      feed.innerHTML = "";
      for (const ev of events) {
        const agent = (ev.agent || "system").toString();
        const evt = (ev.event || "event").toString();
        const msg =
          ev.message ||
          ev.details ||
          ev.status ||
          "(no details provided)";
        const intent =
          ev.intent ||
          `${agent} · ${evt}`.replace(/\s+/g, " ");

        const agentKey = agent.toLowerCase().replace(/[^a-z0-9]+/g, "-");
        const isGeorge =
          agentKey === "george" ||
          agentKey === "george-orchestrator" ||
          (ev.source_agent &&
            ev.source_agent.toString().toLowerCase().includes("george"));

        const item = document.createElement("article");
        item.className = "feed-item" + (isGeorge ? " feed-item-george" : "");

        const ts = formatTime(ev.timestamp);

        const tagClasses = ["feed-tag", `tag-${agentKey}`];

        item.innerHTML = `
          <div class="feed-top-row">
            <div class="feed-tags">
              <span class="${tagClasses.join(" ")}">
                ${niceAgentName(agentKey)}
                ${isGeorge ? " ⚡" : ""}
              </span>
              <span class="feed-tag">${evt}</span>
              ${
                ev.rule_id
                  ? `<span class="feed-tag">rule: ${ev.rule_id}</span>`
                  : ""
              }
            </div>
            <div class="feed-time">${ts}</div>
          </div>
          <div class="feed-title">${intent}</div>
          <div class="feed-message">${msg}</div>
        `;

        feed.appendChild(item);
      }
    }

    // Initial Ladezyklen
    fetchStatus();
    fetchEvents();

    // Regelmäßig aktualisieren
    setInterval(fetchStatus, 60000);  // alle 60s Status
    setInterval(fetchEvents, 30000);  // alle 30s Events
  </script>
</body>
</html>


